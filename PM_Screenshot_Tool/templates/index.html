<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tea-ai PM Lab</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* È°µÈù¢ÁâπÂÆöÊ†∑ÂºèË¶ÜÁõñ */
        body { overflow: hidden; }
        
        /* Layout */
        .app { display: flex; height: 100vh; }
        .sidebar { width: 240px; background: #111111; border-right: 1px solid rgba(255,255,255,0.06); display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #0a0a0a; }
        
        /* Sidebar - Linear Style */
        .sidebar-header { height: 60px; padding: 0 20px; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; }
        .logo { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #fff; letter-spacing: -0.01em; }
        .sidebar-section { padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .sidebar-section h3 { font-size: 12px; color: #6b7280; margin-bottom: 12px; letter-spacing: 0.02em; font-weight: 500; display: flex; align-items: baseline; gap: 8px; }
        .sidebar-section h3 span { font-size: 11px; opacity: 0.5; font-weight: 400; }
        
        /* Navigation List - Linear Style */
        .nav-list { display: flex; flex-direction: column; gap: 0; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-radius: 0;
            cursor: pointer;
            color: #6b7280;
            text-decoration: none;
            transition: all 0.15s ease;
            font-size: 14px;
            border: none;
            border-left: 2px solid transparent;
            margin-left: -16px;
            padding-left: 14px;
            background: none;
        }
        .nav-item:hover {
            color: #fff;
            background: rgba(255,255,255,0.02);
        }
        .nav-item.active {
            color: #fff;
            border-left-color: #fff;
            background: rgba(255,255,255,0.03);
        }
        .nav-item .icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; opacity: 0.7; }
        .nav-item.active .icon { opacity: 1; }
        .nav-item .icon svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.5; display: block; }
        .nav-item .nav-en { opacity: 0.5; font-size: 12px; margin-left: 2px; }
        
        /* Project List - Linear Style */
        .project-list { display: flex; flex-direction: column; gap: 2px; flex: 1; overflow-y: auto; }
        .project-item { 
            display: flex; align-items: center; gap: 10px; padding: 10px 12px; 
            border-radius: 0; cursor: pointer; 
            transition: all 0.15s;
            border-left: 2px solid transparent;
            margin-left: -16px;
            padding-left: 28px;
        }
        .project-item:hover { 
            background: rgba(255,255,255,0.04);
            color: #fff;
        }
        .project-item.active { 
            border-left-color: #fff;
            background: rgba(255,255,255,0.06);
        }
        .project-item.active:hover {
            background: rgba(255,255,255,0.08);
        }
        .project-item .project-logo,
        .project-item .project-icon { 
            width: 24px; height: 24px; border-radius: 6px; 
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; color: #fff;
            flex-shrink: 0;
            overflow: hidden;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .project-item .project-logo img,
        .project-item .project-icon img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .project-item .project-info { flex: 1; min-width: 0; }
        .project-item .name { font-size: 14px; font-weight: 400; color: #6b7280; transition: color 0.15s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .project-item.active .name { color: #fff; }
        .project-item .count { 
            font-size: 12px; 
            color: #6b7280; 
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            min-width: 24px;
            text-align: right;
        }
        
        /* Canvas Mode Selector - Linear Style */
        .mode-selector { display: flex; flex-direction: column; gap: 0; }
        .mode-btn { 
            display: flex; align-items: center; gap: 12px; padding: 10px 0; 
            border-radius: 0; cursor: pointer; border: none; border-left: 2px solid transparent;
            margin-left: -16px; padding-left: 14px;
            background: none; color: #6b7280; text-align: left; font-size: 14px; 
            transition: all 0.15s ease;
            font-weight: 400;
        }
        .mode-btn:hover { 
            color: #fff;
            background: rgba(255,255,255,0.02);
        }
        .mode-btn.active { 
            color: #fff;
            border-left-color: #fff;
            background: rgba(255,255,255,0.03);
        }
        .mode-btn .mode-icon { 
            width: 20px; height: 20px; 
            display: flex; align-items: center; justify-content: center;
            opacity: 0.7;
        }
        .mode-btn.active .mode-icon { opacity: 1; }
        .mode-btn .mode-icon svg {
            width: 18px; height: 18px;
            stroke: currentColor; fill: none; stroke-width: 1.5;
        }
        .mode-btn .nav-en {
            font-size: 12px;
            opacity: 0.5;
            margin-left: 2px;
        }
        
        /* Top Bar - Linear Style */
        .topbar { 
            height: 60px; background: #111111; 
            border-bottom: 1px solid rgba(255,255,255,0.06); 
            display: flex; align-items: center; padding: 0 24px; gap: 16px; 
        }
        .topbar-title { font-size: 15px; font-weight: 500; color: #fff; letter-spacing: -0.01em; }
        .topbar-actions { margin-left: auto; display: flex; gap: 8px; }
        
        /* Buttons - Linear Style */
        .btn { 
            padding: 10px 16px; border-radius: 8px; 
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent; color: #a1a1a1;
            cursor: pointer; font-size: 13px; font-weight: 500;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn:hover { 
            background: rgba(255,255,255,0.04); 
            color: #fff; 
            border-color: rgba(255,255,255,0.2);
        }
        .btn-primary { 
            background: #fff; 
            color: #000; 
            border: none;
        }
        .btn-primary:hover { 
            background: #e5e5e5; 
            color: #000;
        }
        .btn-secondary { 
            background: transparent; 
            color: #a1a1a1; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-secondary:hover { 
            background: rgba(255,255,255,0.04); 
            color: #fff;
            border-color: rgba(255,255,255,0.2);
        }
        .btn-export {
            background: #fff;
            color: #000;
            border: none;
        }
        .btn-export:hover {
            background: #e5e5e5;
            color: #000;
        }
        .btn-ghost { 
            background: transparent; 
            color: #6b7280; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-ghost:hover { 
            color: #fff; 
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.2);
        }
        .btn-ghost.active { 
            color: #fff; 
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.15);
        }
        #size-switcher { 
            display: flex; gap: 4px; align-items: center; 
        }
        
        /* ÂèåËØ≠ÊñáÊ°àÈÄöÁî®Ê†∑ÂºèÂ¢ûÂº∫ */
        .mode-btn, .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .sidebar-section h3 {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        
        .modal-content h3 {
            display: flex;
            align-items: baseline;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .form-group label {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }
        
        /* Canvas Container */
        .canvas-container { flex: 1; overflow: hidden; position: relative; }
        
        /* ==================== Ê≥≥ÈÅìÂõæÊ†∑Âºè - Linear Style ==================== */
        .swimlane-view { width: 100%; height: 100%; overflow: auto; padding: 24px; background: #0a0a0a; }
        .swimlane-table { border-collapse: separate; border-spacing: 0; }
        .swimlane-table th, .swimlane-table td { 
            border: 1px solid rgba(255,255,255,0.06); 
            padding: 12px; vertical-align: middle; 
        }
        .swimlane-table th { 
            background: #111111; position: sticky; top: 0; z-index: 10; 
            font-size: 13px; letter-spacing: 0.02em; color: #fff; 
            min-width: 200px; text-align: center; font-weight: 600;
        }
        .swimlane-table th:first-child { left: 0; z-index: 20; min-width: 100px; text-align: left; }
        .swimlane-table td:first-child { 
            background: #111111; position: sticky; left: 0; z-index: 5; 
            font-weight: 600; min-width: 100px; color: #e1e1e1;
        }
        .swimlane-cell { 
            display: flex; gap: 6px; flex-wrap: nowrap; overflow-x: auto; 
            padding: 4px 0; min-height: 80px; align-items: center; 
        }
        .swimlane-thumb { 
            flex: 0 0 55px; cursor: pointer; border-radius: 6px; overflow: hidden; 
            transition: all 0.2s; 
            background: #111111; 
            border: 1px solid rgba(255,255,255,0.06);
        }
        .swimlane-thumb:hover { 
            transform: scale(1.15); z-index: 100; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.2);
        }
        .swimlane-thumb img { width: 100%; display: block; }
        .product-label { display: flex; align-items: center; gap: 8px; justify-content: center; white-space: nowrap; }
        .product-color { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
        .step-badge { 
            position: absolute; top: 2px; left: 2px; 
            background: rgba(255,255,255,0.9); 
            color: #000; font-size: 10px; padding: 2px 5px; 
            border-radius: 4px; font-weight: 700; 
        }
        
        /* ==================== Ëá™Áî±ÁîªÂ∏ÉÊ†∑Âºè - Linear Style ==================== */
        .freeform-view { 
            width: 100%; height: 100%; overflow: hidden; position: relative; 
            background: #0a0a0a; 
            background-image: radial-gradient(rgba(255,255,255,0.08) 1px, transparent 1px); 
            background-size: 24px 24px; 
        }
        .canvas-inner { position: absolute; transform-origin: 0 0; }
        .canvas-node { position: absolute; cursor: grab; user-select: none; }
        .canvas-node:active { cursor: grabbing; }
        .canvas-node img { 
            width: 120px; border-radius: 8px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.5); 
            transition: all 0.2s; 
            pointer-events: none;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .canvas-node:hover img { 
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
            border-color: rgba(255,255,255,0.15);
        }
        .canvas-node.selected { outline: 2px solid #fff; outline-offset: 4px; }
        .canvas-node .node-label { 
            font-size: 10px; color: #6b7280; text-align: center; margin-top: 6px; 
            max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; 
        }
        
        /* Canvas Controls - Linear Style */
        .canvas-controls { 
            position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 4px; background: #111111; padding: 8px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.06);
        }
        .canvas-controls button { 
            width: 36px; height: 36px; border: none; background: none; 
            color: #a1a1a1; cursor: pointer; border-radius: 8px; font-size: 18px; 
            transition: all 0.2s;
        }
        .canvas-controls button:hover { 
            background: rgba(255,255,255,0.04); 
            color: #fff;
        }
        .zoom-level { 
            color: #6b7280; font-size: 12px; padding: 0 12px; 
            display: flex; align-items: center; 
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        
        /* ==================== ÊµÅÁ®ãÂõæÊ†∑Âºè - Linear Style ==================== */
        .flowchart-view { 
            width: 100%; height: 100%; overflow: hidden; position: relative; 
            background: #0a0a0a; 
        }
        .flow-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .flow-svg path { 
            stroke: rgba(255,255,255,0.3); 
            stroke-width: 2; fill: none; marker-end: url(#arrowhead); 
        }
        .flow-node { position: absolute; cursor: pointer; }
        .flow-node img { 
            width: 100px; border-radius: 8px; 
            box-shadow: 0 2px 12px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.06);
        }
        .flow-node.connecting { outline: 2px dashed #fff; outline-offset: 4px; }
        .connect-dot { 
            position: absolute; width: 12px; height: 12px; 
            background: #fff; 
            border-radius: 50%; cursor: crosshair; opacity: 0; 
            transition: opacity 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .flow-node:hover .connect-dot { opacity: 1; }
        .connect-dot.top { top: -6px; left: 50%; transform: translateX(-50%); }
        .connect-dot.bottom { bottom: -6px; left: 50%; transform: translateX(-50%); }
        .connect-dot.left { left: -6px; top: 50%; transform: translateY(-50%); }
        .connect-dot.right { right: -6px; top: 50%; transform: translateY(-50%); }
        
        /* Empty State - Linear Style */
        .empty-state { 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100%; color: #4b5563; 
        }
        .empty-state .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.3; }
        .empty-state p { font-size: 14px; color: #6b7280; line-height: 1.8; text-align: center; }
        
        /* Modal - Linear Style */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); 
            align-items: center; justify-content: center; z-index: 1000; 
            backdrop-filter: blur(8px);
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: #111111; padding: 32px; border-radius: 12px; 
            min-width: 400px; max-width: 500px; 
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-content h3 { 
            margin-bottom: 20px; font-size: 18px; color: #fff; 
            font-weight: 600; letter-spacing: -0.01em;
        }
        .modal-close { 
            position: absolute; top: 20px; right: 20px; font-size: 32px; 
            color: #6b7280; background: none; border: none; cursor: pointer; 
            transition: color 0.2s;
        }
        .modal-close:hover { color: #fff; }
        
        /* Preview Modal - Linear Style */
        .preview-modal img { 
            max-width: 90vw; max-height: 90vh; border-radius: 8px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        .preview-info { 
            position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); 
            background: rgba(17, 17, 17, 0.95); 
            padding: 10px 24px; border-radius: 24px; font-size: 13px; 
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
        }
        .preview-nav { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            font-size: 48px; color: #a1a1a1; 
            background: rgba(17, 17, 17, 0.8); 
            border: 1px solid rgba(255,255,255,0.1); 
            width: 60px; height: 60px; border-radius: 50%; cursor: pointer; 
            transition: all 0.2s;
            backdrop-filter: blur(8px);
        }
        .preview-nav:hover { 
            background: rgba(255,255,255,0.04); 
            border-color: rgba(255,255,255,0.2);
            color: #fff;
        }
        .preview-nav.prev { left: 24px; }
        .preview-nav.next { right: 24px; }
        
        /* Form - Linear Style */
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; margin-bottom: 8px; font-size: 13px; 
            color: #9ca3af; font-weight: 500; 
        }
        .form-input { 
            width: 100%; padding: 12px 14px; 
            background: rgba(255, 255, 255, 0.04); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 8px; color: #e1e1e1; font-size: 14px; 
            transition: all 0.2s;
        }
        .form-input:focus { 
            outline: none; 
            border-color: rgba(255,255,255,0.3); 
            background: rgba(255, 255, 255, 0.06);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.05);
        }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        
        /* Toast - Linear Style */
        .toast { 
            position: fixed; bottom: 24px; right: 24px; 
            background: #111111; color: #e1e1e1; 
            padding: 14px 24px; border-radius: 8px; display: none; z-index: 2000; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(12px);
        }
        .toast.show { display: block; animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* È™®Êû∂Â±èÈó™ÁÉÅÂä®Áîª */
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* LoadingËÑâÂÜ≤Âä®Áîª */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        /* Âø´ÈÄüËøáÊ∏° */
        .fast-transition {
            transition: all 0.15s ease-out !important;
        }
        
        /* ÂõæÁâáÊ∏êÊòæÂä®Áîª */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Âç°ÁâáÂÖ•Âú∫Âä®Áîª */
        @keyframes cardEnter {
            from { 
                opacity: 0; 
                transform: translateY(8px) scale(0.98); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        /* ËßÜÂõæÂàáÊç¢Ê∑°ÂÖ• */
        @keyframes viewFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes contentSwitch {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .grid-view {
            animation: viewFadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #standard-view, #large-view {
            transition: opacity 0.2s ease-out;
            opacity: 1;
        }
        
        #standard-view.switching, #large-view.switching {
            opacity: 0;
        }
        
        /* ÂõæÁâáÂä†ËΩΩÂÆåÊàêÊ∏êÊòæ */
        .card-compact img.loaded,
        .card-standard img.loaded,
        .card-detailed img.loaded {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* will-change‰ºòÂåñ */
        .project-item,
        .mode-btn,
        .card-compact,
        .card-standard,
        .card-detailed,
        .card-large {
            will-change: transform;
        }
        
        /* Screenshot Library Panel - Linear Style */
        .library-panel { 
            position: absolute; right: 0; top: 0; width: 280px; height: 100%; 
            background: #111111; 
            border-left: 1px solid rgba(255,255,255,0.06); 
            display: none; flex-direction: column; z-index: 50; 
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }
        .library-panel.active { display: flex; }
        .library-header { 
            padding: 16px; 
            border-bottom: 1px solid rgba(255,255,255,0.06); 
            display: flex; align-items: center; justify-content: space-between; 
        }
        .library-header h3 { font-size: 14px; font-weight: 600; color: #fff; }
        .library-close { 
            background: none; border: none; color: #6b7280; 
            font-size: 20px; cursor: pointer; 
            transition: color 0.2s;
        }
        .library-close:hover { color: #fff; }
        .library-content { flex: 1; overflow-y: auto; padding: 12px; }
        .library-phase { margin-bottom: 16px; }
        .library-phase-header { 
            display: flex; align-items: center; gap: 8px; padding: 8px 10px; 
            background: rgba(255,255,255,0.04); 
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px; cursor: pointer; margin-bottom: 8px; 
            transition: all 0.2s;
        }
        .library-phase-header:hover { 
            background: rgba(255,255,255,0.06); 
            border-color: rgba(255,255,255,0.1);
        }
        .library-phase-title { flex: 1; font-size: 13px; font-weight: 500; color: #e1e1e1; }
        .library-phase-count { 
            font-size: 10px; color: #6b7280; 
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        .library-phase-add { 
            background: #fff; 
            color: #000; border: none; padding: 5px 10px; 
            border-radius: 4px; font-size: 11px; cursor: pointer; 
            font-weight: 600;
            transition: all 0.2s;
        }
        .library-phase-add:hover { 
            background: #e5e5e5;
        }
        .library-thumbs { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .library-thumb { 
            border-radius: 4px; overflow: hidden; cursor: grab; 
            background: #111111; aspect-ratio: 9/16; 
            border: 1px solid rgba(255,255,255,0.06);
            transition: all 0.2s;
        }
        .library-thumb:hover { 
            outline: 2px solid rgba(255,255,255,0.3); 
            outline-offset: 2px;
        }
        .library-thumb img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .library-thumb.dragging { opacity: 0.5; }
        
        /* Canvas Empty Hint - Linear Style */
        .canvas-hint { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); text-align: center; 
            color: #4b5563; pointer-events: none; 
        }
        .canvas-hint .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
        .canvas-hint p { font-size: 13px; color: #6b7280; }
        
        /* Toggle Library Button */
        .toggle-library-btn { position: absolute; right: 16px; top: 16px; z-index: 40; }
        
        /* Scrollbar - Linear Style */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
        
        /* ==================== Ê†áÁ≠æÁ≥ªÁªüÊ†∑Âºè - Linear Style ==================== */
        .tag-filter-bar { 
            display: flex; align-items: center; gap: 8px; padding: 12px 24px; 
            background: #111111; 
            border-bottom: 1px solid rgba(255,255,255,0.06); 
            flex-wrap: wrap; 
        }
        .tag-filter-bar .label { font-size: 12px; color: #6b7280; margin-right: 8px; font-weight: 500; }
        .tag-chip { 
            display: inline-flex; align-items: center; gap: 4px; padding: 5px 12px; 
            background: rgba(255,255,255,0.06); 
            color: #a1a1a1; border-radius: 6px; font-size: 12px; cursor: pointer; 
            transition: all 0.2s; 
            border: 1px solid rgba(255,255,255,0.1);
            font-weight: 500;
        }
        .tag-chip:hover { 
            background: rgba(255,255,255,0.08); 
            border-color: rgba(255,255,255,0.15);
            color: #fff;
        }
        .tag-chip.active { 
            background: #fff; 
            color: #000; 
            border-color: transparent;
        }
        .tag-chip .remove { margin-left: 4px; opacity: 0.7; }
        .tag-chip .remove:hover { opacity: 1; }
        .tag-add-btn { 
            padding: 6px 14px; background: rgba(255,255,255,0.04); 
            color: #9ca3af; border-radius: 6px; font-size: 12px; 
            cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
            font-weight: 500;
            transition: all 0.2s;
        }
        .tag-add-btn:hover { 
            background: rgba(255,255,255,0.06); 
            color: #fff;
            border-color: rgba(255,255,255,0.15);
        }
        
        /* Ê†áÁ≠æÈÄâÊã©Âô®Modal - Linear Style */
        .tag-selector { max-height: 400px; overflow-y: auto; }
        .tag-category { margin-bottom: 20px; }
        .tag-category-title { 
            font-size: 11px; color: #6b7280; margin-bottom: 10px; 
            text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; 
        }
        .tag-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-option { 
            padding: 7px 14px; background: rgba(255,255,255,0.04); 
            border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; 
            font-size: 13px; cursor: pointer; 
            transition: all 0.2s;
            font-weight: 500;
        }
        .tag-option:hover { 
            background: rgba(255,255,255,0.08); 
            border-color: rgba(255,255,255,0.15); 
        }
        .tag-option.selected { 
            background: #fff; 
            border-color: transparent; 
            color: #000; 
        }
        .custom-tag-input { 
            display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; 
            border-top: 1px solid rgba(255,255,255,0.06); 
        }
        .custom-tag-input input { flex: 1; }
        
        /* Áº©Áï•Âõæ‰∏äÁöÑÊ†áÁ≠æÊòæÁ§∫ */
        .swimlane-thumb { position: relative; }
        .thumb-tags { position: absolute; bottom: 2px; left: 2px; right: 2px; display: flex; flex-wrap: wrap; gap: 2px; }
        .thumb-tag { font-size: 8px; padding: 1px 4px; background: rgba(102,126,234,0.9); color: #fff; border-radius: 3px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* Storyboard ‰∏ìÁî®Ê†∑Âºè */
        .storyboard-thumb { 
            flex: 0 0 100px; 
            cursor: pointer; 
            border-radius: 8px; 
            overflow: hidden; 
            transition: transform 0.2s, box-shadow 0.2s; 
            background: #2a2a4a; 
            position: relative;
        }
        .storyboard-thumb:hover { 
            transform: scale(1.08); 
            z-index: 100; 
            box-shadow: 0 8px 30px rgba(102,126,234,0.5); 
        }
        .storyboard-thumb img { width: 100%; display: block; }
        .storyboard-label { 
            font-size: 9px; 
            color: #999; 
            padding: 4px 6px; 
            background: rgba(0,0,0,0.6); 
            text-align: center; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        /* ==================== 3ÁßçÂç°ÁâáËßÜÂõæÊ†∑Âºè ==================== */
        
        /* ÈÄöÁî®ÁΩëÊ†ºËßÜÂõæÂÆπÂô® */
        .grid-view { 
            width: 100%; height: 100%; overflow: auto; padding: 20px 24px; 
            display: flex; flex-wrap: wrap; gap: 16px; align-content: flex-start;
        }
        .grid-view-header {
            width: 100%; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06); margin-bottom: 12px;
            font-size: 14px; color: #9ca3af; display: flex; align-items: center; gap: 12px;
        }
        .phase-group { width: 100%; margin-bottom: 28px; }
        .phase-group-title { 
            font-size: 15px; color: #fff; margin-bottom: 16px; padding-bottom: 12px; 
            border-bottom: 1px solid rgba(255,255,255,0.06); 
            display: flex; align-items: center; gap: 10px;
        }
        .phase-group-title .phase-icon { font-size: 18px; }
        .phase-group-title .phase-name { font-weight: 600; letter-spacing: -0.01em; }
        .phase-group-title .phase-name-en { color: #6b7280; font-weight: 400; margin-left: 6px; font-size: 13px; }
        .phase-group-title .phase-desc { 
            font-size: 11px; color: rgba(156, 163, 175, 0.6); margin-left: 12px;
            max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .phase-group-title .phase-count { 
            font-size: 11px; color: #6b7280; margin-left: auto; 
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
        }
        .phase-group-cards { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        
        /* Style A: Á¥ßÂáëÂûã (Compact) - 60pxÂÆΩ */
        .card-compact {
            width: 60px; cursor: pointer; border-radius: 6px; overflow: hidden;
            background: #111111; 
            transition: all 0.2s; 
            position: relative;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .card-compact:hover { 
            transform: scale(1.1); z-index: 100; 
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.15);
        }
        .card-compact.previewing {
            transform: scale(1.1);
            z-index: 99;
            box-shadow: 0 0 0 2px #fff, 0 4px 16px rgba(0,0,0,0.5);
            border-color: #fff;
            position: relative;
        }
        .card-compact.previewing::after {
            content: 'üëÅÔ∏è';
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 12px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .card-compact img { 
            width: 100%; display: block; 
            /* È™®Êû∂Â±èÊïàÊûú */
            background: linear-gradient(90deg, #1a1a1a 25%, #252525 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            min-height: 80px;
        }
        .card-compact img[src]:not([src=""]):not([src^="data:"]) { 
            animation: none; 
            background: #0a0a0a; 
        }
        .card-compact img.loaded { animation: none; background: #0a0a0a; }
        .card-compact .card-phase { 
            position: absolute; top: 2px; left: 2px; font-size: 7px; padding: 2px 5px; 
            background: rgba(0, 0, 0, 0.7); 
            color: #fff; border-radius: 3px; font-weight: 600;
            backdrop-filter: blur(4px);
        }
        .card-compact .card-desc { 
            position: absolute; bottom: 0; left: 0; right: 0; font-size: 7px; 
            padding: 3px 4px; background: rgba(0,0,0,0.8); color: #d1d5db; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        /* Style B: Ê†áÂáÜÂûã (Standard) - 100pxÂÆΩ - Linear Style */
        .card-standard {
            width: 100px; cursor: pointer; border-radius: 8px; overflow: hidden;
            background: #111111; 
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .card-standard:hover { 
            transform: scale(1.05); z-index: 100; 
            box-shadow: 0 6px 24px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.15);
        }
        .card-standard.previewing {
            transform: scale(1.05);
            z-index: 99;
            box-shadow: 0 0 0 3px #fff, 0 6px 24px rgba(0,0,0,0.5);
            border-color: #fff;
            position: relative;
        }
        .card-standard.previewing::after {
            content: 'üëÅÔ∏è';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 16px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }
        .card-standard .card-phase-bar {
            font-size: 9px; padding: 5px 8px; 
            background: rgba(255,255,255,0.08);
            color: #a1a1a1; text-align: center; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; font-weight: 600;
        }
        .card-standard img { 
            width: 100%; display: block; 
            /* È™®Êû∂Â±èÊïàÊûú */
            background: linear-gradient(90deg, #1a1a1a 25%, #252525 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            min-height: 120px;
        }
        .card-standard img[src]:not([src=""]):not([src^="data:"]) { animation: none; background: #0a0a0a; }
        .card-standard img.loaded { animation: none; background: #0a0a0a; }
        .card-standard .card-info {
            padding: 8px; background: #161616;
        }
        .card-standard .card-desc { 
            font-size: 10px; 
            color: #d1d5db; 
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-width: 100%;
        }
        .card-standard .card-desc-short {
            font-size: 10px;
            color: #9ca3af;
            line-height: 1.3;
            margin-top: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Style C: ËØ¶ÊÉÖÂûã (Detailed) - 140pxÂÆΩ - Linear Style */
        .card-detailed {
            width: 140px; cursor: pointer; border-radius: 8px; overflow: hidden;
            background: #111111; 
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        .card-detailed:hover { 
            transform: translateY(-2px); z-index: 100; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.5); 
            border-color: rgba(255,255,255,0.15); 
        }
        .card-detailed .card-header {
            display: flex; align-items: center; gap: 6px; padding: 8px; background: #0a0a0a;
        }
        .card-detailed .card-num {
            font-size: 11px; 
            color: #fff;
            font-weight: 700; min-width: 20px;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        .card-detailed .card-phase-tag {
            font-size: 9px; padding: 3px 8px; 
            background: rgba(0, 0, 0, 0.4); 
            color: #d1d5db;
            border-radius: 4px; white-space: nowrap; 
            overflow: hidden; text-overflow: ellipsis; flex: 1;
            font-weight: 500;
        }
        .card-detailed img { 
            width: 100%; display: block; 
            background: linear-gradient(90deg, #1a1a1a 25%, #252525 50%, #1a1a1a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            min-height: 150px;
        }
        .card-detailed img[src]:not([src=""]):not([src^="data:"]) { animation: none; background: #0a0a0a; }
        .card-detailed img.loaded { animation: none; background: #0a0a0a; }
        .card-detailed .card-info {
            padding: 10px; background: #161616;
        }
        .card-detailed .card-desc { 
            font-size: 11px; color: #d1d5db; line-height: 1.5;
        }
        .card-detailed .card-tags {
            margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;
        }
        .card-detailed .card-tag {
            font-size: 9px; padding: 3px 6px; 
            background: rgba(255,255,255,0.08); 
            color: #9ca3af;
            border-radius: 3px;
        }
        
        /* Style D: ËØ¶ÊÉÖÊ®°Âºè */
        #large-view {
            background: #0d0d0d;
        }
        .large-product-section {
            width: 100%; margin-bottom: 64px;
        }
        .large-product-header {
            display: flex; align-items: baseline; gap: 20px; margin-bottom: 48px;
            padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .large-product-name {
            font-size: 28px; font-weight: 400; color: #ffffff; letter-spacing: -0.02em;
        }
        .large-product-count {
            font-size: 13px; color: #6b7280; font-weight: 400; letter-spacing: 0.05em;
        }
        .large-phase-cards {
            display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;
        }
        .card-large {
            width: 480px; cursor: pointer; overflow: hidden;
            background: #161616; 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05); 
            display: flex; flex-direction: row;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .card-large:hover { 
            background: #1a1a1a; 
            border-color: rgba(255,255,255,0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        .card-large.previewing {
            background: #1a1a1a;
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2), 0 12px 32px rgba(0,0,0,0.3);
            position: relative;
        }
        .card-large.previewing::before {
            content: 'È¢ÑËßà‰∏≠';
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 5px 12px;
            background: rgba(255,255,255,0.9);
            color: #000;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            z-index: 10;
            backdrop-filter: blur(4px);
        }
        .card-large .card-image {
            flex: 0 0 180px; 
            background: #0f0f0f; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            padding: 12px;
            overflow: hidden;
        }
        .card-large .card-image img { 
            width: 100%; height: auto; display: block; 
            border-radius: 8px;
            background: linear-gradient(90deg, #1a1a2e 25%, #252540 50%, #1a1a2e 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .card-large .card-image img[src]:not([src=""]):not([src^="data:"]) { animation: none; background: #0a0a0a; }
        .card-large .card-content {
            flex: 1; 
            padding: 16px 18px; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start;
            gap: 8px;
        }
        .card-large .card-num {
            font-size: 14px; 
            color: #6b7280;
            font-weight: 600; 
            letter-spacing: 0.02em;
            line-height: 1;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        .card-large .card-naming {
            font-size: 15px !important;
            color: #e2e8f0 !important;
            font-weight: 600 !important;
            margin: 4px 0 8px 0 !important;
            line-height: 1.4;
        }
        .card-large .card-naming-en {
            color: #6b7280;
            font-weight: 400;
            margin-left: 6px;
        }
        .card-large .card-desc { 
            font-size: 13px; 
            color: #9ca3af; 
            line-height: 1.55; 
            font-weight: 400;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-large .card-highlights {
            font-size: 12px !important;
            color: #9ca3af !important;
            margin-top: 8px !important;
            line-height: 1.5;
            padding-left: 2px;
        }
        .card-large .card-highlights div {
            margin-bottom: 3px;
            opacity: 0.85;
        }
        .card-large .card-filename {
            font-size: 11px; 
            color: #4b5563; 
            margin-top: auto;
            padding-top: 10px;
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            letter-spacing: 0.01em;
        }
        
        /* Èò∂ÊÆµÂå∫ÂùóÂÆπÂô® */
        .phase-section {
            width: 100%;
            margin-bottom: 40px;
        }
        /* Èò∂ÊÆµÂàÜÈöîÂå∫Âùó - Áé∞‰ª£ÁÆÄÊ¥ÅÈ£éÊ†º */
        .phase-divider {
            display: flex; 
            align-items: center; 
            gap: 12px;
            margin: 32px 0 20px 0; 
            padding-bottom: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .phase-divider:first-child {
            margin-top: 0;
        }
        .phase-divider-icon {
            font-size: 18px;
            line-height: 1;
        }
        .phase-divider-name {
            font-size: 15px; 
            color: #e5e7eb;
            font-weight: 500;
            letter-spacing: -0.01em;
        }
        .phase-divider-name-en {
            font-size: 13px;
            color: #6b7280;
            font-weight: 400;
            margin-left: 6px;
        }
        .phase-divider-count {
            margin-left: auto;
            font-size: 12px; 
            color: #9ca3af;
            font-weight: 500;
            background: rgba(255,255,255,0.08);
            padding: 4px 10px;
            border-radius: 4px;
        }
        .phase-divider-count::after {
            content: ' screens';
            font-size: 11px;
            color: #6b7280;
        }
        .phase-divider-line {
            flex: 1; height: 1px; 
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.15) 0%, 
                rgba(255,255,255,0) 100%
            );
            margin-left: 12px;
        }
        
        /* Âø´ÈÄüÊ†áÊ≥®Ê®°Âºè - Linear Style */
        .quick-tag-view { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #0a0a0a; z-index: 500; display: none; flex-direction: column; 
        }
        .quick-tag-view.active { display: flex; }
        .quick-tag-header { 
            padding: 16px 24px; background: #111111; 
            border-bottom: 1px solid rgba(255,255,255,0.06); 
            display: flex; align-items: center; justify-content: space-between; 
        }
        .quick-tag-progress { 
            font-size: 14px; color: #6b7280; 
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        .quick-tag-main { 
            flex: 1; display: flex; align-items: center; justify-content: center; 
            padding: 24px; gap: 48px; 
        }
        .quick-tag-image { 
            max-width: 400px; max-height: 70vh; border-radius: 8px; 
            box-shadow: 0 8px 40px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.06);
        }
        .quick-tag-panel { width: 300px; }
        .quick-tag-section { margin-bottom: 24px; }
        .quick-tag-section h4 { 
            font-size: 11px; color: #6b7280; margin-bottom: 10px; 
            text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; 
        }
        .quick-tag-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .quick-tag-btn { 
            padding: 9px 16px; background: rgba(255,255,255,0.04); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 6px; font-size: 13px; cursor: pointer; 
            transition: all 0.2s;
            font-weight: 500;
        }
        .quick-tag-btn:hover { 
            background: rgba(255,255,255,0.08); 
            border-color: rgba(255,255,255,0.15);
        }
        .quick-tag-btn.selected { 
            background: #fff; 
            color: #000;
            border-color: transparent; 
        }
        .quick-tag-btn kbd { 
            font-size: 10px; opacity: 0.7; margin-left: 6px; 
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
        }
        .quick-tag-nav { display: flex; gap: 12px; margin-top: 28px; }
        .quick-tag-nav button { 
            flex: 1; padding: 12px; border-radius: 6px; font-size: 14px; 
            cursor: pointer; border: 1px solid transparent; 
            transition: all 0.2s;
            font-weight: 500;
        }
        .quick-tag-nav .prev { 
            background: rgba(255,255,255,0.06); 
            color: #e1e1e1; 
            border-color: rgba(255,255,255,0.1);
        }
        .quick-tag-nav .prev:hover { 
            background: rgba(255,255,255,0.1); 
            border-color: rgba(255,255,255,0.15);
        }
        .quick-tag-nav .next { 
            background: #fff; 
            color: #000; 
        }
        .quick-tag-nav .next:hover { 
            background: #e5e5e5;
        }
        
        /* ==================== Âè≥‰æßÈ¢ÑËßàÈù¢Êùø - Ê®°ÊãüÂô®Ê®°Âºè ==================== */
        .preview-panel {
            position: fixed;
            right: -420px;
            top: 0;
            width: 420px;
            height: 100vh;
            background: #111111;
            border-left: 1px solid rgba(255,255,255,0.06);
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
            z-index: 100;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .preview-panel.active {
            right: 0;
        }
        
        /* ‰∏ªÂÜÖÂÆπÂå∫ÈÄÇÈÖç */
        .main {
            transition: width 0.3s ease;
        }
        .main.preview-active {
            width: calc(100% - 420px);
        }
        
        /* Èù¢ÊùøÂ§¥ÈÉ® */
        .preview-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .preview-num {
            font-size: 20px;
            color: #fff;
            font-weight: 700;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        .preview-phase {
            padding: 4px 10px;
            background: rgba(255,255,255,0.08);
            color: #9ca3af;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        .preview-close {
            margin-left: auto;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 24px;
            cursor: pointer;
            padding: 0 8px;
            transition: color 0.2s;
        }
        .preview-close:hover {
            color: #e1e1e1;
        }
        
        /* ËÆæÂ§áÊ®°ÊãüÂô®ÔºàÊûÅÁÆÄËæπÊ°ÜÔºâ */
        .preview-device {
            flex: 0 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            position: relative;
            max-height: 48vh;
        }
        .device-screen {
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            overflow: hidden;
            background: #111111;
            box-shadow: 0 8px 40px rgba(0,0,0,0.6);
            max-width: 240px;
            position: relative;
        }
        .device-screen img {
            width: 100%;
            height: auto;
            max-height: 42vh;
            object-fit: contain;
            display: block;
            transition: opacity 0.15s ease-in-out;
        }
        .preview-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #6b7280;
            font-size: 14px;
            z-index: 10;
        }
        
        /* ËØ¶ÊÉÖÂå∫ */
        .preview-details {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .preview-desc {
            font-size: 15px;
            color: #e1e1e1;
            line-height: 1.6;
            margin-bottom: 14px;
        }
        .preview-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
            align-items: center;
        }
        .preview-tags .tag {
            padding: 4px 10px;
            background: rgba(255,255,255,0.08);
            color: #a1a1a1;
            border-radius: 4px;
            font-size: 12px;
        }
        .tag-edit-btn {
            padding: 5px 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #9ca3af;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag-edit-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.15);
        }
        .preview-filename {
            font-size: 11px;
            color: #6b7280;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        
        /* ÂØºËà™Ê†è */
        .preview-nav-bar {
            padding: 10px 16px;
            border-top: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .nav-btn {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #e1e1e1;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            line-height: 1.4;
        }
        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.15);
        }
        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .nav-btn span {
            font-size: 10px;
            color: #6b7280;
        }
        .nav-counter {
            font-size: 13px;
            color: #6b7280;
            font-family: 'SF Mono', 'Consolas', monospace;
            white-space: nowrap;
        }
        
        /* È¢ÑËßàÈù¢ÊùøTabÊ†∑Âºè */
        .preview-tab {
            flex: 1;
            padding: 10px 6px;
            background: none;
            border: none;
            color: #6b7280;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            white-space: nowrap;
            min-width: 0;
        }
        .preview-tab:hover {
            color: #e1e1e1;
            background: rgba(255,255,255,0.02);
        }
        .preview-tab.active {
            color: #fff;
            border-bottom-color: #fff;
        }
        .preview-tab-pane {
            display: none;
        }
        .preview-tab-pane.active {
            display: block;
        }
        
        /* ËÆæËÆ°‰∫ÆÁÇπÊ†∑Âºè */
        .highlight-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            border-left: 3px solid;
        }
        .highlight-item.visual { border-left-color: #34d399; }
        .highlight-item.interaction { border-left-color: #60a5fa; }
        .highlight-item.conversion { border-left-color: #f472b6; }
        .highlight-item.emotional { border-left-color: #fbbf24; }
        .highlight-category {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Tea-ai PM Lab</div>
            </div>
            
            <!-- ÂØºËà™ -->
            <div class="sidebar-section">
                <h3>ÂØºËà™ <span>Navigation</span></h3>
                <div class="nav-list">
                    <a href="/" class="nav-item active"><span class="icon"><svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></span>È¶ñÈ°µ <span class="nav-en">Home</span></a>
                    <a href="/sort" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg></span>ÊéíÂ∫è <span class="nav-en">Sort</span></a>
                    <a href="/onboarding" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></span>ÂºïÂØºÊµÅÁ®ã <span class="nav-en">Onboarding</span></a>
                    <a href="/store" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></span>ÂïÜÂüéÂØπÊØî <span class="nav-en">Store</span></a>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>ËßÜÂõæÊ®°Âºè <span>View Mode</span></h3>
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="standard" onclick="setCanvasMode('standard')">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5;margin-right:6px;"><path d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>ÊµèËßàÊ®°Âºè <span style="font-size:10px;opacity:0.6;">/ Browse</span>
                    </button>
                    <button class="mode-btn" data-mode="large" onclick="setCanvasMode('large')">
                        <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5;margin-right:6px;"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>ËØ¶ÊÉÖÊ®°Âºè <span style="font-size:10px;opacity:0.6;">/ Detail</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-section" style="flex:1; overflow-y:auto;">
                <h3>‰∫ßÂìÅÈ°πÁõÆ <span>Products</span></h3>
                <div id="project-list" class="project-list"></div>
                <button class="btn btn-secondary" style="width:100%; margin-top:12px;" onclick="showCreateModal()">+ Êñ∞Âª∫È°πÁõÆ <span style="font-size:10px;opacity:0.7;">New Project</span></button>
            </div>
            
            <div class="sidebar-section">
                <button class="btn btn-primary" style="width:100%;" onclick="openSmartImportModal()">
                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5;margin-right:6px;"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Êô∫ËÉΩÂØºÂÖ• <span class="nav-en">Smart Import</span>
                </button>
                <button class="btn btn-ghost" style="width:100%; margin-top:8px;" onclick="openDownloadPanel()">
                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5;margin-right:6px;"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    ÊâãÂä®ÈááÈõÜ <span class="nav-en">Manual</span>
                </button>
                <button class="btn btn-ghost" style="width:100%; margin-top:8px;" onclick="openAIAnalysisModal()">
                    <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.5;margin-right:6px;"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                    AIÂàÜÊûê <span class="nav-en">AI Analyze</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main">
            <div class="topbar">
                <span class="topbar-title" id="canvas-title">ÈÄâÊã©‰∫ßÂìÅÂºÄÂßãÂàÜÊûê <span style="font-size:12px;color:#6b7280;font-weight:400;">/ Select a product to start</span></span>
                <div class="topbar-actions">
                    <div id="size-switcher" style="display:none; margin-right: 12px;">
                        <button class="btn btn-ghost" onclick="setCardSize('S')" id="size-btn-S">S</button>
                        <button class="btn btn-ghost active" onclick="setCardSize('M')" id="size-btn-M">M</button>
                        <button class="btn btn-ghost" onclick="setCardSize('L')" id="size-btn-L">L</button>
                    </div>
                    <button class="btn btn-secondary" onclick="openQuickTagMode()">Âø´ÈÄüÊ†áÊ≥® <span style="font-size:11px;opacity:0.7;">Quick Tag</span></button>
                    <button class="btn btn-secondary" onclick="location.href='/quick-classify'" style="margin-left:4px;">ÂàÜÁ±ªË∞ÉÊï¥ <span style="font-size:11px;opacity:0.7;">Classify</span></button>
                    <button class="btn btn-secondary" onclick="location.href='/sort'" style="margin-left:4px;">ÊéíÂ∫èÂ∑•ÂÖ∑ <span style="font-size:11px;opacity:0.7;">Sort</span></button>
                    <button class="btn btn-secondary" onclick="location.href='/store'" style="margin-left:4px;">ÂïÜÂüéÂØπÊØî <span style="font-size:11px;opacity:0.7;">Store</span></button>
                    <button class="btn btn-export" onclick="exportCanvas()">ÂØºÂá∫ <span style="font-size:11px;opacity:0.7;">Export</span></button>
                </div>
            </div>
            
            <!-- Ê†áÁ≠æÁ≠õÈÄâÊ†è -->
            <div class="tag-filter-bar" id="tag-filter-bar" style="display:none;">
                <span class="label">ÊåâÊ†áÁ≠æÁ≠õÈÄâ <span style="font-size:11px;color:#6b7280;">Filter by tags:</span></span>
                <div id="active-tag-filters"></div>
                <div class="tag-add-btn" onclick="showTagFilterModal()">+ Ê∑ªÂä†Ê†áÁ≠æ <span style="font-size:10px;opacity:0.7;">Add Filter</span></div>
                <div style="flex:1;"></div>
                <span style="font-size:12px;color:#666;" id="filter-result-count"></span>
            </div>
            
            <div class="canvas-container" id="canvas-container">
                <div class="empty-state" id="empty-state">
                    <svg viewBox="0 0 24 24" style="width:48px;height:48px;stroke:#6b7280;fill:none;stroke-width:1;margin-bottom:16px;"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    <p>‰ªéÂ∑¶‰æßÈÄâÊã©‰∫ßÂìÅÔºåÊàñÊñ∞Âª∫È°πÁõÆÂºÄÂßã<br><span style="font-size:13px;color:#6b7280;">Select a product or create a new project</span></p>
                </div>
                
                <!-- ÊµèËßàÊ®°Âºè (Grid View) -->
                <div id="standard-view" class="grid-view" style="display:none;"></div>
                <!-- ËØ¶ÊÉÖÊ®°Âºè (Large Card View) -->
                <div id="large-view" class="grid-view" style="display:none;"></div>
                
                
            </div>
        </div>
    </div>
    
    <!-- Modal: Êñ∞Âª∫È°πÁõÆ -->
    <div id="modal-create" class="modal">
        <div class="modal-content">
            <h3>Êñ∞Âª∫È°πÁõÆ <span style="font-size:14px;color:#6b7280;font-weight:400;">Create Project</span></h3>
            <div class="form-group">
                <label>È°πÁõÆÂêçÁß∞ <span style="font-size:11px;color:#6b7280;">Project Name</span></label>
                <input type="text" id="new-project-name" class="form-input" placeholder="e.g., MyFitnessPal">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à <span style="font-size:11px;opacity:0.7;">Cancel</span></button>
                <button class="btn btn-primary" onclick="createProject()">ÂàõÂª∫ <span style="font-size:11px;opacity:0.8;">Create</span></button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Êô∫ËÉΩÂØºÂÖ• -->
    <div id="modal-smart-import" class="modal">
        <div class="modal-content" style="max-width: 520px;">
            <h3>Êô∫ËÉΩÂØºÂÖ• <span style="font-size:14px;color:#6b7280;font-weight:400;">Smart Import</span></h3>
            
            <div class="form-group">
                <label>‰∫ßÂìÅÂêçÁß∞ <span style="font-size:11px;color:#6b7280;">Product Name</span></label>
                <input type="text" id="smart-import-name" class="form-input" placeholder="e.g., Calm, Headspace, Duolingo">
            </div>
            
            <div id="smart-import-status" style="padding:16px;background:rgba(94,106,210,0.1);border-radius:8px;margin:16px 0;font-size:13px;display:none;">
            </div>
            
            <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:16px;margin:16px 0;">
                <div style="font-size:13px;color:#9ca3af;margin-bottom:12px;">Êô∫ËÉΩÂØºÂÖ•ÊµÅÁ®ã / Import Flow:</div>
                <ol style="font-size:12px;color:#6b7280;margin:0;padding-left:20px;line-height:1.8;">
                    <li>Ëá™Âä®ÊêúÁ¥¢ screensdesign.com</li>
                    <li>‰∏ãËΩΩÊâÄÊúâÊà™ÂõæÔºà‰øùÊåÅÂéüÂßãÈ°∫Â∫èÔºâ</li>
                    <li>AIÊô∫ËÉΩÂàÜÁ±ª</li>
                    <li>Ëá™Âä®È™åËØÅÈ°∫Â∫è</li>
                    <li>ÁîüÊàêÂàÜÊûêÊä•Âëä</li>
                </ol>
            </div>
            
            <div style="font-size:11px;color:#6b7280;margin-bottom:16px;">
                ‚ö° È¶ñÊ¨°‰ΩøÁî®ÈúÄË¶ÅÁôªÂΩï screensdesign.comÔºà‰ºöÂëòË¥¶Âè∑Ôºâ
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="startSmartImport()">ÂºÄÂßãÂØºÂÖ•</button>
            </div>
        </div>
    </div>
    
    <!-- Modal: ÈááÈõÜ -->
    <div id="modal-download" class="modal">
        <div class="modal-content">
            <h3>ÈááÈõÜÊà™Âõæ <span style="font-size:14px;color:#6b7280;font-weight:400;">Collect Screenshots</span></h3>
            <div class="form-group">
                <label>ÁõÆÊ†áURL <span style="font-size:11px;color:#6b7280;">App URL</span></label>
                <input type="text" id="download-url" class="form-input" placeholder="e.g., https://screensdesign.com/apps/calm">
            </div>
            <div id="download-status" style="font-size:13px;color:#9ca3af;margin-bottom:16px;"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à <span style="font-size:11px;opacity:0.7;">Cancel</span></button>
                <button class="btn btn-primary" onclick="startDownload()">ÂºÄÂßãÈááÈõÜ <span style="font-size:11px;opacity:0.8;">Start</span></button>
            </div>
        </div>
    </div>
    
    <!-- Modal: ÂõæÁâáÈ¢ÑËßà -->
    <div id="modal-preview" class="modal preview-modal" onclick="if(event.target===this)closePreview()">
        <button class="preview-nav prev" onclick="prevImage()">‚Äπ</button>
        <img id="preview-img" src="">
        <button class="preview-nav next" onclick="nextImage()">‚Ä∫</button>
        <div class="preview-info" style="max-width:80vw; text-align:center;">
            <div id="preview-desc" style="margin-bottom:6px; font-size:14px;"></div>
            <span id="preview-counter">1/100</span>
            <span style="margin-left:12px;cursor:pointer;" onclick="openTagSelectorForPreview()">üè∑Ô∏è Ê†áÁ≠æ</span>
        </div>
    </div>
    
    <!-- Modal: Ê†áÁ≠æÁ≠õÈÄâÈÄâÊã©Âô® -->
    <div id="modal-tag-filter" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3>ÈÄâÊã©Á≠õÈÄâÊ†áÁ≠æ <span style="font-size:14px;color:#6b7280;font-weight:400;">Select Tags to Filter</span></h3>
            <div class="tag-selector" id="tag-filter-selector"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="clearTagFilters()">Ê∏ÖÈô§ÂÖ®ÈÉ® <span style="font-size:11px;opacity:0.7;">Clear All</span></button>
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à <span style="font-size:11px;opacity:0.7;">Cancel</span></button>
                <button class="btn btn-primary" onclick="applyTagFilters()">Â∫îÁî®Á≠õÈÄâ <span style="font-size:11px;opacity:0.8;">Apply</span></button>
            </div>
        </div>
    </div>
    
    <!-- Modal: ‰∏∫Êà™ÂõæÊ∑ªÂä†Ê†áÁ≠æ -->
    <div id="modal-tag-edit" class="modal">
        <div class="modal-content" style="max-width:600px;">
            <h3>ÁºñËæëÊ†áÁ≠æ <span style="font-size:14px;color:#6b7280;font-weight:400;">Edit Tags</span> - <span id="tag-edit-filename"></span></h3>
            <div class="tag-selector" id="tag-edit-selector"></div>
            <div class="custom-tag-input">
                <input type="text" id="custom-tag-input" class="form-input" placeholder="ËæìÂÖ•Ëá™ÂÆö‰πâÊ†áÁ≠æ / Enter custom tag...">
                <button class="btn btn-secondary" onclick="addCustomTag()">Ê∑ªÂä† <span style="font-size:11px;opacity:0.7;">Add</span></button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à <span style="font-size:11px;opacity:0.7;">Cancel</span></button>
                <button class="btn btn-primary" onclick="saveScreenshotTags()">‰øùÂ≠ò <span style="font-size:11px;opacity:0.8;">Save</span></button>
            </div>
        </div>
    </div>
    
    <!-- Âø´ÈÄüÊ†áÊ≥®Ê®°Âºè -->
    <div id="quick-tag-view" class="quick-tag-view">
        <div class="quick-tag-header">
            <h3>üè∑Ô∏è Âø´ÈÄüÊ†áÊ≥®Ê®°Âºè <span style="font-size:14px;color:#6b7280;font-weight:400;">Quick Tagging</span></h3>
            <span class="quick-tag-progress" id="quick-tag-progress">1 / 100</span>
            <button class="btn btn-secondary" onclick="closeQuickTagMode()">‚úï ÂÖ≥Èó≠ <span style="font-size:11px;opacity:0.7;">Close</span></button>
        </div>
        <div class="quick-tag-main">
            <img id="quick-tag-image" class="quick-tag-image" src="">
            <div class="quick-tag-panel">
                <div id="quick-tag-sections"></div>
                <div class="quick-tag-nav">
                    <button class="prev" onclick="quickTagPrev()">‚Üê ‰∏ä‰∏ÄÂº† <span style="font-size:11px;opacity:0.7;">Prev</span></button>
                    <button class="next" onclick="quickTagNext()">‰∏ã‰∏ÄÂº† ‚Üí <span style="font-size:11px;opacity:0.7;">Next</span></button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <!-- Âø´Êç∑ÈîÆÊèêÁ§∫ -->
    <div id="keyboard-hint" style="position:fixed;bottom:20px;left:280px;padding:8px 16px;background:rgba(26,26,26,0.9);border:1px solid rgba(94,106,210,0.2);border-radius:8px;font-size:11px;color:#6b7280;display:none;backdrop-filter:blur(8px);z-index:50;">
        <span style="margin-right:16px;"><kbd style="background:#2a2a4e;padding:2px 6px;border-radius:4px;color:#a5b4fc;">‚Üê</kbd><kbd style="background:#2a2a4e;padding:2px 6px;border-radius:4px;color:#a5b4fc;">‚Üí</kbd> ÂàáÊç¢Êà™Âõæ / Navigate</span>
        <span style="margin-right:16px;"><kbd style="background:#2a2a4e;padding:2px 6px;border-radius:4px;color:#a5b4fc;">ESC</kbd> ÂÖ≥Èó≠Èù¢Êùø / Close</span>
        <span><kbd style="background:#2a2a4e;padding:2px 6px;border-radius:4px;color:#a5b4fc;">1-9</kbd> Âø´ÈÄüÊ†áÁ≠æ / Quick Tag</span>
    </div>
    
    <!-- Âè≥‰æßÈ¢ÑËßàÈù¢Êùø -->
    <div id="preview-panel" class="preview-panel">
        <div class="preview-header">
            <span class="preview-num" id="preview-panel-num">#1</span>
            <span class="preview-phase" id="preview-panel-phase">Launch</span>
            <button class="preview-close" onclick="closePreviewPanel()">√ó</button>
        </div>
        
        <div class="preview-device">
            <div class="device-screen">
                <div class="preview-loading" id="preview-loading" style="display:none;">
                    Loading...
                </div>
                <img id="preview-panel-img" src="" alt="" style="opacity:1;">
            </div>
        </div>
        
        <!-- TabÂàáÊç¢ -->
        <div class="preview-tabs" style="display:flex; border-bottom:1px solid rgba(94,106,210,0.12); padding:0 12px;">
            <button class="preview-tab active" data-tab="overview" onclick="switchPreviewTab('overview')">
                üìÑ Ê¶ÇËßà <span style="font-size:10px;opacity:0.6;">Overview</span>
            </button>
            <button class="preview-tab" data-tab="analysis" onclick="switchPreviewTab('analysis')">
                üé® ËÆæËÆ°ÂàÜÊûê <span style="font-size:10px;opacity:0.6;">Analysis</span>
            </button>
            <button class="preview-tab" data-tab="tags" onclick="switchPreviewTab('tags')">
                üè∑Ô∏è Ê†áÁ≠æ <span style="font-size:10px;opacity:0.6;">Tags</span>
            </button>
        </div>
        
        <!-- TabÂÜÖÂÆπÂå∫ -->
        <div class="preview-tab-content" style="flex:1; overflow-y:auto;">
            <!-- Ê¶ÇËßàTab -->
            <div class="preview-tab-pane active" id="tab-overview">
                <div style="padding:16px;">
                    <div class="preview-naming" id="preview-panel-naming" style="font-size:16px; color:#e1e1e1; font-weight:600; margin-bottom:8px;"></div>
                    <div class="preview-desc" id="preview-panel-desc" style="font-size:14px; color:#9ca3af; line-height:1.6; margin-bottom:12px;">
                        ÁÇπÂáªÂ∑¶‰æßÊà™ÂõæÊü•ÁúãËØ¶ÊÉÖ
                    </div>
                    <div class="preview-filename" id="preview-panel-filename" style="font-size:11px; color:#6b7280; font-family:monospace;"></div>
                </div>
            </div>
            
            <!-- ËÆæËÆ°ÂàÜÊûêTab -->
            <div class="preview-tab-pane" id="tab-analysis" style="display:none;">
                <div style="padding:16px;">
                    <div class="analysis-section" style="margin-bottom:20px;">
                        <div style="font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:10px; font-weight:600;">
                            ‚ö° Ê†∏ÂøÉÂäüËÉΩ / Core Function
                        </div>
                        <div id="preview-core-function" style="font-size:14px; color:#e1e1e1; line-height:1.6;"></div>
                    </div>
                    
                    <div class="analysis-section" style="margin-bottom:20px;">
                        <div style="font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:10px; font-weight:600;">
                            üé® ËÆæËÆ°‰∫ÆÁÇπ / Design Highlights
                        </div>
                        <div id="preview-highlights" style="font-size:13px; color:#d1d5db;"></div>
                    </div>
                    
                    <div class="analysis-section">
                        <div style="font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:10px; font-weight:600;">
                            üí° ‰∫ßÂìÅÊ¥ûÂØü / Product Insight
                        </div>
                        <div id="preview-insight" style="font-size:13px; color:#9ca3af; line-height:1.6; padding:12px; background:rgba(255,255,255,0.04); border-radius:8px; border-left:3px solid rgba(255,255,255,0.3);"></div>
                    </div>
                </div>
            </div>
            
            <!-- Ê†áÁ≠æTab -->
            <div class="preview-tab-pane" id="tab-tags" style="display:none;">
                <div style="padding:16px;">
                    <div style="font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:0.1em; margin-bottom:12px; font-weight:600;">
                        üè∑Ô∏è ÂΩìÂâçÊ†áÁ≠æ / Current Tags
                    </div>
                    <div id="preview-panel-tags-list" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;"></div>
                    <button class="tag-edit-btn" onclick="editPreviewTags()" style="width:100%; padding:10px; text-align:center;">
                        ‚úèÔ∏è ÁºñËæëÊ†áÁ≠æ <span style="font-size:11px;opacity:0.7;">Edit Tags</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="preview-nav-bar">
            <button class="nav-btn prev" onclick="previewPrev()" id="preview-prev-btn">
                ‚Üê ‰∏ä‰∏ÄÂº†<br><span>Prev</span>
            </button>
            <span class="nav-counter" id="preview-counter">1 / 120</span>
            <button class="nav-btn next" onclick="previewNext()" id="preview-next-btn">
                ‰∏ã‰∏ÄÂº† ‚Üí<br><span>Next</span>
            </button>
        </div>
    </div>

    <script>
        // ===== Áä∂ÊÄÅÁÆ°ÁêÜ =====
        let canvasMode = 'standard';  // ÈªòËÆ§ÊµèËßàÊ®°Âºè
        let cardSize = 'M';  // S / M / L
        let selectedProject = null;  // ÂçïÈÄâÊ®°Âºè
        let allProjects = [];
        let allScreenshots = {};
        let allDescriptions = {};  // Êà™ÂõæËØ¥ÊòéÔºàÁÆÄÂçïÊ†ºÂºèÔºâ
        let allScreenTypes = {};   // Êà™ÂõæÁ±ªÂûãÔºàÁî®‰∫éÂàÜÁªÑÔºâ- ÂÖºÂÆπÊóßÊï∞ÊçÆ
        let allClassifications = {};  // ‰∏âÂ±ÇÂàÜÁ±ªÊï∞ÊçÆÔºàstage/module/featureÔºâ
        let allStructuredDescriptions = {};  // ÁªìÊûÑÂåñÊèèËø∞ÔºàÂê´ËÆæËÆ°‰∫ÆÁÇπÁ≠âÔºâ
        let pageTypesConfig = [];  // È°µÈù¢Á±ªÂûãÈÖçÁΩÆÔºàÂèåËØ≠+ÂõæÊ†áÔºâ
        
        // Âè≥‰æßÈ¢ÑËßàÈù¢ÊùøÁä∂ÊÄÅ
        let previewPanelOpen = false;
        let currentPreviewProject = null;
        let currentPreviewIndex = 0;
        let currentPreviewList = [];  // ÂΩìÂâçÊµèËßàËåÉÂõ¥ÁöÑÊà™ÂõæÂàóË°®
        let preloadedImages = new Set();  // Â∑≤È¢ÑÂä†ËΩΩÁöÑÂõæÁâáÁºìÂ≠ò
        
        // ===== Intersection Observer Êô∫ËÉΩÈ¢ÑÂä†ËΩΩ =====
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        // ÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÁßªÈô§È™®Êû∂Â±èÂä®Áîª
                        img.onload = () => img.classList.add('loaded');
                        img.onerror = () => { img.classList.add('loaded'); img.style.background = '#1a1a1a'; };
                    }
                    imageObserver.unobserve(img);
                }
            });
        }, {
            rootMargin: '300px',  // ÊèêÂâç300pxÂºÄÂßãÂä†ËΩΩ
            threshold: 0.01
        });
        
        // ÂêØÂä®ÂõæÁâáËßÇÂØü
        function observeImages() {
            document.querySelectorAll('img[data-src]').forEach(img => {
                imageObserver.observe(img);
            });
        }
        let currentLoadingImageSrc = null;  // ÂΩìÂâçÊ≠£Âú®Âä†ËΩΩÁöÑÂõæÁâásrc
        let previewImages = [];
        let previewIndex = 0;
        
        // ÁîªÂ∏ÉÁä∂ÊÄÅ
        let canvasZoom = 1;
        let canvasPan = { x: 0, y: 0 };
        let nodePositions = {};
        let connections = [];
        let connectMode = false;
        let connectStart = null;
        
        // Ê†áÁ≠æÁ≥ªÁªüÁä∂ÊÄÅ
        let tagLibrary = {};          // È¢ÑËÆæÊ†áÁ≠æÂ∫ì
        let projectTags = {};         // ÂêÑÈ°πÁõÆÁöÑÊ†áÁ≠æÊï∞ÊçÆ { projectName: { filename: [tags] } }
        let activeTagFilters = [];    // ÂΩìÂâçÊøÄÊ¥ªÁöÑÊ†áÁ≠æÁ≠õÈÄâ
        let tempSelectedTags = [];    // ‰∏¥Êó∂ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÔºàÁî®‰∫éModalÔºâ
        let editingTagFile = null;    // ÂΩìÂâçÁºñËæëÊ†áÁ≠æÁöÑÊñá‰ª∂
        let editingTagProject = null; // ÂΩìÂâçÁºñËæëÊ†áÁ≠æÁöÑÈ°πÁõÆ
        let quickTagIndex = 0;        // Âø´ÈÄüÊ†áÊ≥®ÂΩìÂâçÁ¥¢Âºï
        let quickTagList = [];        // Âø´ÈÄüÊ†áÊ≥®ÁöÑÊà™ÂõæÂàóË°®
        // Ê≠•È™§Ê†áÊ≥®
        let projectSteps = {};        // { projectName: { filename: stepNumber } }
        
        const productColors = ['#667eea', '#f472b6', '#34d399', '#fbbf24', '#a78bfa', '#fb7185'];
        
        // ===== ËæÖÂä©ÂáΩÊï∞ÔºöËé∑ÂèñÈ°µÈù¢Á±ªÂûã‰ø°ÊÅØ =====
        function getPageTypeInfo(typeId) {
            // ‰ªétypeId‰∏≠ÊèêÂèñÁ±ªÂûãÂêçÔºàÂ¶Ç "Onboarding/Welcome" -> "Welcome", "05_Onboarding" -> "Onboarding"Ôºâ
            let typeName = typeId;
            if (typeId.includes('/')) {
                typeName = typeId.split('/').pop();  // ÂèñÊúÄÂêé‰∏ÄÈÉ®ÂàÜ
            } else if (typeId.includes('_')) {
                typeName = typeId.split('_').pop();
            }
            
            // ÊîØÊåÅÂØπË±°Ê†ºÂºèÁöÑÈÖçÁΩÆÔºàkeyÂ∞±ÊòØÁ±ªÂûãÂêçÔºâ
            if (pageTypesConfig && typeof pageTypesConfig === 'object' && !Array.isArray(pageTypesConfig)) {
                const found = pageTypesConfig[typeName] || pageTypesConfig[typeId];
                if (found) {
                    return { id: typeName, ...found };
                }
            }
            
            // ÊîØÊåÅÊï∞ÁªÑÊ†ºÂºèÁöÑÈÖçÁΩÆ
            if (Array.isArray(pageTypesConfig)) {
                const found = pageTypesConfig.find(pt => 
                    pt.id === typeName || pt.id === typeId || pt.en === typeName
                );
                if (found) return found;
            }
            
            // ÈªòËÆ§ËøîÂõû
            return {
                id: typeName,
                cn: typeName,
                en: typeName,
                icon: 'üìå',
                description_cn: '',
                description_en: ''
            };
        }
        
        // Ëé∑ÂèñÈò∂ÊÆµÁöÑÂèåËØ≠ÊòæÁ§∫ÂêçÁß∞
        function getPhaseName(phaseKey) {
            const info = getPageTypeInfo(phaseKey);
            return `${info.icon} ${info.cn} / ${info.en}`;
        }
        
        // Êà™ÂõæÊåâÊï∞Â≠óÈ°∫Â∫èÊéíÂ∫èÔºàScreen_001, Screen_002, ... Screen_010, ...Ôºâ
        function sortScreenshotsNumerically(a, b) {
            const numA = parseInt(a.match(/\d+/)?.[0] || '0');
            const numB = parseInt(b.match(/\d+/)?.[0] || '0');
            return numA - numB;
        }
        
        // Ëé∑ÂèñÊà™ÂõæÁöÑÂàÜÁªÑphaseÔºà‰ºòÂÖà‰ΩøÁî®‰∏âÂ±ÇÂàÜÁ±ªstage/moduleÔºåÂÖºÂÆπÊóßscreen_typeÔºâ
        function getScreenPhase(project, filename) {
            const classifications = allClassifications[project] || {};
            const screenTypes = allScreenTypes[project] || {};
            
            // ‰ºòÂÖà‰ΩøÁî®‰∏âÂ±ÇÂàÜÁ±ª
            if (classifications[filename]) {
                const cls = classifications[filename];
                if (cls.stage && cls.module) {
                    return `${cls.stage}/${cls.module}`;
                }
            }
            
            // ÂÖºÂÆπÊóßÁöÑscreen_type
            if (screenTypes[filename]) {
                return screenTypes[filename];
            }
            // ÂõûÈÄÄÂà∞Êñá‰ª∂ÂêçËß£Êûê
            return filename.split('_').slice(0, 2).join('_');
        }
        
        // Ëé∑ÂèñÈò∂ÊÆµÁöÑÁÆÄÁü≠ÊòæÁ§∫Ôºà‰ªÖÂõæÊ†á+‰∏≠ÊñáÔºâ
        function getPhaseShortName(phaseKey) {
            const info = getPageTypeInfo(phaseKey);
            return `${info.icon} ${info.cn}`;
        }
        
        // ===== ÂàùÂßãÂåñ =====
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPageTypesConfig();
            await loadTagLibrary();
            loadProjects();
            setupCanvasEvents();
            setupKeyboardShortcuts();
        });
        
        // Âä†ËΩΩÈ°µÈù¢Á±ªÂûãÈÖçÁΩÆ
        async function loadPageTypesConfig() {
            try {
                const res = await fetch('/api/config/page-types');
                pageTypesConfig = await res.json();
            } catch (e) {
                console.warn('Failed to load page types config:', e);
                pageTypesConfig = [];
            }
        }
        
        // Âä†ËΩΩÈ¢ÑËÆæÊ†áÁ≠æÂ∫ì
        async function loadTagLibrary() {
            const res = await fetch('/api/tag-library');
            tagLibrary = await res.json();
        }
        
        // Âä†ËΩΩÈ°πÁõÆÁöÑÁªìÊûÑÂåñÊèèËø∞
        async function loadStructuredDescriptions(projectName) {
            if (allStructuredDescriptions[projectName]) return;
            try {
                const res = await fetch(`/api/structured-descriptions/${projectName}`);
                const data = await res.json();
                // API Áõ¥Êé•ËøîÂõûÊï∞ÊçÆÂ≠óÂÖ∏
                if (data && typeof data === 'object') {
                    allStructuredDescriptions[projectName] = data;
                } else {
                    allStructuredDescriptions[projectName] = {};
                }
            } catch (e) {
                console.warn('Failed to load structured descriptions:', e);
                allStructuredDescriptions[projectName] = {};
            }
        }
        
        // Âä†ËΩΩÈ°πÁõÆÁöÑÊ†áÁ≠æÊï∞ÊçÆ
        async function loadProjectTags(projectName) {
            if (projectTags[projectName]) return;
            const res = await fetch(`/api/tags/${projectName}`);
            projectTags[projectName] = await res.json();
        }

        // Âä†ËΩΩÈ°πÁõÆÊ≠•È™§Ê†áÊ≥®
        async function loadProjectSteps(projectName) {
            if (projectSteps[projectName]) return;
            const res = await fetch(`/api/steps/${projectName}`);
            projectSteps[projectName] = await res.json();
        }
        
        // ===== È°πÁõÆÁÆ°ÁêÜ =====
        async function loadProjects() {
            const res = await fetch('/api/projects');
            const data = await res.json();
            allProjects = data.projects;
            
            const list = document.getElementById('project-list');
            list.innerHTML = allProjects.map((p, i) => {
                // Â∞ùËØï‰ΩøÁî® App Store icon
                const appName = p.name.replace('downloads_2024/', '');
                const isDownloads2024 = p.source === 'downloads_2024' || p.name.startsWith('downloads_2024/');
                
                let logoHtml;
                if (isDownloads2024) {
                    // ‰ΩøÁî® App Store iconÔºåÂ§±Ë¥•Êó∂ÂõûÈÄÄÂà∞È¢úËâ≤Âç†‰ΩçÁ¨¶
                    logoHtml = `<img class="project-logo" src="/api/store-screenshot/${appName}/icon.png" 
                                    onerror="this.outerHTML='<div class=\\'project-logo\\' style=\\'background:${p.color || 'rgba(255,255,255,0.1)'}\\'>${p.initial || p.display_name[0]}</div>'" 
                                    alt="${appName}" style="object-fit:cover;">`;
                } else {
                    logoHtml = `<div class="project-logo" style="background:${p.color || 'rgba(255,255,255,0.1)'}">${p.initial || p.display_name[0]}</div>`;
                }
                
                return `
                <div class="project-item ${selectedProject === p.name ? 'active' : ''}" onclick="toggleProject('${p.name}')" title="${p.description_cn || ''} ${p.description_en || ''}">
                    ${logoHtml}
                    <span class="name">${p.display_name || p.name.replace('_Analysis', '')}</span>
                    <span class="count">${p.screen_count}</span>
                </div>
            `}).join('');
        }
        
        // Èò≤ÊäñËÆ°Êó∂Âô®
        let toggleDebounceTimer = null;
        
        async function toggleProject(name) {
            // Èò≤ÊäñÂ§ÑÁêÜ - Âø´ÈÄüÁÇπÂáªÂè™ÂìçÂ∫îÊúÄÂêé‰∏ÄÊ¨°
            if (toggleDebounceTimer) {
                clearTimeout(toggleDebounceTimer);
            }
            
            // 1. Âç≥Êó∂ËßÜËßâÂèçÈ¶à - ‰∏çÁ≠âAPIÁ´ãÂç≥Êõ¥Êñ∞UI
            selectedProject = name;
            
            // Á´ãÂç≥Êõ¥Êñ∞sidebar activeÁä∂ÊÄÅ
            document.querySelectorAll('.project-item').forEach(item => {
                const itemName = item.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                item.classList.toggle('active', itemName === name);
            });
            
            // ÂÖ≥Èó≠È¢ÑËßàÈù¢Êùø
            if (previewPanelOpen) {
                closePreviewPanel();
            }
            
            // Ê∑°Âá∫ÂΩìÂâçÂÜÖÂÆπ
            const standardView = document.getElementById('standard-view');
            const largeView = document.getElementById('large-view');
            if (standardView) standardView.classList.add('switching');
            if (largeView) largeView.classList.add('switching');
            
            // ÊòæÁ§∫Ê†áÁ≠æÁ≠õÈÄâÊ†è
            document.getElementById('tag-filter-bar').style.display = 'flex';
            
            // Èò≤ÊäñÂª∂ËøüÂêéÂä†ËΩΩÊï∞ÊçÆ
            toggleDebounceTimer = setTimeout(async () => {
                try {
                    // Âº∫Âà∂Âà∑Êñ∞ÁªìÊûÑÂåñÊèèËø∞Ôºà‰øÆÂ§çÊï∞ÊçÆÊ†ºÂºèÈóÆÈ¢òÔºâ
                    delete allStructuredDescriptions[name];
                    
                    // 2. Âπ∂Ë°åAPIËØ∑Ê±Ç - ÂêåÊó∂ËØ∑Ê±ÇÊâÄÊúâÊï∞ÊçÆ
                    const needsScreenshots = !allScreenshots[name] || !allScreenTypes[name];
                    const needsTags = !projectTags[name];
                    const needsSteps = !projectSteps[name];
                    const needsDescriptions = true; // ÊÄªÊòØÈáçÊñ∞Âä†ËΩΩ
                    
                    const promises = [];
                    
                    if (needsScreenshots) {
                        promises.push(
                            fetch(`/api/screenshots/${name}`).then(r => r.json()).then(data => {
                                allScreenshots[name] = data.screens.length > 0 ? data.screens : data.downloads;
                                allDescriptions[name] = data.descriptions || {};
                                allScreenTypes[name] = data.screen_types || {};
                                allClassifications[name] = data.classifications || {};
                                console.log('Loaded classifications:', Object.keys(allClassifications[name]).length);
                            })
                        );
                    }
                    if (needsTags) {
                        promises.push(
                            fetch(`/api/tags/${name}`).then(r => r.json()).then(data => {
                                projectTags[name] = data;
                            })
                        );
                    }
                    if (needsSteps) {
                        promises.push(
                            fetch(`/api/steps/${name}`).then(r => r.json()).then(data => {
                                projectSteps[name] = data;
                            })
                        );
                    }
                    if (needsDescriptions) {
                        promises.push(
                            fetch(`/api/structured-descriptions/${name}`).then(r => r.json()).then(data => {
                                // API Áõ¥Êé•ËøîÂõûÊï∞ÊçÆÂ≠óÂÖ∏Ôºå‰∏çÊòØ {success, descriptions} Ê†ºÂºè
                                if (data && typeof data === 'object' && Object.keys(data).length > 0) {
                                    allStructuredDescriptions[name] = data;
                                    console.log('Stored structured data for', name, 'count:', Object.keys(data).length);
                                }
                            }).catch(e => console.error('Structured API error:', e))
                        );
                    }
                    
                    // Á≠âÂæÖÊâÄÊúâËØ∑Ê±ÇÂÆåÊàê
                    await Promise.all(promises);
                    
                    // 3. Á≠âÂæÖÊ∑°Âá∫ÂÆåÊàêÂêéÊ∏≤ÊüìÊñ∞ÂÜÖÂÆπ
                    await new Promise(r => setTimeout(r, 180));
                    
                    requestAnimationFrame(() => {
                        updateCanvas();
                        // Ê∏≤ÊüìÂêéÊ∑°ÂÖ•
                        setTimeout(() => {
                            const sv = document.getElementById('standard-view');
                            const lv = document.getElementById('large-view');
                            if (sv) sv.classList.remove('switching');
                            if (lv) lv.classList.remove('switching');
                        }, 20);
                    });
                    
                } catch (e) {
                    console.error('Failed to load project:', e);
                    showToast('Âä†ËΩΩÂ§±Ë¥• / Load failed');
                }
            }, 50); // 50msÈò≤ÊäñÂª∂Ëøü
        }
        
        function showCreateModal() {
            document.getElementById('modal-create').classList.add('active');
        }
        
        function openDownloadPanel() {
            document.getElementById('modal-download').classList.add('active');
        }
        
        // ===== Êô∫ËÉΩÂØºÂÖ• =====
        function openSmartImportModal() {
            document.getElementById('modal-smart-import').classList.add('active');
            document.getElementById('smart-import-name').focus();
        }
        
        async function startSmartImport() {
            const productName = document.getElementById('smart-import-name').value.trim();
            if (!productName) {
                showToast('Please enter a product name / ËØ∑ËæìÂÖ•‰∫ßÂìÅÂêçÁß∞');
                return;
            }
            
            const statusDiv = document.getElementById('smart-import-status');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = `
                <div style="color:#9ca3af;">Ê≠£Âú®ÂáÜÂ§áÊô∫ËÉΩÂØºÂÖ•...</div>
                <div style="margin-top:8px;font-size:12px;color:#6b7280;">
                    ËØ∑Âú®ÁªàÁ´ØËøêË°å‰ª•‰∏ãÂëΩ‰ª§Ôºö
                </div>
                <div style="margin-top:8px;padding:12px;background:#1a1a2e;border-radius:6px;font-family:monospace;font-size:12px;color:#a5f3fc;">
                    python smart_downloader.py "${productName}"
                </div>
                <div style="margin-top:12px;font-size:11px;color:#6b7280;">
                    üí° È¶ñÊ¨°ËøêË°å‰ºöÊâìÂºÄÊµèËßàÂô®ËÆ©‰Ω†ÁôªÂΩï<br>
                    üí° ÁôªÂΩïÂêéÊåâÂõûËΩ¶ÁªßÁª≠‰∏ãËΩΩ<br>
                    üí° ‰∏ãËΩΩÂÆåÊàêÂêéÂà∑Êñ∞È°µÈù¢Êü•Áúã
                </div>
            `;
            
            // Â§çÂà∂ÂëΩ‰ª§Âà∞Ââ™Ë¥¥Êùø
            try {
                await navigator.clipboard.writeText(`python smart_downloader.py "${productName}"`);
                showToast('Command copied! / ÂëΩ‰ª§Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            } catch(e) {
                // Clipboard API may not be available
            }
        }
        
        // ===== È°πÁõÆÈ™åËØÅ =====
        async function validateProject(projectName) {
            showToast('Running validation... / Ê≠£Âú®È™åËØÅ...');
            
            try {
                const res = await fetch(`/api/validate/${projectName}`, { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    if (data.passed) {
                        showToast(`Validation passed! / È™åËØÅÈÄöËøáÔºÅ`);
                    } else {
                        showToast(`Fixed ${data.fixes} files / ‰øÆÂ§ç‰∫Ü ${data.fixes} ‰∏™Êñá‰ª∂`);
                    }
                } else {
                    showToast(`Validation error: ${data.error}`);
                }
            } catch (e) {
                showToast('Validation failed / È™åËØÅÂ§±Ë¥•');
            }
        }
        
        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }
        
        async function createProject() {
            const name = document.getElementById('new-project-name').value.trim();
            if (!name) { showToast('ËØ∑ËæìÂÖ•ÂêçÁß∞'); return; }
            
            const res = await fetch('/api/projects', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({name})
            });
            const data = await res.json();
            
            if (data.success) {
                closeModal();
                document.getElementById('new-project-name').value = '';
                loadProjects();
                showToast('È°πÁõÆÂ∑≤ÂàõÂª∫');
            } else {
                showToast(data.error);
            }
        }
        
        async function startDownload() {
            const url = document.getElementById('download-url').value;
            if (!url || !selectedProject) {
                showToast('ËØ∑ËæìÂÖ•URLÂπ∂ÈÄâÊã©ÁõÆÊ†áÈ°πÁõÆ');
                return;
            }
            
            document.getElementById('download-status').textContent = '‚è≥ Ê≠£Âú®ÈááÈõÜ...';
            
            const res = await fetch('/api/download', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({project_name: selectedProject, url})
            });
            const data = await res.json();
            
            if (data.success) {
                document.getElementById('download-status').textContent = `‚úÖ ÊàêÂäüÈááÈõÜ ${data.count} Âº†`;
                showToast('ÈááÈõÜÂÆåÊàê');
                // ÈáçÊñ∞Âä†ËΩΩ
                delete allScreenshots[selectedProject];
                await toggleProject(selectedProject);
            } else {
                document.getElementById('download-status').textContent = `‚ùå ${data.error}`;
            }
        }
        
        // ===== ÁîªÂ∏ÉÊ®°ÂºèÂàáÊç¢ =====
        function setCanvasMode(mode) {
            // Âç≥Êó∂Êõ¥Êñ∞Áä∂ÊÄÅÂíåÊåâÈíÆ
            canvasMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // Âè™Âú®ÊµèËßàÊ®°ÂºèÊòæÁ§∫sizeÂàáÊç¢Âô®
            const sizeSwitcher = document.getElementById('size-switcher');
            if (sizeSwitcher) {
                sizeSwitcher.style.display = mode === 'standard' ? 'flex' : 'none';
            }
            
            // ‰ΩøÁî®RAFÊ∏≤ÊüìÔºåÈÅøÂÖçÈòªÂ°û
            requestAnimationFrame(() => updateCanvas());
        }
        
        function setCardSize(size) {
            cardSize = size;
            // Âç≥Êó∂Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            ['S', 'M', 'L'].forEach(s => {
                const btn = document.getElementById(`size-btn-${s}`);
                if (btn) btn.classList.toggle('active', s === size);
            });
            // ‰ΩøÁî®RAFÈÅøÂÖçÈòªÂ°û
            if (canvasMode === 'standard') {
                requestAnimationFrame(() => renderStandardView());
            }
        }
        
        function updateCanvas() {
            const empty = document.getElementById('empty-state');
            const standard = document.getElementById('standard-view');
            const large = document.getElementById('large-view');
            
            // ÈöêËóèÊâÄÊúâ
            empty.style.display = 'none';
            standard.style.display = 'none';
            large.style.display = 'none';
            
            if (!selectedProject) {
                empty.style.display = 'flex';
                document.getElementById('canvas-title').innerHTML = 'ÈÄâÊã©‰∫ßÂìÅÂºÄÂßãÂàÜÊûê <span style="font-size:12px;color:#6b7280;font-weight:400;">/ Select a product to start</span>';
                return;
            }
            
            const projectName = selectedProject.replace('_Analysis', '');
            const screenCount = (allScreenshots[selectedProject] || []).length;
            document.getElementById('canvas-title').innerHTML = `${projectName} <span style="font-size:13px;color:#6b7280;font-weight:400;">${screenCount} screens</span>`;
            
            switch (canvasMode) {
                case 'standard':
                    standard.style.display = 'flex';
                    renderStandardView();
                    break;
                case 'large':
                    large.style.display = 'flex';
                    renderLargeView();
                    break;
                default:
                    // ÈªòËÆ§ÊòæÁ§∫ÊµèËßàÊ®°Âºè
                    canvasMode = 'standard';
                    standard.style.display = 'flex';
                    renderStandardView();
                    break;
            }
        }
        
        // ===== Á¥ßÂáëËßÜÂõæÊ∏≤Êüì (Style A) =====
        function renderCompactView() {
            const container = document.getElementById('compact-view');
            if (!selectedProject) {
                container.innerHTML = '<div style="color:#6b7280;text-align:center;padding:40px;line-height:1.8;">ËØ∑ÈÄâÊã©‰∫ßÂìÅ<br><span style="font-size:13px;opacity:0.8;">Select a product</span></div>';
                return;
            }
            
            let html = '';
            const proj = selectedProject;
            const screens = allScreenshots[proj] || [];
            const filtered = activeTagFilters.length > 0 
                ? screens.filter(f => matchesTagFilter(proj, f)) 
                : screens;
            
            // ÊåâÈò∂ÊÆµÂàÜÁªÑÔºà‰ºòÂÖà‰ΩøÁî®‰∏âÂ±ÇÂàÜÁ±ªstage/moduleÔºåÂÖºÂÆπÊóßscreen_typesÔºâ
            const byPhase = {};
            const phaseFirstIdx = {}; // ËÆ∞ÂΩïÊØè‰∏™ÂàÜÁªÑÁ¨¨‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ‰ΩçÁΩÆ
            const classifications = allClassifications[proj] || {};
            const screenTypes = allScreenTypes[proj] || {};
            filtered.forEach((file, idx) => {
                let phase;
                // ‰ºòÂÖà‰ΩøÁî®‰∏âÂ±ÇÂàÜÁ±ª
                if (classifications[file] && classifications[file].stage && classifications[file].module) {
                    phase = `${classifications[file].stage}/${classifications[file].module}`;
                } else if (screenTypes[file]) {
                    // ÂÖºÂÆπÊóßÁöÑscreen_type
                    phase = screenTypes[file];
                } else {
                    // ÂõûÈÄÄÂà∞Êñá‰ª∂ÂêçËß£Êûê
                    phase = file.split('_').slice(0, 2).join('_');
                }
                if (!byPhase[phase]) {
                    byPhase[phase] = [];
                    phaseFirstIdx[phase] = idx; // ËÆ∞ÂΩïËØ•ÂàÜÁªÑÁ¨¨‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ‰ΩçÁΩÆ
                }
                byPhase[phase].push({file, idx: screens.indexOf(file), originalIdx: idx});
            });
            
            // ÊåâÂàÜÁªÑÁ¨¨‰∏ÄÊ¨°Âá∫Áé∞ÁöÑÈ°∫Â∫èÊéíÂ∫èÔºà‰øùÊåÅÊµÅÁ®ãÈ°∫Â∫èÔºâ
            const sortedPhases = Object.keys(byPhase).sort((a, b) => phaseFirstIdx[a] - phaseFirstIdx[b]);
            
            sortedPhases.forEach(phase => {
                const items = byPhase[phase];
                // ÂØπÁªÑÂÜÖÈ°πÁõÆÊåâÂéüÂßãÈ°∫Â∫èÊéíÂ∫è
                items.sort((a, b) => a.originalIdx - b.originalIdx);
                
                const phaseName = phaseNames[phase] || phase;
                html += `<div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; color: #888; margin-bottom: 10px; font-weight: 600;">${phaseName} (${items.length})</div>
                    <div class="phase-group-cards">`;
                
                items.forEach(({file, idx}) => {
                    const desc = getScreenshotDescription(proj, file);
                    const phaseShort = phase.split('_')[1] || phase;
                    html += `
                        <div class="card-compact" onclick="openPreviewPanel('${proj}', ${idx})" title="${desc}">
                            <span class="card-phase">${phaseShort}</span>
                            <img data-src="/api/thumb/${proj}/screens/${file}" src="" loading="lazy">
                            <div class="card-desc">${desc}</div>
                        </div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            updateFilterCount(filtered.length);
        }
        
        // ===== Ê†áÂáÜËßÜÂõæÊ∏≤Êüì (Style B) =====
        function renderStandardView() {
            console.log('[DEBUG] renderStandardView called');
            const container = document.getElementById('standard-view');
            console.log('[DEBUG] container:', container);
            if (!selectedProject) {
                container.innerHTML = '<div style="color:#6b7280;text-align:center;padding:40px;line-height:1.8;">ËØ∑ÈÄâÊã©‰∫ßÂìÅ<br><span style="font-size:13px;opacity:0.8;">Select a product</span></div>';
                return;
            }
            
            // Ê†πÊçÆcardSizeËÆæÁΩÆ‰∏çÂêåÂ∞∫ÂØ∏
            const cardSizes = { S: 60, M: 100, L: 140 };
            const cardWidth = cardSizes[cardSize] || 100;
            const cardClass = cardSize === 'S' ? 'card-compact' : 'card-standard';
            
            let html = '';
            const proj = selectedProject;
            const screens = allScreenshots[proj] || [];
            console.log('[DEBUG] proj:', proj, 'screens:', screens.length);
            const filtered = activeTagFilters.length > 0 
                ? screens.filter(f => matchesTagFilter(proj, f)) 
                : screens;
            console.log('[DEBUG] filtered:', filtered.length);
            
            const classifications = allClassifications[proj] || {};
            const screenTypes = allScreenTypes[proj] || {};
            
            // Êåâ Screen ÁºñÂè∑ÁöÑÁªùÂØπÈ°∫Â∫èÊéíÂ∫èÔºàScreen_001, Screen_002, ...Ôºâ
            const sortedFiltered = [...filtered].sort(sortScreenshotsNumerically);
            
            // Stage ÈÖçÁΩÆ
            const stageConfig = {
                'Onboarding': { icon: '', cn: 'ÂºïÂØºÊµÅÁ®ã', en: 'Onboarding' },
                'Core': { icon: '', cn: 'Ê†∏ÂøÉÂäüËÉΩ', en: 'Core' }
            };
            
            // Êåâ Stage ÂàÜÁªÑÔºå‰øùÊåÅÁªùÂØπÈ°∫Â∫è
            const byStage = {};
            const stageFirstIdx = {}; // ËÆ∞ÂΩïÊØè‰∏™ Stage Á¨¨‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ‰ΩçÁΩÆ
            
            sortedFiltered.forEach((file, displayIdx) => {
                // Ëé∑Âèñ Stage
                let stage = 'Onboarding'; // ÈªòËÆ§
                if (classifications[file] && classifications[file].stage) {
                    stage = classifications[file].stage;
                }
                
                if (!byStage[stage]) {
                    byStage[stage] = [];
                    stageFirstIdx[stage] = displayIdx;
                }
                byStage[stage].push({ file, displayIdx });
            });
            
            // Êåâ Stage Á¨¨‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ‰ΩçÁΩÆÊéíÂ∫è
            const sortedStages = Object.keys(byStage).sort((a, b) => stageFirstIdx[a] - stageFirstIdx[b]);
            
            // Ê∏≤ÊüìÊØè‰∏™ Stage ÂàÜÁªÑ
            sortedStages.forEach(stage => {
                const stageItems = byStage[stage];
                const config = stageConfig[stage] || { icon: '', cn: stage, en: stage };
                
                // Stage Â§ßÊ†áÈ¢ò
                html += `
                    <div class="stage-section" style="margin-bottom: 40px;">
                        <div class="stage-header" style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid rgba(255,255,255,0.1);">
                            <div style="font-size: 18px; color: #e1e1e1; font-weight: 700;">
                                ${config.cn} <span style="color: #6b7280; font-weight: 400;">${config.en}</span>
                            </div>
                            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                ${stageItems.length} Âº†Êà™Âõæ
                            </div>
                        </div>
                        <div class="phase-group-cards" style="gap: 16px;">`;
                
                // Ê∏≤ÊüìÁªÑÂÜÖÊà™ÂõæÔºàÂ∑≤‰øùÊåÅÁªùÂØπÈ°∫Â∫èÔºâ
                stageItems.forEach(({ file, displayIdx }) => {
                    const idx = screens.indexOf(file);
                    
                    // Ëé∑Âèñ Module ‰Ωú‰∏∫Ê†áÁ≠æ
                    let module = '';
                    if (classifications[file] && classifications[file].module) {
                        module = classifications[file].module;
                    } else {
                        module = screenTypes[file] || '';
                    }
                    const typeInfo = getPageTypeInfo(module);
                    
                    const structured = getStructuredDescription(proj, file);
                    const naming = structured?.naming?.cn || '';
                    const coreFunc = structured?.core_function?.cn || '';
                    const cardDesc = coreFunc || naming || getScreenshotDescription(proj, file);
                    const fullDesc = cardDesc;
                    
                    const thumbSize = cardSize === 'S' ? 'small' : 'medium';
                    const screenNum = file.match(/\d+/)?.[0] || (displayIdx + 1);
                    
                    if (cardSize === 'S') {
                        html += `
                            <div class="card-compact" data-file="${file}" onclick="openPreviewPanel('${proj}', ${idx})" title="${fullDesc}">
                                <span class="card-phase">${typeInfo.icon || '#' + screenNum}</span>
                                <img src="/api/thumb/${proj}/screens/${file}?size=${thumbSize}" loading="lazy">
                                <div class="card-desc">${cardDesc.length > 15 ? cardDesc.slice(0, 15) + '‚Ä¶' : cardDesc}</div>
                            </div>`;
                    } else {
                        html += `
                            <div class="card-standard" data-file="${file}" style="width:${cardWidth}px;" onclick="openPreviewPanel('${proj}', ${idx})" title="${fullDesc}">
                                <div class="card-phase-bar">${typeInfo.icon} ${typeInfo.cn || '#' + screenNum}</div>
                                <img src="/api/thumb/${proj}/screens/${file}?size=${thumbSize}" loading="lazy">
                                <div class="card-info">
                                    <div class="card-desc">${cardDesc.length > 30 ? cardDesc.slice(0, 30) + '‚Ä¶' : cardDesc}</div>
                                </div>
                            </div>`;
                    }
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            updateFilterCount(filtered.length);
            // ÂêØÂä®Êô∫ËÉΩÈ¢ÑÂä†ËΩΩ
            requestAnimationFrame(() => observeImages());
        }
        
        // Ëé∑ÂèñÁªìÊûÑÂåñÊèèËø∞
        function getStructuredDescription(project, file) {
            const projectData = allStructuredDescriptions[project];
            console.log('getStructuredDescription:', {project, file, hasProjectData: !!projectData, keys: projectData ? Object.keys(projectData).slice(0,3) : []});
            if (!projectData) return null;
            return projectData[file] || null;
        }
        
        // ===== ËØ¶ÊÉÖËßÜÂõæÊ∏≤Êüì (Style C) =====
        function renderDetailedView() {
            const container = document.getElementById('detailed-view');
            if (!selectedProject) {
                container.innerHTML = '<div style="color:#6b7280;text-align:center;padding:40px;line-height:1.8;">ËØ∑ÈÄâÊã©‰∫ßÂìÅ<br><span style="font-size:13px;opacity:0.8;">Select a product</span></div>';
                return;
            }
            
            let html = '';
            const proj = selectedProject;
            const screens = allScreenshots[proj] || [];
            const filtered = activeTagFilters.length > 0 
                ? screens.filter(f => matchesTagFilter(proj, f)) 
                : screens;
            
            const byPhase = {};
            filtered.forEach((file, idx) => {
                const phase = file.split('_').slice(0, 2).join('_');
                if (!byPhase[phase]) byPhase[phase] = [];
                byPhase[phase].push({file, idx: screens.indexOf(file), globalIdx: idx + 1});
            });
            
            // ËÆ∞ÂΩïÊØè‰∏™ÂàÜÁªÑÁ¨¨‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ‰ΩçÁΩÆ
            const phaseFirstIdx = {};
            filtered.forEach((file, idx) => {
                const phase = file.split('_').slice(0, 2).join('_');
                if (phaseFirstIdx[phase] === undefined) phaseFirstIdx[phase] = idx;
            });
            // ÊåâÁ¨¨‰∏ÄÊ¨°Âá∫Áé∞È°∫Â∫èÊéíÂ∫è
            Object.entries(byPhase).sort((a, b) => phaseFirstIdx[a[0]] - phaseFirstIdx[b[0]]).forEach(([phase, items]) => {
                // ÂØπÁªÑÂÜÖÈ°πÁõÆÊåâÊï∞Â≠óÈ°∫Â∫èÊéíÂ∫è
                items.sort((a, b) => sortScreenshotsNumerically(a.file, b.file));
                
                const phaseName = phaseNames[phase] || phase;
                html += `<div style="margin-bottom: 24px;">
                    <div style="font-size: 13px; color: #9ca3af; margin-bottom: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
                        ${phaseName} <span style="color:#6b7280;font-weight:400;">(${items.length})</span>
                    </div>
                    <div class="phase-group-cards">`;
                
                items.forEach(({file, idx, globalIdx}) => {
                    const structured = getStructuredDescription(proj, file);
                    // ‰ºòÂÖà‰ΩøÁî®AIÂàÜÊûêÁªìÊûú
                    const naming = structured?.naming?.cn || '';
                    const coreFunc = structured?.core_function?.cn || '';
                    const displayTitle = naming || coreFunc || getScreenshotDescription(proj, file);
                    const tags = getScreenshotTags(proj, file);
                    const phaseTag = phase.split('_')[1] || phase;
                    
                    html += `
                        <div class="card-detailed" onclick="openPreviewPanel('${proj}', ${idx})" title="${displayTitle}">
                            <div class="card-header">
                                <span class="card-num">#${globalIdx}</span>
                                <span class="card-phase-tag">${naming || phaseTag}</span>
                            </div>
                            <img data-src="/api/thumb/${proj}/screens/${file}" src="" loading="lazy">
                            <div class="card-info">
                                <div class="card-desc">${coreFunc || displayTitle}</div>
                                ${tags.length > 0 ? `
                                    <div class="card-tags">
                                        ${tags.slice(0, 3).map(t => `<span class="card-tag">${t}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            updateFilterCount(filtered.length);
            // ÂêØÂä®Êô∫ËÉΩÈ¢ÑÂä†ËΩΩ
            requestAnimationFrame(() => observeImages());
        }
        
        // ===== Â§ßÂç°ÁâáËßÜÂõæÊ∏≤Êüì (Style D) =====
        function renderLargeView() {
            const container = document.getElementById('large-view');
            if (!selectedProject) {
                container.innerHTML = '<div style="color:#6b7280;text-align:center;padding:60px;font-size:18px;line-height:1.8;">ÈÄâÊã©‰∫ßÂìÅÂºÄÂßãÊµèËßà<br><span style="font-size:15px;opacity:0.8;">Select a product to browse</span></div>';
                return;
            }
            
            let html = '';
            let globalNum = 0;
            const proj = selectedProject;
            const screens = allScreenshots[proj] || [];
            const filtered = activeTagFilters.length > 0 
                ? screens.filter(f => matchesTagFilter(proj, f)) 
                : screens;
            
            // ÊåâÈò∂ÊÆµÂàÜÁªÑÂπ∂ËÆ°Êï∞
            const phaseGroups = {};
            filtered.forEach(file => {
                const phase = file.split('_').slice(0, 2).join('_');
                if (!phaseGroups[phase]) phaseGroups[phase] = [];
                phaseGroups[phase].push(file);
            });
            
            let lastPhase = null;
            filtered.forEach((file, localIdx) => {
                globalNum++;
                const idx = screens.indexOf(file);
                const desc = getScreenshotDescription(proj, file);
                const structured = getStructuredDescription(proj, file);
                const phase = file.split('_').slice(0, 2).join('_');
                const typeInfo = getPageTypeInfo(phase);
                
                // ‰ªéÁªìÊûÑÂåñÊï∞ÊçÆËé∑ÂèñÊõ¥Â§ö‰ø°ÊÅØ
                const naming = structured?.naming || {};
                const coreFunc = structured?.core_function || {};
                const highlights = structured?.design_highlights || [];
                const insight = structured?.product_insight || {};
                
                // Èò∂ÊÆµÂèòÂåñÊó∂ÊèíÂÖ•ÂàÜÈöîÂå∫Âùó
                if (phase !== lastPhase) {
                    if (lastPhase !== null) {
                        html += `</div></div>`; // ÂÖ≥Èó≠‰∏ä‰∏Ä‰∏™phase-cardsÂíåphase-section
                    }
                    const count = phaseGroups[phase]?.length || 0;
                    // ÂΩì‰∏≠Ëã±ÊñáÁõ∏ÂêåÊó∂Âè™ÊòæÁ§∫‰∏Ä‰∏™ÔºåÈÅøÂÖç "Activity / Activity" ÈáçÂ§ç
                    const showBilingual = typeInfo.cn !== typeInfo.en;
                    html += `
                        <div class="phase-section">
                            <div class="phase-divider">
                                <span class="phase-divider-icon">${typeInfo.icon}</span>
                                <span class="phase-divider-name">${typeInfo.cn}${showBilingual ? `<span class="phase-divider-name-en">${typeInfo.en}</span>` : ''}</span>
                                <span class="phase-divider-count">${count}</span>
                            </div>
                            <div class="large-phase-cards">`;
                    lastPhase = phase;
                }
                
                // ÊûÑÂª∫ËÆæËÆ°‰∫ÆÁÇπHTMLÔºàÂ¶ÇÊûúÊúâÔºâ
                const highlightsHtml = highlights.length > 0 ? `
                    <div class="card-highlights" style="margin-top:12px; font-size:12px; color:#9ca3af;">
                        ${highlights.slice(0, 2).map(h => `<div style="margin-bottom:4px;">‚Ä¢ ${h.cn || h.en || ''}</div>`).join('')}
                    </div>
                ` : '';
                
                // ‰ºòÂåñÂèåËØ≠Ê†áÈ¢òÊòæÁ§∫
                const namingCn = naming.cn || '';
                const namingEn = naming.en || '';
                const showNamingEn = namingEn && namingCn !== namingEn;
                
                html += `
                    <div class="card-large" data-file="${file}" onclick="openPreviewPanel('${proj}', ${idx})">
                        <div class="card-image">
                            <img data-src="/api/thumb/${proj}/screens/${file}?size=large" src="" loading="lazy">
                        </div>
                        <div class="card-content">
                            <span class="card-num">#${globalNum}</span>
                            <div class="card-naming">
                                ${namingCn}${showNamingEn ? `<span class="card-naming-en">/ ${namingEn}</span>` : ''}
                            </div>
                            <div class="card-desc">${coreFunc.cn || desc}</div>
                            ${highlightsHtml}
                        </div>
                    </div>`;
            });
            
            html += `</div></div>`; // ÂÖ≥Èó≠ÊúÄÂêéÁöÑphase-cardsÂíåphase-section
            container.innerHTML = html;
            updateFilterCount(filtered.length);
            // ÂêØÂä®Êô∫ËÉΩÈ¢ÑÂä†ËΩΩ
            requestAnimationFrame(() => observeImages());
        }
        
        function updateFilterCount(total) {
            const countEl = document.getElementById('filter-result-count');
            if (countEl) {
                countEl.innerHTML = activeTagFilters.length > 0 
                    ? `Á≠õÈÄâÁªìÊûú: ${total} Âº† <span style="opacity:0.6;">/ ${total} filtered</span>` 
                    : `ÂÖ± ${total} Âº† <span style="opacity:0.6;">/ ${total} total</span>`;
            }
        }
        
        // ===== Ê≥≥ÈÅìÂõæÊ∏≤Êüì =====
        function renderSwimlane() {
            // Â¶ÇÊûúÊúâÊ†áÁ≠æÁ≠õÈÄâÔºåÊåâÊ†áÁ≠æÊòæÁ§∫ÔºõÂê¶ÂàôÊåâÈò∂ÊÆµÊòæÁ§∫
            if (activeTagFilters.length > 0) {
                renderSwimlaneByTags();
            } else {
                renderSwimlaneByPhase();
            }
        }
        
        // ÊåâÈò∂ÊÆµÊòæÁ§∫ÔºàÈªòËÆ§Ê®°ÂºèÔºâ
        function renderSwimlaneByPhase() {
            // Êî∂ÈõÜÊâÄÊúâÈò∂ÊÆµ
            const allPhases = new Set();
            selectedProjects.forEach(proj => {
                (allScreenshots[proj] || []).forEach(file => {
                    const phase = file.split('_').slice(0, 2).join('_');
                    allPhases.add(phase);
                });
            });
            // ÊåâÊµÅÁ®ãÈ°∫Â∫èÊéíÂ∫èÔºàÈÄöËøáÊñá‰ª∂Âêç‰∏≠ÁöÑÊï∞Â≠óÔºâ
            const phaseOrder = {};
            selectedProjects.forEach(proj => {
                (allScreenshots[proj] || []).forEach((file, idx) => {
                    const phase = file.split('_').slice(0, 2).join('_');
                    if (phaseOrder[phase] === undefined) phaseOrder[phase] = idx;
                });
            });
            const phases = Array.from(allPhases).sort((a, b) => (phaseOrder[a] || 0) - (phaseOrder[b] || 0));
            
            // Êñ∞Â∏ÉÂ±ÄÔºöÈò∂ÊÆµ‰∏∫Ë°åÔºå‰∫ßÂìÅ‰∏∫ÂàóÔºàÊ®™ÂêëÂØπÊØîÔºâ
            let html = `<table class="swimlane-table">
                <thead><tr>
                    <th>Èò∂ÊÆµ</th>
                    ${selectedProjects.map((p, i) => `
                        <th>
                            <div class="product-label">
                                <div class="product-color" style="background:${productColors[i % productColors.length]}"></div>
                                ${p.replace('_Analysis', '')}
                            </div>
                        </th>
                    `).join('')}
                </tr></thead>
                <tbody>`;
            
            // ‰∏∫ÊØè‰∏™‰∫ßÂìÅÊï¥ÁêÜÊà™Âõæ
            const projectScreens = {};
            selectedProjects.forEach(proj => {
                const byPhase = {};
                (allScreenshots[proj] || []).forEach((file, idx) => {
                    const phase = file.split('_').slice(0, 2).join('_');
                    if (!byPhase[phase]) byPhase[phase] = [];
                    byPhase[phase].push({file, idx});
                });
                projectScreens[proj] = byPhase;
            });
            
            // ÊØè‰∏™Èò∂ÊÆµ‰∏ÄË°å
            phases.forEach(phase => {
                html += `<tr>
                    <td style="font-weight:600;color:#9ca3af;">${phaseNames[phase] || phase}</td>
                    ${selectedProjects.map(proj => {
                        const items = (projectScreens[proj][phase] || []).sort((a, b) => a.file.localeCompare(b.file));
                        return `
                            <td>
                                <div class="swimlane-cell">
                                    ${items.map(({file, idx}) => renderSwimlaneThumb(proj, file, idx)).join('')}
                                    ${items.length === 0 ? '<span style="color:#555;font-size:12px;">‚Äî</span>' : ''}
                                </div>
                            </td>
                        `;
                    }).join('')}
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('swimlane-view').innerHTML = html;
            document.getElementById('filter-result-count').textContent = '';
        }
        
        // ÊåâÊ†áÁ≠æÁ≠õÈÄâÊòæÁ§∫
        function renderSwimlaneByTags() {
            let html = `<table class="swimlane-table">
                <thead><tr>
                    <th>Ê†áÁ≠æÁ≠õÈÄâ: ${activeTagFilters.join(', ')}</th>
                    ${selectedProjects.map((p, i) => `
                        <th>
                            <div class="product-label">
                                <div class="product-color" style="background:${productColors[i % productColors.length]}"></div>
                                ${p.replace('_Analysis', '')}
                            </div>
                        </th>
                    `).join('')}
                </tr></thead>
                <tbody><tr>
                    <td style="font-weight:600;color:#9ca3af;">ÂåπÈÖçÁªìÊûú</td>`;
            
            let totalMatches = 0;
            
            selectedProjects.forEach(proj => {
                const screens = allScreenshots[proj] || [];
                const matchedItems = [];
                
                screens.forEach((file, idx) => {
                    if (matchesTagFilter(proj, file)) {
                        matchedItems.push({file, idx});
                        totalMatches++;
                    }
                });
                
                html += `
                    <td>
                        <div class="swimlane-cell" style="flex-wrap:wrap;">
                            ${matchedItems.map(({file, idx}) => renderSwimlaneThumb(proj, file, idx)).join('')}
                            ${matchedItems.length === 0 ? '<span style="color:#555;font-size:12px;">Êó†ÂåπÈÖç</span>' : ''}
                        </div>
                    </td>
                `;
            });
            
            html += '</tr></tbody></table>';
            document.getElementById('swimlane-view').innerHTML = html;
            document.getElementById('filter-result-count').textContent = `ÂÖ± ${totalMatches} Âº†ÂåπÈÖç`;
        }
        
        // Ê∏≤ÊüìÂçï‰∏™Ê≥≥ÈÅìÁº©Áï•ÂõæÔºàÂ∏¶Ê†áÁ≠æÊòæÁ§∫Ôºâ
        function renderSwimlaneThumb(project, file, idx) {
            const tags = getScreenshotTags(project, file);
            const step = getScreenshotStep(project, file);
            const desc = getScreenshotDescription(project, file);
            const tagsHtml = tags.length > 0 
                ? `<div class="thumb-tags">${tags.slice(0, 2).map(t => `<span class="thumb-tag">${t}</span>`).join('')}</div>`
                : '';
            
            return `
                <div class="swimlane-thumb" 
                     onclick="openSwimlanePreview('${project}', ${idx})"
                     oncontextmenu="event.preventDefault(); openStepPrompt('${project}', '${file}');"
                     title="${desc}">
                    ${step ? `<div class="step-badge">S${step}</div>` : ''}
                    <img src="/api/thumb/${project}/screens/${file}" loading="lazy">
                    ${tagsHtml}
                </div>
            `;
        }

        // ===== StoryboardÊ∏≤ÊüìÔºàËá™Âä®ÊåâÂ∫èÂè∑ÂØπÈΩêÔºâ =====
        function renderStoryboard() {
            // Êî∂ÈõÜÊØè‰∏™È°πÁõÆÁöÑÊà™ÂõæÂàóË°®ÔºàÊåâÊñá‰ª∂ÂêçÊéíÂ∫èÔºåÂèØÈÄâÊ†áÁ≠æÁ≠õÈÄâÔºâ
            const projectScreenLists = {};
            let maxCount = 0;
            
            selectedProjects.forEach(proj => {
                const screens = allScreenshots[proj] || [];
                // Ê†πÊçÆÊ†áÁ≠æÁ≠õÈÄâ
                const filtered = activeTagFilters.length > 0
                    ? screens.filter(f => matchesTagFilter(proj, f))
                    : screens;
                projectScreenLists[proj] = filtered.sort(sortScreenshotsNumerically);
                maxCount = Math.max(maxCount, filtered.length);
            });
            
            if (maxCount === 0) {
                document.getElementById('storyboard-view').innerHTML = `
                    <div style="color:#666;text-align:center;padding:40px;">
                        ${activeTagFilters.length > 0 
                            ? 'Ê≤°ÊúâÂåπÈÖçÂΩìÂâçÊ†áÁ≠æÁ≠õÈÄâÁöÑÊà™Âõæ' 
                            : 'ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅÔºåÊàñ‰ΩøÁî®Ê†áÁ≠æÁ≠õÈÄâÊåáÂÆöÂØπÊØîËåÉÂõ¥'}
                    </div>`;
                return;
            }
            
            let html = `<table class="swimlane-table">
                <thead><tr>
                    <th style="width:60px;">#</th>
                    ${selectedProjects.map((p, i) => `
                        <th>
                            <div class="product-label">
                                <div class="product-color" style="background:${productColors[i % productColors.length]}"></div>
                                ${p.replace('_Analysis', '')}
                                <span style="opacity:0.6;font-size:11px;margin-left:4px;">(${projectScreenLists[p].length})</span>
                            </div>
                        </th>
                    `).join('')}
                </tr></thead>
                <tbody>`;
            
            // ÈÄêË°åÊ∏≤Êüì
            for (let i = 0; i < maxCount; i++) {
                html += `<tr>
                    <td style="font-weight:600;color:#9ca3af;text-align:center;">${i + 1}</td>`;
                
                selectedProjects.forEach(proj => {
                    const list = projectScreenLists[proj];
                    const file = list[i];
                    if (file) {
                        const idx = (allScreenshots[proj] || []).indexOf(file);
                        html += `<td><div class="swimlane-cell">${renderStoryboardThumb(proj, file, idx)}</div></td>`;
                    } else {
                        html += `<td><div class="swimlane-cell" style="color:#555;font-size:12px;justify-content:center;">‚Äî</div></td>`;
                    }
                });
                
                html += `</tr>`;
            }
            
            html += '</tbody></table>';
            document.getElementById('storyboard-view').innerHTML = html;
            
            // ÁªüËÆ°‰ø°ÊÅØ
            const totalScreens = Object.values(projectScreenLists).reduce((a, b) => a + b.length, 0);
            document.getElementById('filter-result-count').textContent = 
                `StoryboardÔºö${selectedProjects.length} ‰∏™‰∫ßÂìÅÔºåÂÖ± ${maxCount} Ê≠•Ôºå${totalScreens} Âº†Êà™Âõæ`;
        }
        
        // Ëé∑ÂèñÊà™ÂõæËØ¥Êòé - ‰ºòÂÖà‰ΩøÁî®AIÂàÜÊûêÁöÑÁªìÊûÑÂåñÊèèËø∞
        function getScreenshotDescription(project, file) {
            // ‰ºòÂÖà‰ΩøÁî®ÁªìÊûÑÂåñÊèèËø∞ (AIÂàÜÊûêÁªìÊûú)
            const structured = allStructuredDescriptions[project]?.[file];
            if (structured?.naming?.cn) return structured.naming.cn;
            if (structured?.core_function?.cn) return structured.core_function.cn;
            
            // ÂÖ∂Ê¨°‰ΩøÁî®ÊóßÊèèËø∞
            const descs = allDescriptions[project] || {};
            if (descs[file]) return descs[file];
            
            // ÊúÄÂêé‰ªéÊñá‰ª∂ÂêçÊèêÂèñ
            return file.replace(/^\d+_[^_]+_/, '').replace('.png', '').replace(/_/g, ' ');
        }
        
        // Storyboard‰∏ìÁî®Áº©Áï•ÂõæÔºàÊõ¥Â§ß„ÄÅÊõ¥Ê∏ÖÊô∞Ôºâ
        function renderStoryboardThumb(project, file, idx) {
            const tags = getScreenshotTags(project, file);
            const tagsHtml = tags.length > 0 
                ? `<div class="thumb-tags">${tags.slice(0, 2).map(t => `<span class="thumb-tag">${t}</span>`).join('')}</div>`
                : '';
            
            const desc = getScreenshotDescription(project, file);
            
            return `
                <div class="storyboard-thumb" onclick="openSwimlanePreview('${project}', ${idx})" title="${desc}">
                    <img src="/api/thumb/${project}/screens/${file}" loading="lazy">
                    ${tagsHtml}
                    <div class="storyboard-label">${desc}</div>
                </div>
            `;
        }
        
        function openSwimlanePreview(project, index) {
            previewImages = (allScreenshots[project] || []).map(f => ({project, file: f}));
            previewIndex = index;
            updatePreview();
            document.getElementById('modal-preview').classList.add('active');
        }
        
        // ===== Ëá™Áî±ÁîªÂ∏ÉÊ∏≤Êüì =====
        let canvasNodes = [];  // ÂΩìÂâçÁîªÂ∏É‰∏äÁöÑËäÇÁÇπ
        
        function renderFreeform() {
            const inner = document.getElementById('canvas-inner');
            const hint = document.getElementById('freeform-hint');
            
            // Ê∏≤ÊüìÂ∑≤Ê∑ªÂä†ÁöÑËäÇÁÇπ
            let html = '';
            canvasNodes.forEach((node, idx) => {
                const pos = nodePositions[node.key] || { x: 100 + (idx % 5) * 140, y: 100 + Math.floor(idx / 5) * 200 };
                nodePositions[node.key] = pos;
                
                html += `
                    <div class="canvas-node" 
                         style="left:${pos.x}px;top:${pos.y}px;"
                         data-key="${node.key}"
                         onmousedown="startDragNode(event, '${node.key}')"
                         ondblclick="openNodePreview('${node.project}', '${node.file}')">
                        <img src="/api/thumb/${node.project}/screens/${node.file}">
                        <div class="node-label">${node.file.split('_').slice(2).join('_').replace('.png','')}</div>
                    </div>
                `;
            });
            
            inner.innerHTML = html;
            inner.style.transform = `scale(${canvasZoom}) translate(${canvasPan.x}px, ${canvasPan.y}px)`;
            
            // ÊòæÁ§∫/ÈöêËóèÊèêÁ§∫
            hint.style.display = canvasNodes.length === 0 ? 'block' : 'none';
            
            // Êõ¥Êñ∞Êà™ÂõæÂ∫ì
            renderLibrary();
        }
        
        function openNodePreview(project, file) {
            previewImages = [{project, file}];
            previewIndex = 0;
            updatePreview();
            document.getElementById('modal-preview').classList.add('active');
        }
        
        // Êà™ÂõæÂ∫ì
        function toggleLibrary() {
            document.getElementById('library-panel').classList.toggle('active');
        }
        
        function renderLibrary() {
            const content = document.getElementById('library-content');
            if (!content) return;
            
            let html = '';
            selectedProjects.forEach((proj, pi) => {
                const screens = allScreenshots[proj] || [];
                // ÊåâÈò∂ÊÆµÂàÜÁªÑ
                const byPhase = {};
                screens.forEach((file, idx) => {
                    const phase = file.split('_').slice(0, 2).join('_');
                    if (!byPhase[phase]) byPhase[phase] = [];
                    byPhase[phase].push({file, idx});
                });
                
                html += `<div style="color:#888;font-size:11px;margin:12px 0 8px;text-transform:uppercase;">${proj.replace('_Analysis','')}</div>`;
                
                Object.entries(byPhase).forEach(([phase, items]) => {
                    // ÂØπÁªÑÂÜÖÈ°πÁõÆÊåâÊñá‰ª∂ÂêçÊéíÂ∫è
                    items.sort((a, b) => sortScreenshotsNumerically(a.file, b.file));
                    
                    html += `
                        <div class="library-phase">
                            <div class="library-phase-header">
                                <span class="library-phase-title">${phaseNames[phase] || phase}</span>
                                <span class="library-phase-count">${items.length}</span>
                                <button class="library-phase-add" onclick="addPhaseToCanvas('${proj}', '${phase}')">+ÂÖ®ÈÉ®</button>
                            </div>
                            <div class="library-thumbs">
                                ${items.map(({file}) => `
                                    <div class="library-thumb" 
                                         draggable="true"
                                         ondragstart="dragLibraryItem(event, '${proj}', '${file}')"
                                         onclick="addSingleToCanvas('${proj}', '${file}')">
                                        <img src="/api/thumb/${proj}/screens/${file}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            });
            
            content.innerHTML = html || '<div style="color:#666;text-align:center;padding:20px;">ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅ</div>';
        }
        
        function addPhaseToCanvas(project, phase) {
            const screens = allScreenshots[project] || [];
            screens.filter(f => f.startsWith(phase)).forEach(file => {
                addSingleToCanvas(project, file);
            });
        }
        
        function addSingleToCanvas(project, file) {
            const key = `${project}_${file}`;
            if (canvasNodes.find(n => n.key === key)) {
                showToast('Â∑≤Âú®ÁîªÂ∏É‰∏≠');
                return;
            }
            canvasNodes.push({ key, project, file });
            renderFreeform();
            showToast('Â∑≤Ê∑ªÂä†');
        }
        
        function dragLibraryItem(e, project, file) {
            e.dataTransfer.setData('application/json', JSON.stringify({project, file}));
        }
        
        
        // ËäÇÁÇπÊãñÊãΩ
        let draggingNode = null;
        let dragOffset = {x: 0, y: 0};
        
        function startDragNode(e, key) {
            if (e.button !== 0) return;
            draggingNode = key;
            const node = document.querySelector(`[data-key="${key}"]`);
            dragOffset = {
                x: e.clientX - nodePositions[key].x * canvasZoom,
                y: e.clientY - nodePositions[key].y * canvasZoom
            };
            e.preventDefault();
        }
        
        function setupCanvasEvents() {
            document.addEventListener('mousemove', (e) => {
                if (draggingNode) {
                    nodePositions[draggingNode] = {
                        x: (e.clientX - dragOffset.x) / canvasZoom,
                        y: (e.clientY - dragOffset.y) / canvasZoom
                    };
                    const node = document.querySelector(`[data-key="${draggingNode}"]`);
                    if (node) {
                        node.style.left = nodePositions[draggingNode].x + 'px';
                        node.style.top = nodePositions[draggingNode].y + 'px';
                    }
                }
            });
            
            document.addEventListener('mouseup', () => {
                draggingNode = null;
            });
            
            // ÁîªÂ∏ÉÁº©Êîæ
            document.getElementById('freeform-view')?.addEventListener('wheel', (e) => {
                if (e.ctrlKey) {
                    e.preventDefault();
                    zoomCanvas(e.deltaY > 0 ? -0.1 : 0.1);
                }
            });
        }
        
        function zoomCanvas(delta) {
            canvasZoom = Math.max(0.2, Math.min(2, canvasZoom + delta));
            document.getElementById('zoom-level').textContent = Math.round(canvasZoom * 100) + '%';
            document.getElementById('canvas-inner').style.transform = 
                `scale(${canvasZoom}) translate(${canvasPan.x}px, ${canvasPan.y}px)`;
        }
        
        function resetCanvas() {
            canvasZoom = 1;
            canvasPan = {x: 0, y: 0};
            document.getElementById('zoom-level').textContent = '100%';
            document.getElementById('canvas-inner').style.transform = 'scale(1)';
        }
        
        function fitCanvas() {
            // Ëá™Âä®ÈÄÇÈÖç
            canvasZoom = 0.8;
            canvasPan = {x: 0, y: 0};
            document.getElementById('zoom-level').textContent = '80%';
            document.getElementById('canvas-inner').style.transform = 'scale(0.8)';
        }
        
        // ===== ÊµÅÁ®ãÂõæÊ∏≤Êüì =====
        let flowNodes = [];  // ÊµÅÁ®ãÂõæËäÇÁÇπ
        
        function renderFlowchart() {
            const container = document.getElementById('flow-nodes');
            const hint = document.getElementById('flow-hint');
            
            let html = '';
            flowNodes.forEach((node, idx) => {
                const key = `flow_${node.project}_${node.file}`;
                const pos = nodePositions[key] || { x: 100 + (idx % 5) * 130, y: 100 + Math.floor(idx / 5) * 180 };
                nodePositions[key] = pos;
                
                html += `
                    <div class="flow-node" id="${key}" 
                         style="left:${pos.x}px;top:${pos.y}px;"
                         data-key="${key}"
                         onclick="handleFlowNodeClick('${key}')"
                         onmousedown="startDragNode(event, '${key}')">
                        <img src="/api/thumb/${node.project}/screens/${node.file}">
                        <div class="connect-dot top" data-pos="top"></div>
                        <div class="connect-dot bottom" data-pos="bottom"></div>
                        <div class="connect-dot left" data-pos="left"></div>
                        <div class="connect-dot right" data-pos="right"></div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            hint.style.display = flowNodes.length === 0 ? 'block' : 'none';
            
            drawConnections();
            renderFlowLibrary();
        }
        
        function toggleFlowLibrary() {
            document.getElementById('flow-library-panel').classList.toggle('active');
        }
        
        function renderFlowLibrary() {
            const content = document.getElementById('flow-library-content');
            if (!content) return;
            
            let html = '';
            selectedProjects.forEach((proj) => {
                const screens = allScreenshots[proj] || [];
                const byPhase = {};
                screens.forEach((file, idx) => {
                    const phase = file.split('_').slice(0, 2).join('_');
                    if (!byPhase[phase]) byPhase[phase] = [];
                    byPhase[phase].push({file, idx});
                });
                
                html += `<div style="color:#888;font-size:11px;margin:12px 0 8px;text-transform:uppercase;">${proj.replace('_Analysis','')}</div>`;
                
                Object.entries(byPhase).forEach(([phase, items]) => {
                    // ÂØπÁªÑÂÜÖÈ°πÁõÆÊåâÊñá‰ª∂ÂêçÊéíÂ∫è
                    items.sort((a, b) => sortScreenshotsNumerically(a.file, b.file));
                    
                    html += `
                        <div class="library-phase">
                            <div class="library-phase-header">
                                <span class="library-phase-title">${phaseNames[phase] || phase}</span>
                                <span class="library-phase-count">${items.length}</span>
                                <button class="library-phase-add" onclick="addPhaseToFlow('${proj}', '${phase}')">+ÂÖ®ÈÉ®</button>
                            </div>
                            <div class="library-thumbs">
                                ${items.map(({file}) => `
                                    <div class="library-thumb" onclick="addSingleToFlow('${proj}', '${file}')">
                                        <img src="/api/thumb/${proj}/screens/${file}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            });
            
            content.innerHTML = html || '<div style="color:#666;text-align:center;padding:20px;">ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅ</div>';
        }
        
        function addPhaseToFlow(project, phase) {
            const screens = allScreenshots[project] || [];
            screens.filter(f => f.startsWith(phase)).forEach(file => {
                addSingleToFlow(project, file);
            });
        }
        
        function addSingleToFlow(project, file) {
            const key = `flow_${project}_${file}`;
            if (flowNodes.find(n => `flow_${n.project}_${n.file}` === key)) {
                showToast('Â∑≤Âú®ÁîªÂ∏É‰∏≠');
                return;
            }
            flowNodes.push({ project, file });
            renderFlowchart();
            showToast('Â∑≤Ê∑ªÂä†');
        }
        
        function toggleConnectMode() {
            connectMode = !connectMode;
            document.getElementById('connect-mode-btn').style.background = connectMode ? '#667eea' : '';
            showToast(connectMode ? 'ÁÇπÂáª‰∏§‰∏™ËäÇÁÇπÂàõÂª∫ËøûÁ∫ø' : 'ËøûÁ∫øÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠');
        }
        
        function handleFlowNodeClick(key) {
            if (!connectMode) return;
            
            if (!connectStart) {
                connectStart = key;
                document.getElementById(key)?.classList.add('connecting');
            } else {
                if (connectStart !== key) {
                    connections.push({from: connectStart, to: key});
                    drawConnections();
                }
                document.getElementById(connectStart)?.classList.remove('connecting');
                connectStart = null;
            }
        }
        
        function drawConnections() {
            const svg = document.getElementById('flow-svg');
            let paths = '';
            
            connections.forEach(conn => {
                const fromEl = document.getElementById(conn.from);
                const toEl = document.getElementById(conn.to);
                if (fromEl && toEl) {
                    const fromRect = fromEl.getBoundingClientRect();
                    const toRect = toEl.getBoundingClientRect();
                    const container = document.getElementById('flowchart-view').getBoundingClientRect();
                    
                    const x1 = fromRect.left + fromRect.width/2 - container.left;
                    const y1 = fromRect.bottom - container.top;
                    const x2 = toRect.left + toRect.width/2 - container.left;
                    const y2 = toRect.top - container.top;
                    
                    // Ë¥ùÂ°ûÂ∞îÊõ≤Á∫ø
                    const midY = (y1 + y2) / 2;
                    paths += `<path d="M${x1},${y1} C${x1},${midY} ${x2},${midY} ${x2},${y2}"/>`;
                }
            });
            
            svg.innerHTML = `
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#667eea"/>
                    </marker>
                </defs>
                ${paths}
            `;
        }
        
        function clearConnections() {
            connections = [];
            drawConnections();
            showToast('ËøûÁ∫øÂ∑≤Ê∏ÖÈô§');
        }
        
        // ===== ÂõæÁâáÈ¢ÑËßà =====
        function updatePreview() {
            const item = previewImages[previewIndex];
            if (item) {
                document.getElementById('preview-img').src = `/api/screenshot/${item.project}/screens/${item.file}`;
                document.getElementById('preview-counter').textContent = `${previewIndex + 1} / ${previewImages.length}`;
                document.getElementById('preview-desc').textContent = getScreenshotDescription(item.project, item.file);
            }
        }
        
        function closePreview() {
            document.getElementById('modal-preview').classList.remove('active');
        }
        
        function prevImage() {
            if (previewIndex > 0) { previewIndex--; updatePreview(); }
        }
        
        function nextImage() {
            if (previewIndex < previewImages.length - 1) { previewIndex++; updatePreview(); }
        }
        
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('modal-preview').classList.contains('active')) {
                if (e.key === 'ArrowLeft') prevImage();
                if (e.key === 'ArrowRight') nextImage();
                if (e.key === 'Escape') closePreview();
            }
        });
        
        // ===== ÂØºÂá∫ =====
        function exportCanvas() {
            if (!selectedProject) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅ');
                return;
            }
            
            // ÊòæÁ§∫ÂØºÂá∫ÈÄâÈ°πModal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'modal-export';
            modal.innerHTML = `
                <div class="modal-content" style="max-width:400px;">
                    <h3>üì§ ÂØºÂá∫È°πÁõÆ <span style="font-size:14px;color:#6b7280;font-weight:400;">Export Project</span></h3>
                    <p style="color:#9ca3af;margin-bottom:20px;font-size:14px;">
                        ÈÄâÊã©ÂØºÂá∫Ê†ºÂºè / Choose export format
                    </p>
                    <div style="display:flex;flex-direction:column;gap:12px;">
                        <button class="btn btn-secondary" onclick="doExport('csv')" style="justify-content:flex-start;padding:14px 16px;">
                            CSV Êà™ÂõæÊ∏ÖÂçï <span style="font-size:12px;opacity:0.7;margin-left:8px;">/ Screenshot List</span>
                        </button>
                        <button class="btn btn-secondary" onclick="doExport('markdown')" style="justify-content:flex-start;padding:14px 16px;">
                            Markdown ÂàÜÊûêÊä•Âëä <span style="font-size:12px;opacity:0.7;margin-left:8px;">/ Analysis Report</span>
                        </button>
                        <button class="btn btn-secondary" onclick="doExport('json')" style="justify-content:flex-start;padding:14px 16px;">
                            JSON ÂÆåÊï¥Êï∞ÊçÆ <span style="font-size:12px;opacity:0.7;margin-left:8px;">/ Full Data</span>
                        </button>
                    </div>
                    <div class="modal-actions" style="margin-top:20px;">
                        <button class="btn btn-secondary" onclick="closeExportModal()">ÂèñÊ∂à <span style="font-size:11px;opacity:0.7;">Cancel</span></button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeExportModal() {
            const modal = document.getElementById('modal-export');
            if (modal) modal.remove();
        }
        
        function doExport(format) {
            if (!selectedProject) return;
            
            // Áõ¥Êé•‰∏ãËΩΩ
            const url = `/api/export/${selectedProject}/${format}`;
            window.open(url, '_blank');
            
            closeExportModal();
            showToast(`Ê≠£Âú®ÂØºÂá∫ ${format.toUpperCase()} Êñá‰ª∂...`);
        }
        
        // ===== AIÂàÜÊûêÂäüËÉΩ =====
        async function openAIAnalysisModal() {
            if (!selectedProject) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅ');
                return;
            }
            
            // Ê£ÄÊü•ÂàÜÊûêÁä∂ÊÄÅ
            const statusRes = await fetch(`/api/analysis-status/${selectedProject}`);
            const status = await statusRes.json();
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'modal-ai-analysis';
            
            let statusHtml = '';
            let actionHtml = '';
            
            if (status.status === 'completed') {
                statusHtml = `
                    <div style="padding:16px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);border-radius:8px;margin-bottom:20px;">
                        <div style="color:#34d399;font-weight:600;margin-bottom:4px;">‚úÖ ÂàÜÊûêÂ∑≤ÂÆåÊàê / Analysis Completed</div>
                        <div style="color:#9ca3af;font-size:13px;">${status.message}</div>
                    </div>
                `;
                actionHtml = `
                    <p style="color:#9ca3af;font-size:13px;margin-bottom:16px;">
                        Â¶ÇÈúÄÈáçÊñ∞ÂàÜÊûêÔºåËØ∑Âú®ÂëΩ‰ª§Ë°åËøêË°åÔºö<br>
                        <code style="background:#1a1a1a;padding:8px 12px;border-radius:6px;display:block;margin-top:8px;font-size:12px;color:#a5b4fc;">
                            cd PM_Screenshot_Tool/ai_analysis<br>
                            python batch_ai_analyze.py --project ${selectedProject}
                        </code>
                    </p>
                `;
            } else if (status.status === 'partial') {
                statusHtml = `
                    <div style="padding:16px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;margin-bottom:20px;">
                        <div style="color:#fbbf24;font-weight:600;margin-bottom:4px;">‚ö†Ô∏è ÈÉ®ÂàÜÂ∑≤ÂàÜÊûê / Partially Analyzed</div>
                        <div style="color:#9ca3af;font-size:13px;">${status.message}</div>
                    </div>
                `;
                actionHtml = `
                    <p style="color:#9ca3af;font-size:13px;margin-bottom:16px;">
                        ÁªßÁª≠ÂàÜÊûêÂâ©‰ΩôÊà™ÂõæÔºåËØ∑Âú®ÂëΩ‰ª§Ë°åËøêË°åÔºö<br>
                        <code style="background:#1a1a1a;padding:8px 12px;border-radius:6px;display:block;margin-top:8px;font-size:12px;color:#a5b4fc;">
                            cd PM_Screenshot_Tool/ai_analysis<br>
                            python batch_ai_analyze.py --project ${selectedProject}
                        </code>
                    </p>
                `;
            } else {
                statusHtml = `
                    <div style="padding:16px;background:rgba(107,114,128,0.1);border:1px solid rgba(107,114,128,0.3);border-radius:8px;margin-bottom:20px;">
                        <div style="color:#9ca3af;font-weight:600;margin-bottom:4px;">ÂæÖÂàÜÊûê / Not Analyzed</div>
                        <div style="color:#6b7280;font-size:13px;">${status.total} Âº†Êà™ÂõæÂæÖÂàÜÊûê</div>
                    </div>
                `;
                actionHtml = `
                    <p style="color:#9ca3af;font-size:13px;margin-bottom:16px;">
                        ÂºÄÂßãAIÂàÜÊûêÔºåËØ∑Âú®ÂëΩ‰ª§Ë°åËøêË°åÔºö<br>
                        <code style="background:#1a1a1a;padding:8px 12px;border-radius:6px;display:block;margin-top:8px;font-size:12px;color:#a5b4fc;">
                            cd PM_Screenshot_Tool/ai_analysis<br>
                            set ANTHROPIC_API_KEY=your_key_here<br>
                            python batch_ai_analyze.py --project ${selectedProject}
                        </code>
                    </p>
                    <p style="color:#6b7280;font-size:12px;">
                        ÈúÄË¶Å Anthropic API Key„ÄÇËé∑ÂèñÂú∞ÂùÄÔºö<a href="https://console.anthropic.com/" target="_blank" style="color:#a5b4fc;">console.anthropic.com</a>
                    </p>
                `;
            }
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width:500px;">
                    <h3>AI ÂàÜÊûê <span style="font-size:14px;color:#6b7280;font-weight:400;">AI Analysis</span></h3>
                    <p style="color:#9ca3af;margin-bottom:16px;font-size:14px;">
                        ${selectedProject.replace('_Analysis', '')} ¬∑ ${status.total} Âº†Êà™Âõæ
                    </p>
                    ${statusHtml}
                    ${actionHtml}
                    <div class="modal-actions" style="margin-top:20px;">
                        <button class="btn btn-secondary" onclick="refreshAnalysisStatus()">üîÑ Âà∑Êñ∞Áä∂ÊÄÅ <span style="font-size:11px;opacity:0.7;">Refresh</span></button>
                        <button class="btn btn-secondary" onclick="closeAIAnalysisModal()">ÂÖ≥Èó≠ <span style="font-size:11px;opacity:0.7;">Close</span></button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeAIAnalysisModal() {
            const modal = document.getElementById('modal-ai-analysis');
            if (modal) modal.remove();
        }
        
        async function refreshAnalysisStatus() {
            closeAIAnalysisModal();
            await openAIAnalysisModal();
            
            // ÂêåÊó∂Âà∑Êñ∞ÁªìÊûÑÂåñÊèèËø∞Êï∞ÊçÆ
            if (selectedProject) {
                delete allStructuredDescriptions[selectedProject];
                await loadStructuredDescriptions(selectedProject);
                updateCanvas();
            }
        }
        
        // ===== Ê†áÁ≠æÁ≥ªÁªü =====
        
        // Ê∏≤ÊüìÊ†áÁ≠æÈÄâÊã©Âô®ÔºàÁî®‰∫éÁ≠õÈÄâÂíåÁºñËæëÔºâ
        function renderTagSelector(containerId, selectedTags = [], showCustom = false) {
            const container = document.getElementById(containerId);
            let html = '';
            
            Object.entries(tagLibrary).forEach(([category, tags]) => {
                html += `
                    <div class="tag-category">
                        <div class="tag-category-title">${category}</div>
                        <div class="tag-options">
                            ${tags.map(tag => `
                                <div class="tag-option ${selectedTags.includes(tag) ? 'selected' : ''}" 
                                     onclick="toggleTagSelection('${tag}', '${containerId}')">
                                    ${tag}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleTagSelection(tag, containerId) {
            const idx = tempSelectedTags.indexOf(tag);
            if (idx === -1) {
                tempSelectedTags.push(tag);
            } else {
                tempSelectedTags.splice(idx, 1);
            }
            renderTagSelector(containerId, tempSelectedTags);
        }
        
        // Ê†áÁ≠æÁ≠õÈÄâ
        function showTagFilterModal() {
            tempSelectedTags = [...activeTagFilters];
            renderTagSelector('tag-filter-selector', tempSelectedTags);
            document.getElementById('modal-tag-filter').classList.add('active');
        }
        
        function applyTagFilters() {
            activeTagFilters = [...tempSelectedTags];
            closeModal();
            renderActiveTagFilters();
            updateCanvas();
            
            // Â¶ÇÊûúÈ¢ÑËßàÈù¢ÊùøÊâìÂºÄÔºåÈáçÊñ∞ÊûÑÂª∫ÂàóË°®
            if (previewPanelOpen && currentPreviewProject) {
                const screens = allScreenshots[currentPreviewProject] || [];
                currentPreviewList = activeTagFilters.length > 0
                    ? screens.filter(f => matchesTagFilter(currentPreviewProject, f))
                    : screens;
                // ÈáçÊñ∞ÂÆö‰ΩçÂΩìÂâçÁ¥¢Âºï
                const currentFile = screens[allScreenshots[currentPreviewProject].indexOf(currentPreviewList[currentPreviewIndex])];
                currentPreviewIndex = currentPreviewList.indexOf(currentFile);
                if (currentPreviewIndex === -1 && currentPreviewList.length > 0) {
                    currentPreviewIndex = 0;
                }
                if (currentPreviewList.length === 0) {
                    closePreviewPanel();
                } else {
                    renderPreviewPanel();
                }
            }
        }
        
        function clearTagFilters() {
            activeTagFilters = [];
            tempSelectedTags = [];
            renderTagSelector('tag-filter-selector', []);
            renderActiveTagFilters();
            updateCanvas();
            
            // Â¶ÇÊûúÈ¢ÑËßàÈù¢ÊùøÊâìÂºÄÔºåÈáçÊñ∞ÊûÑÂª∫ÂàóË°®
            if (previewPanelOpen && currentPreviewProject) {
                const screens = allScreenshots[currentPreviewProject] || [];
                currentPreviewList = screens;  // Ê∏ÖÈô§Á≠õÈÄâÔºåÊòæÁ§∫ÂÖ®ÈÉ®
                // ‰øùÊåÅÂΩìÂâç‰ΩçÁΩÆÊàñÈáçÁΩÆ
                if (currentPreviewIndex >= currentPreviewList.length) {
                    currentPreviewIndex = currentPreviewList.length - 1;
                }
                renderPreviewPanel();
            }
        }
        
        function renderActiveTagFilters() {
            const container = document.getElementById('active-tag-filters');
            container.innerHTML = activeTagFilters.map(tag => `
                <div class="tag-chip active">
                    ${tag}
                    <span class="remove" onclick="removeTagFilter('${tag}')">√ó</span>
                </div>
            `).join('');
        }
        
        function removeTagFilter(tag) {
            activeTagFilters = activeTagFilters.filter(t => t !== tag);
            renderActiveTagFilters();
            updateCanvas();
        }
        
        // Ëé∑ÂèñÊà™ÂõæÁöÑÊ†áÁ≠æ
        function getScreenshotTags(project, filename) {
            return (projectTags[project] && projectTags[project][filename]) || [];
        }
        
        // Ê£ÄÊü•Êà™ÂõæÊòØÂê¶ÂåπÈÖçÁ≠õÈÄâ
        function matchesTagFilter(project, filename) {
            if (activeTagFilters.length === 0) return true;
            const tags = getScreenshotTags(project, filename);
            return activeTagFilters.some(filter => tags.includes(filter));
        }
        
        // ÁºñËæëÊà™ÂõæÊ†áÁ≠æ
        function openTagEditor(project, filename) {
            editingTagProject = project;
            editingTagFile = filename;
            tempSelectedTags = [...getScreenshotTags(project, filename)];
            
            document.getElementById('tag-edit-filename').textContent = filename;
            renderTagSelector('tag-edit-selector', tempSelectedTags);
            document.getElementById('modal-tag-edit').classList.add('active');
        }
        
        function openTagSelectorForPreview() {
            const item = previewImages[previewIndex];
            if (item) {
                openTagEditor(item.project, item.file);
            }
        }
        
        async function saveScreenshotTags() {
            if (!editingTagProject || !editingTagFile) return;
            
            const res = await fetch(`/api/tags/${editingTagProject}/${editingTagFile}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tags: tempSelectedTags })
            });
            
            const data = await res.json();
            if (data.success) {
                // Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠ò
                if (!projectTags[editingTagProject]) projectTags[editingTagProject] = {};
                projectTags[editingTagProject][editingTagFile] = tempSelectedTags;
                
                closeModal();
                showToast('Ê†áÁ≠æÂ∑≤‰øùÂ≠ò');
                updateCanvas();
                
                // Â¶ÇÊûúÈ¢ÑËßàÈù¢ÊùøÊâìÂºÄ‰∏îÁºñËæëÁöÑÊòØÂΩìÂâçÈ¢ÑËßàÁöÑÊñá‰ª∂ÔºåÊõ¥Êñ∞ÊòæÁ§∫
                if (previewPanelOpen && currentPreviewProject === editingTagProject) {
                    const currentFile = currentPreviewList[currentPreviewIndex];
                    if (currentFile === editingTagFile) {
                        renderPreviewPanel();
                    }
                }
            } else {
                showToast('‰øùÂ≠òÂ§±Ë¥•: ' + data.error);
            }
        }
        
        function addCustomTag() {
            const input = document.getElementById('custom-tag-input');
            const tag = input.value.trim();
            if (tag && !tempSelectedTags.includes(tag)) {
                tempSelectedTags.push(tag);
                renderTagSelector('tag-edit-selector', tempSelectedTags);
                input.value = '';
            }
        }
        
        // ===== Âø´ÈÄüÊ†áÊ≥®Ê®°Âºè =====
        
        function openQuickTagMode() {
            if (!selectedProject) {
                showToast('ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅ');
                return;
            }
            
            // ÊûÑÂª∫Âø´ÈÄüÊ†áÊ≥®ÂàóË°®ÔºàÂçïÈÄâÊ®°ÂºèÔºâ
            quickTagList = [];
            (allScreenshots[selectedProject] || []).forEach(file => {
                quickTagList.push({ project: selectedProject, file });
            });
            
            if (quickTagList.length === 0) {
                showToast('Ê≤°ÊúâÂèØÊ†áÊ≥®ÁöÑÊà™Âõæ');
                return;
            }
            
            quickTagIndex = 0;
            document.getElementById('quick-tag-view').classList.add('active');
            renderQuickTag();
        }
        
        function closeQuickTagMode() {
            document.getElementById('quick-tag-view').classList.remove('active');
        }
        
        function renderQuickTag() {
            const item = quickTagList[quickTagIndex];
            if (!item) return;
            
            // Êõ¥Êñ∞ÂõæÁâá
            document.getElementById('quick-tag-image').src = 
                `/api/screenshot/${item.project}/screens/${item.file}`;
            
            // Êõ¥Êñ∞ËøõÂ∫¶
            document.getElementById('quick-tag-progress').textContent = 
                `${quickTagIndex + 1} / ${quickTagList.length} (${item.project.replace('_Analysis', '')})`;
            
            // Ê∏≤ÊüìÊ†áÁ≠æÈÄâÈ°π
            const currentTags = getScreenshotTags(item.project, item.file);
            let html = '';
            let keyIndex = 1;
            
            Object.entries(tagLibrary).forEach(([category, tags]) => {
                html += `
                    <div class="quick-tag-section">
                        <h4>${category}</h4>
                        <div class="quick-tag-options">
                            ${tags.map(tag => {
                                const key = keyIndex <= 9 ? keyIndex++ : null;
                                return `
                                    <div class="quick-tag-btn ${currentTags.includes(tag) ? 'selected' : ''}" 
                                         onclick="toggleQuickTag('${tag}')"
                                         data-tag="${tag}">
                                        ${tag}${key ? `<kbd>${key}</kbd>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('quick-tag-sections').innerHTML = html;
        }
        
        async function toggleQuickTag(tag) {
            const item = quickTagList[quickTagIndex];
            if (!item) return;
            
            let tags = [...getScreenshotTags(item.project, item.file)];
            const idx = tags.indexOf(tag);
            if (idx === -1) {
                tags.push(tag);
            } else {
                tags.splice(idx, 1);
            }
            
            // ‰øùÂ≠ò
            await fetch(`/api/tags/${item.project}/${item.file}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tags })
            });
            
            // Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠ò
            if (!projectTags[item.project]) projectTags[item.project] = {};
            projectTags[item.project][item.file] = tags;
            
            renderQuickTag();
        }
        
        function quickTagPrev() {
            if (quickTagIndex > 0) {
                quickTagIndex--;
                renderQuickTag();
            }
        }
        
        function quickTagNext() {
            if (quickTagIndex < quickTagList.length - 1) {
                quickTagIndex++;
                renderQuickTag();
            } else {
                showToast('Â∑≤Ê†áÊ≥®ÂÆåÊâÄÊúâÊà™ÂõæÔºÅ');
                closeQuickTagMode();
                updateCanvas();
            }
        }
        
        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // È¢ÑËßàÈù¢ÊùøÂø´Êç∑ÈîÆÔºà‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºâ
                if (previewPanelOpen) {
                    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        previewPrev();
                        return;
                    }
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        previewNext();
                        return;
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        closePreviewPanel();
                        return;
                    }
                }
                
                // Âø´ÈÄüÊ†áÊ≥®Ê®°ÂºèÁöÑÂø´Êç∑ÈîÆ
                if (document.getElementById('quick-tag-view').classList.contains('active')) {
                    if (e.key >= '1' && e.key <= '9') {
                        const allTags = Object.values(tagLibrary).flat();
                        const idx = parseInt(e.key) - 1;
                        if (idx < allTags.length) {
                            toggleQuickTag(allTags[idx]);
                        }
                    }
                    if (e.key === 'ArrowLeft') quickTagPrev();
                    if (e.key === 'ArrowRight') quickTagNext();
                    if (e.key === 'Escape') closeQuickTagMode();
                }
            });
        }
        
        // ===== Toast =====
        // ToastÂèåËØ≠Êò†Â∞Ñ
        const toastMessages = {
            'ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅ': 'ËØ∑ÂÖàÈÄâÊã©‰∫ßÂìÅ / Please select a product first',
            'Ê≤°ÊúâÂèØÊ†áÊ≥®ÁöÑÊà™Âõæ': 'Ê≤°ÊúâÂèØÊ†áÊ≥®ÁöÑÊà™Âõæ / No screenshots to tag',
            'Â∑≤Ê∑ªÂä†': 'Â∑≤Ê∑ªÂä† / Added',
            'Â∑≤Âú®ÁîªÂ∏É‰∏≠': 'Â∑≤Âú®ÁîªÂ∏É‰∏≠ / Already in canvas',
            'ÂàõÂª∫ÊàêÂäü': 'ÂàõÂª∫ÊàêÂäü / Created successfully',
            'ÂºÄÂßã‰∏ãËΩΩ...': 'ÂºÄÂßã‰∏ãËΩΩ... / Downloading...',
            'È°πÁõÆÂêç‰∏çËÉΩ‰∏∫Á©∫': 'È°πÁõÆÂêç‰∏çËÉΩ‰∏∫Á©∫ / Name cannot be empty',
            'ËØ∑ËæìÂÖ•ÊúâÊïàURL': 'ËØ∑ËæìÂÖ•ÊúâÊïàURL / Invalid URL',
            'Ê†áÁ≠æÂ∑≤‰øùÂ≠ò': 'Ê†áÁ≠æÂ∑≤‰øùÂ≠ò / Tags saved',
            'Êìç‰ΩúÊàêÂäü': 'Êìç‰ΩúÊàêÂäü / Success',
            'ÈááÈõÜÂÆåÊàê': 'ÈááÈõÜÂÆåÊàê / Collection completed',
            'È°πÁõÆÂ∑≤ÂàõÂª∫': 'È°πÁõÆÂ∑≤ÂàõÂª∫ / Project created',
            'ËØ∑ËæìÂÖ•ÂêçÁß∞': 'ËØ∑ËæìÂÖ•ÂêçÁß∞ / Please enter a name',
            'ËØ∑ËæìÂÖ•URLÂπ∂ÈÄâÊã©ÁõÆÊ†áÈ°πÁõÆ': 'ËØ∑ËæìÂÖ•URLÂπ∂ÈÄâÊã©ÁõÆÊ†áÈ°πÁõÆ / Enter URL and select project',
            'ÂØºÂá∫ÊàêÂäü': 'ÂØºÂá∫ÊàêÂäü / Export successful',
            'ÂàÜÊûêÊï∞ÊçÆÂ∑≤Âà∑Êñ∞': 'ÂàÜÊûêÊï∞ÊçÆÂ∑≤Âà∑Êñ∞ / Analysis data refreshed'
        };
        
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = toastMessages[msg] || msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // ===== Âè≥‰æßÈ¢ÑËßàÈù¢Êùø =====
        
        function openPreviewPanel(project, fileIndex) {
            // Â¶ÇÊûúÂàáÊç¢‰∫ßÂìÅÔºåÊ∏ÖÁ©∫ÁºìÂ≠ò
            if (currentPreviewProject !== project) {
                preloadedImages.clear();
            }
            
            currentPreviewProject = project;
            
            // ÊûÑÂª∫ÂΩìÂâçÊµèËßàÂàóË°®ÔºàÊ†πÊçÆÁ≠õÈÄâÁä∂ÊÄÅÔºâ
            const screens = allScreenshots[project] || [];
            currentPreviewList = activeTagFilters.length > 0
                ? screens.filter(f => matchesTagFilter(project, f))
                : screens;
            
            // ÊâæÂà∞ÁÇπÂáªÁöÑÊñá‰ª∂Âú®ÂàóË°®‰∏≠ÁöÑ‰ΩçÁΩÆ
            const clickedFile = screens[fileIndex];
            currentPreviewIndex = currentPreviewList.indexOf(clickedFile);
            if (currentPreviewIndex === -1) currentPreviewIndex = 0;
            
            // ÊòæÁ§∫Èù¢Êùø
            document.getElementById('preview-panel').classList.add('active');
            document.querySelector('.main').classList.add('preview-active');
            previewPanelOpen = true;
            
            // ÊòæÁ§∫Âø´Êç∑ÈîÆÊèêÁ§∫
            document.getElementById('keyboard-hint').style.display = 'block';
            
            // Ê∏≤ÊüìÂΩìÂâçÊà™Âõæ
            renderPreviewPanel();
            
            // È¢ÑÂä†ËΩΩÁõ∏ÈÇªÂõæÁâá
            preloadAdjacentImages();
        }
        
        // TabÂàáÊç¢ÂáΩÊï∞
        function switchPreviewTab(tabId) {
            // Êõ¥Êñ∞TabÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.preview-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            // Êõ¥Êñ∞TabÂÜÖÂÆπÊòæÁ§∫
            document.querySelectorAll('.preview-tab-pane').forEach(pane => {
                pane.classList.toggle('active', pane.id === `tab-${tabId}`);
                pane.style.display = pane.id === `tab-${tabId}` ? 'block' : 'none';
            });
        }
        
        function renderPreviewPanel() {
            if (!currentPreviewProject || currentPreviewIndex < 0 || !currentPreviewList.length) {
                console.warn('Invalid preview state:', {currentPreviewProject, currentPreviewIndex, listLength: currentPreviewList.length});
                return;
            }
            
            const file = currentPreviewList[currentPreviewIndex];
            if (!file) {
                console.error('No file at index:', currentPreviewIndex);
                return;
            }
            
            const allScreens = allScreenshots[currentPreviewProject] || [];
            const actualIndex = allScreens.indexOf(file);
            const desc = getScreenshotDescription(currentPreviewProject, file);
            const tags = getScreenshotTags(currentPreviewProject, file);
            const phase = file.split('_').slice(0, 2).join('_');
            const typeInfo = getPageTypeInfo(phase);
            const phaseName = `${typeInfo.icon} ${typeInfo.cn}`;
            
            // Ëé∑ÂèñÁªìÊûÑÂåñÊï∞ÊçÆ
            const structured = getStructuredDescription(currentPreviewProject, file);
            const naming = structured?.naming || {};
            const coreFunc = structured?.core_function || {};
            const highlights = structured?.design_highlights || [];
            const insight = structured?.product_insight || {};
            const structuredTags = structured?.tags || [];
            
            console.log('Rendering preview:', {file, actualIndex, phase, structured});
            
            // È´ò‰∫ÆÂ∑¶‰æßÂØπÂ∫îÁöÑÂç°Áâá
            syncLeftSideHighlight(file);
            
            // Êõ¥Êñ∞ÂõæÁâáÔºà‰ºòÂåñÂä†ËΩΩÔºåÈò≤Ê≠¢Á´ûÊÄÅÔºâ
            const img = document.getElementById('preview-panel-img');
            const loading = document.getElementById('preview-loading');
            const newSrc = `/api/thumb/${currentPreviewProject}/screens/${file}?size=large`;
            
            // ËÆ∞ÂΩïÂΩìÂâçÂä†ËΩΩÁöÑÂõæÁâá
            currentLoadingImageSrc = newSrc;
            
            // Â¶ÇÊûúÂõæÁâáÂ∑≤È¢ÑÂä†ËΩΩÔºàÂú®ÁºìÂ≠ò‰∏≠ÔºâÔºåÁõ¥Êé•ÊòæÁ§∫ÔºåÊó†ÈúÄÊ∑°ÂÖ•
            if (preloadedImages.has(newSrc)) {
                img.src = newSrc;
                img.style.opacity = '1';
                if (loading) loading.style.display = 'none';
            } else {
                // Êú™ÁºìÂ≠òÁöÑÂõæÁâáÔºöÊòæÁ§∫loadingÔºåÊ∑°ÂÖ•ÊïàÊûú
                if (loading) loading.style.display = 'block';
                img.style.opacity = '0';
                
                img.src = newSrc;
                
                img.onload = () => {
                    if (currentLoadingImageSrc !== newSrc) return;
                    if (loading) loading.style.display = 'none';
                    img.style.opacity = '1';
                    preloadedImages.add(newSrc);
                };
                
                img.onerror = () => {
                    if (currentLoadingImageSrc !== newSrc) return;
                    const fallbackSrc = `/api/thumb/${currentPreviewProject}/screens/${file}?size=medium`;
                    currentLoadingImageSrc = fallbackSrc;
                    img.src = fallbackSrc;
                    img.onload = () => { 
                        if (currentLoadingImageSrc !== fallbackSrc) return;
                        if (loading) loading.style.display = 'none';
                        img.style.opacity = '1'; 
                        preloadedImages.add(fallbackSrc);
                    };
                };
            }
            
            // Êõ¥Êñ∞Â§¥ÈÉ®‰ø°ÊÅØ
            document.getElementById('preview-panel-num').textContent = `#${actualIndex + 1}`;
            document.getElementById('preview-panel-phase').textContent = phaseName;
            
            // Êõ¥Êñ∞Ê¶ÇËßàTab
            const namingEl = document.getElementById('preview-panel-naming');
            if (namingEl) {
                const namingText = naming.cn && naming.en 
                    ? `${naming.cn} / ${naming.en}`
                    : naming.cn || naming.en || '';
                namingEl.textContent = namingText;
            }
            document.getElementById('preview-panel-desc').textContent = coreFunc.cn || desc;
            document.getElementById('preview-panel-filename').textContent = file;
            
            // Êõ¥Êñ∞ËÆæËÆ°ÂàÜÊûêTab
            const coreFuncEl = document.getElementById('preview-core-function');
            if (coreFuncEl) {
                coreFuncEl.innerHTML = coreFunc.cn 
                    ? `<div style="margin-bottom:4px;">${coreFunc.cn}</div><div style="font-size:12px;color:#6b7280;">${coreFunc.en || ''}</div>`
                    : `<div style="color:#6b7280;">ÊöÇÊó†ÂàÜÊûêÊï∞ÊçÆ</div>`;
            }
            
            const highlightsEl = document.getElementById('preview-highlights');
            if (highlightsEl) {
                if (highlights.length > 0) {
                    highlightsEl.innerHTML = highlights.map(h => `
                        <div class="highlight-item ${h.category || 'visual'}">
                            <div class="highlight-category">${getCategoryLabel(h.category)}</div>
                            <div>${h.cn || ''}</div>
                            ${h.en ? `<div style="font-size:11px;color:#6b7280;margin-top:2px;">${h.en}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    highlightsEl.innerHTML = '<div style="color:#6b7280;font-size:13px;">ÊöÇÊó†ËÆæËÆ°‰∫ÆÁÇπÂàÜÊûê</div>';
                }
            }
            
            const insightEl = document.getElementById('preview-insight');
            if (insightEl) {
                if (insight.cn || insight.en) {
                    insightEl.innerHTML = `
                        <div>${insight.cn || ''}</div>
                        ${insight.en ? `<div style="font-size:12px;color:#9ca3af;margin-top:6px;">${insight.en}</div>` : ''}
                    `;
                } else {
                    insightEl.innerHTML = '<span style="color:#6b7280;">ÊöÇÊó†‰∫ßÂìÅÊ¥ûÂØü</span>';
                }
            }
            
            // Êõ¥Êñ∞Ê†áÁ≠æTab
            const tagsListEl = document.getElementById('preview-panel-tags-list');
            if (tagsListEl) {
                // ÂêàÂπ∂Áî®Êà∑Ê†áÁ≠æÂíåAIÊ†áÁ≠æ
                let allTagsHtml = '';
                
                // Áî®Êà∑Ëá™ÂÆö‰πâÊ†áÁ≠æ
                if (tags.length > 0) {
                    allTagsHtml += tags.map(t => `<span class="tag" style="padding:6px 12px;background:rgba(94,106,210,0.15);color:#a5b4fc;border-radius:6px;font-size:12px;">${t}</span>`).join('');
                }
                
                // AIËØÜÂà´ÁöÑÂèåËØ≠Ê†áÁ≠æ
                if (structuredTags.length > 0) {
                    allTagsHtml += structuredTags.map(t => `
                        <span class="tag" style="padding:6px 12px;background:rgba(139,92,246,0.15);color:#c4b5fd;border-radius:6px;font-size:12px;">
                            ${t.cn || ''} ${t.en ? '/ ' + t.en : ''}
                        </span>
                    `).join('');
                }
                
                tagsListEl.innerHTML = allTagsHtml || '<span style="color:#6b7280;font-size:13px;">ÊöÇÊó†Ê†áÁ≠æ</span>';
            }
            
            // Êõ¥Êñ∞ËÆ°Êï∞Âô®
            document.getElementById('preview-counter').textContent = 
                `${currentPreviewIndex + 1} / ${currentPreviewList.length}`;
            
            // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
            document.getElementById('preview-prev-btn').disabled = currentPreviewIndex === 0;
            document.getElementById('preview-next-btn').disabled = 
                currentPreviewIndex === currentPreviewList.length - 1;
        }
        
        // Ëé∑ÂèñËÆæËÆ°‰∫ÆÁÇπÁ±ªÂà´Ê†áÁ≠æ
        function getCategoryLabel(category) {
            const labels = {
                'visual': 'üñºÔ∏è ËßÜËßâËÆæËÆ° / Visual',
                'interaction': 'üëÜ ‰∫§‰∫íËÆæËÆ° / Interaction',
                'conversion': 'üí∞ ËΩ¨ÂåñÁ≠ñÁï• / Conversion',
                'emotional': 'üíñ ÊÉÖÊÑüÂåñËÆæËÆ° / Emotional'
            };
            return labels[category] || category || 'Design';
        }
        
        // Èò≤ÊäñÔºöÈÅøÂÖçÂø´ÈÄüÂàáÊç¢Êó∂ÁöÑÈáçÂ§çÊ∏≤Êüì
        let previewRenderTimeout = null;
        
        function previewPrev() {
            if (currentPreviewIndex > 0) {
                currentPreviewIndex--;
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑÊ∏≤ÊüìËÆ°Âàí
                if (previewRenderTimeout) clearTimeout(previewRenderTimeout);
                
                // Á´ãÂç≥Ê∏≤ÊüìÔºà‰∏çÂª∂ËøüÔºå‰øùËØÅÂìçÂ∫îÈÄüÂ∫¶Ôºâ
                renderPreviewPanel();
                
                // Âª∂ËøüÈ¢ÑÂä†ËΩΩÔºàÈÅøÂÖçÈòªÂ°ûÊ∏≤ÊüìÔºâ
                previewRenderTimeout = setTimeout(() => {
                    preloadAdjacentImages();
                }, 300);
            }
        }
        
        function previewNext() {
            if (currentPreviewIndex < currentPreviewList.length - 1) {
                currentPreviewIndex++;
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑÊ∏≤ÊüìËÆ°Âàí
                if (previewRenderTimeout) clearTimeout(previewRenderTimeout);
                
                // Á´ãÂç≥Ê∏≤Êüì
                renderPreviewPanel();
                
                // Âª∂ËøüÈ¢ÑÂä†ËΩΩ
                previewRenderTimeout = setTimeout(() => {
                    preloadAdjacentImages();
                }, 300);
            }
        }
        
        function closePreviewPanel() {
            document.getElementById('preview-panel').classList.remove('active');
            document.querySelector('.main').classList.remove('preview-active');
            previewPanelOpen = false;
            currentPreviewProject = null;
            currentPreviewList = [];
            currentPreviewIndex = 0;
            
            // ÈöêËóèÂø´Êç∑ÈîÆÊèêÁ§∫
            document.getElementById('keyboard-hint').style.display = 'none';
            
            // ÁßªÈô§Â∑¶‰æßÊâÄÊúâÈ´ò‰∫Æ
            document.querySelectorAll('.card-compact.previewing, .card-standard.previewing, .card-large.previewing').forEach(el => {
                el.classList.remove('previewing');
            });
            
            // Ê∏ÖÈô§pendingÁöÑÊ∏≤ÊüìÂíåÈ¢ÑÂä†ËΩΩ
            if (previewRenderTimeout) {
                clearTimeout(previewRenderTimeout);
                previewRenderTimeout = null;
            }
            
            // Ê∏ÖÁ©∫È¢ÑÂä†ËΩΩÁºìÂ≠òÔºàËäÇÁúÅÂÜÖÂ≠òÔºâ
            preloadedImages.clear();
            
            // Ê∏ÖÁ©∫ÂõæÁâáÂíåloadingÁä∂ÊÄÅ
            const img = document.getElementById('preview-panel-img');
            img.src = '';
            img.style.opacity = '1';
            
            const loading = document.getElementById('preview-loading');
            if (loading) loading.style.display = 'none';
        }
        
        function syncLeftSideHighlight(filename) {
            // ÁßªÈô§ÊâÄÊúâ‰πãÂâçÁöÑÈ´ò‰∫Æ
            document.querySelectorAll('.card-compact.previewing, .card-standard.previewing, .card-large.previewing').forEach(el => {
                el.classList.remove('previewing');
            });
            
            // Êü•ÊâæÂπ∂È´ò‰∫ÆÂΩìÂâçÊñá‰ª∂ÂØπÂ∫îÁöÑÂç°ÁâáÔºàÈÄöËøádata-fileÂ±ûÊÄßÁ≤æÁ°ÆÂåπÈÖçÔºâ
            const targetCard = document.querySelector(`[data-file="${filename}"]`);
            if (targetCard) {
                targetCard.classList.add('previewing');
                // Âπ≥ÊªëÊªöÂä®Âà∞ÂèØËßÜÂå∫ÂüüÔºà‰∏çÂº∫Âà∂Â±Ö‰∏≠Ôºå‰øùÊåÅËá™ÁÑ∂ÊÑüÔºâ
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
            } else {
                console.warn('Cannot find card for file:', filename);
            }
        }
        
        function preloadAdjacentImages() {
            if (!currentPreviewProject || !currentPreviewList.length) return;
            
            const range = 2;  // ÂáèÂ∞ëÈ¢ÑÂä†ËΩΩËåÉÂõ¥ÔºåÊèêÂçáÊÄßËÉΩ
            for (let i = -range; i <= range; i++) {
                const idx = currentPreviewIndex + i;
                if (idx >= 0 && idx < currentPreviewList.length && idx !== currentPreviewIndex) {
                    const file = currentPreviewList[idx];
                    const imgSrc = `/api/thumb/${currentPreviewProject}/screens/${file}?size=large`;
                    
                    // ÈÅøÂÖçÈáçÂ§çÈ¢ÑÂä†ËΩΩ
                    if (!preloadedImages.has(imgSrc)) {
                        const img = new Image();
                        img.onload = () => {
                            preloadedImages.add(imgSrc);
                        };
                        img.onerror = () => {
                            console.warn('Preload failed:', imgSrc);
                        };
                        img.src = imgSrc;
                    }
                }
            }
        }
        
        function editPreviewTags() {
            if (!currentPreviewProject || currentPreviewIndex < 0) return;
            const file = currentPreviewList[currentPreviewIndex];
            openTagSelector(currentPreviewProject, file);
        }

        // ===== Ê≠•È™§Ê†áÊ≥® =====
        function getScreenshotStep(project, filename) {
            return (projectSteps[project] && projectSteps[project][filename]) || null;
        }

        async function openStepPrompt(project, filename) {
            const current = getScreenshotStep(project, filename);
            const input = prompt('ËÆæÁΩÆÊ≠•È™§ÁºñÂè∑ÔºàÊ≠£Êï¥Êï∞ÔºåÁïôÁ©∫Âà†Èô§Ôºâ', current || '');
            if (input === null) return; // canceled
            let step = parseInt(input, 10);
            if (isNaN(step) || step <= 0) {
                // Âà†Èô§ËØ•Êñá‰ª∂ÁöÑÊ≠•È™§
                if (!projectSteps[project]) projectSteps[project] = {};
                delete projectSteps[project][filename];
            } else {
                if (!projectSteps[project]) projectSteps[project] = {};
                projectSteps[project][filename] = step;
            }
            await saveSteps(project);
            updateCanvas();
        }

        async function saveSteps(project) {
            const payload = projectSteps[project] || {};
            await fetch(`/api/steps/${project}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
        }
    </script>
</body>
</html>
