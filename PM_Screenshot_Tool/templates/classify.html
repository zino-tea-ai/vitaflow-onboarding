<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹åŠ¨åˆ†ç±»å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        
        .header { background: #16213e; padding: 16px 24px; border-bottom: 1px solid #2a2a4a; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; }
        .header select, .header button { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; }
        .header select { background: #2a2a4a; color: #fff; }
        .header button { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; cursor: pointer; }
        .header button:hover { opacity: 0.9; }
        .header .spacer { flex: 1; }
        .header .status { font-size: 13px; color: #888; }
        
        .container { display: flex; height: calc(100vh - 60px); }
        
        /* å·¦ä¾§ï¼šæœªåˆ†ç±»æˆªå›¾ */
        .unclassified { width: 300px; background: #16213e; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .unclassified h2 { padding: 16px; font-size: 14px; color: #888; border-bottom: 1px solid #2a2a4a; }
        .unclassified-list { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start; }
        .unclassified-item { aspect-ratio: 9/16; background: #2a2a4a; border-radius: 6px; overflow: hidden; cursor: grab; position: relative; }
        .unclassified-item:hover { outline: 2px solid #667eea; }
        .unclassified-item.selected { outline: 2px solid #f472b6; }
        .unclassified-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .unclassified-item .num { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        /* å³ä¾§ï¼šé˜¶æ®µåˆ†ç»„ */
        .phases { flex: 1; overflow-y: auto; padding: 20px; }
        .phase-group { background: #1f2937; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .phase-header { padding: 12px 16px; background: #2a3441; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .phase-header:hover { background: #3a4451; }
        .phase-icon { font-size: 20px; }
        .phase-name { flex: 1; font-weight: 600; }
        .phase-count { background: rgba(102,126,234,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .phase-content { padding: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 8px; align-content: start; border: 2px dashed transparent; transition: border-color 0.2s; }
        .phase-content.drag-over { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .phase-thumb { width: 60px; background: #2a2a4a; border-radius: 6px; overflow: hidden; position: relative; cursor: grab; }
        .phase-thumb:hover { outline: 2px solid #667eea; }
        .phase-thumb img { width: 100%; display: block; }
        .phase-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        .phase-thumb:hover .remove { display: flex; }
        .phase-empty { color: #555; font-size: 13px; width: 100%; text-align: center; padding: 20px; }
        
        /* å¿«æ·æ“ä½œæ  */
        .quick-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; }
        .quick-bar.show { display: flex; }
        .quick-bar span { font-size: 13px; color: #888; }
        .quick-bar button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .quick-bar .btn-assign { background: #667eea; color: #fff; }
        .quick-bar .btn-cancel { background: #4b5563; color: #fff; }
        
        /* é¢„è§ˆ */
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .preview-modal.active { display: flex; }
        .preview-modal img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        .preview-modal .close { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #fff; cursor: pointer; background: none; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ æ‰‹åŠ¨åˆ†ç±»å·¥å…·</h1>
        <select id="project-select" onchange="loadProject()">
            <option value="">é€‰æ‹©äº§å“...</option>
        </select>
        <div class="spacer"></div>
        <span class="status" id="status">é€‰æ‹©äº§å“å¼€å§‹åˆ†ç±»</span>
        <button onclick="saveClassification()">ğŸ’¾ ä¿å­˜åˆ†ç±»</button>
        <button onclick="window.location.href='/'">â† è¿”å›</button>
    </div>
    
    <div class="container">
        <div class="unclassified">
            <h2>æœªåˆ†ç±»æˆªå›¾ (<span id="unclassified-count">0</span>)</h2>
            <div class="unclassified-list" id="unclassified-list"></div>
        </div>
        
        <div class="phases" id="phases"></div>
    </div>
    
    <div class="quick-bar" id="quick-bar">
        <span>å·²é€‰ <strong id="selected-count">0</strong> å¼ </span>
        <select id="target-phase">
            <option value="">åˆ†é…åˆ°...</option>
        </select>
        <button class="btn-assign" onclick="assignSelected()">åˆ†é…</button>
        <button class="btn-cancel" onclick="clearSelection()">å–æ¶ˆ</button>
    </div>
    
    <div class="preview-modal" id="preview-modal" onclick="closePreview()">
        <button class="close">Ã—</button>
        <img id="preview-img" src="">
    </div>

    <script>
        // é˜¶æ®µå®šä¹‰
        const PHASES = [
            { id: '01_Launch', name: 'å¯åŠ¨é¡µ', icon: 'ğŸš€' },
            { id: '02_Welcome', name: 'æ¬¢è¿/ä»·å€¼ä¸»å¼ ', icon: 'ğŸ‘‹' },
            { id: '03_Auth', name: 'æ³¨å†Œ/ç™»å½•', icon: 'ğŸ”' },
            { id: '04_Goals', name: 'ç›®æ ‡è®¾ç½®', icon: 'ğŸ¯' },
            { id: '05_Profile', name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ‘¤' },
            { id: '06_Activity', name: 'æ´»åŠ¨æ°´å¹³', icon: 'ğŸƒ' },
            { id: '07_Preference', name: 'åå¥½è®¾ç½®', icon: 'âš™ï¸' },
            { id: '08_Motivation', name: 'æ¿€åŠ±/é¢„æœŸ', icon: 'ğŸ’ª' },
            { id: '09_Permissions', name: 'æƒé™è¯·æ±‚', icon: 'ğŸ””' },
            { id: '10_Paywall', name: 'ä»˜è´¹å¢™', icon: 'ğŸ’°' },
            { id: '11_Home', name: 'é¦–é¡µ/ä»ªè¡¨ç›˜', icon: 'ğŸ ' },
            { id: '12_Logging', name: 'è®°å½•åŠŸèƒ½', icon: 'ğŸ“' },
            { id: '13_Stats', name: 'ç»Ÿè®¡/æŠ¥è¡¨', icon: 'ğŸ“Š' },
            { id: '14_Features', name: 'å…¶ä»–åŠŸèƒ½', icon: 'âœ¨' },
            { id: '15_Social', name: 'ç¤¾äº¤åŠŸèƒ½', icon: 'ğŸ‘¥' },
            { id: '16_Settings', name: 'è®¾ç½®/è´¦æˆ·', icon: 'âš™ï¸' },
        ];
        
        let currentProject = '';
        let allScreens = [];
        let classification = {}; // { phaseId: [filename, ...] }
        let selectedItems = new Set();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            const res = await fetch('/api/projects');
            const data = await res.json();
            const select = document.getElementById('project-select');
            data.projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name.replace('_Analysis', '');
                select.appendChild(opt);
            });
            
            // åˆå§‹åŒ–é˜¶æ®µé€‰æ‹©å™¨
            const targetPhase = document.getElementById('target-phase');
            PHASES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.icon} ${p.name}`;
                targetPhase.appendChild(opt);
            });
            
            // æ¸²æŸ“é˜¶æ®µé¢æ¿
            renderPhases();
        });
        
        async function loadProject() {
            currentProject = document.getElementById('project-select').value;
            if (!currentProject) return;
            
            // åŠ è½½æˆªå›¾
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            allScreens = data.downloads || [];
            
            // åˆå§‹åŒ–åˆ†ç±»ï¼ˆå…¨éƒ¨æœªåˆ†ç±»ï¼‰
            classification = {};
            PHASES.forEach(p => classification[p.id] = []);
            
            // å°è¯•åŠ è½½å·²æœ‰åˆ†ç±»
            await loadExistingClassification();
            
            renderAll();
            updateStatus();
        }
        
        async function loadExistingClassification() {
            // æ£€æŸ¥Screensç›®å½•æ˜¯å¦æœ‰å·²åˆ†ç±»çš„æ–‡ä»¶
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            
            if (data.screens && data.screens.length > 0) {
                // è§£æå·²æœ‰åˆ†ç±»
                data.screens.forEach(filename => {
                    const parts = filename.split('_');
                    if (parts.length >= 2) {
                        const phaseId = `${parts[0]}_${parts[1]}`;
                        if (classification[phaseId]) {
                            // æ‰¾åˆ°å¯¹åº”çš„åŸå§‹æ–‡ä»¶
                            const step = parseInt(parts[2]) || 1;
                            const origFile = `Screen_${String(step).padStart(3, '0')}.png`;
                            if (allScreens.includes(origFile) && !classification[phaseId].includes(origFile)) {
                                classification[phaseId].push(origFile);
                            }
                        }
                    }
                });
            }
        }
        
        function renderPhases() {
            const container = document.getElementById('phases');
            container.innerHTML = PHASES.map(phase => `
                <div class="phase-group" data-phase="${phase.id}">
                    <div class="phase-header">
                        <span class="phase-icon">${phase.icon}</span>
                        <span class="phase-name">${phase.name}</span>
                        <span class="phase-count" id="count-${phase.id}">0</span>
                    </div>
                    <div class="phase-content" 
                         id="phase-${phase.id}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${phase.id}')">
                        <div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderAll() {
            renderUnclassified();
            renderClassified();
        }
        
        function renderUnclassified() {
            // æ‰¾å‡ºæœªåˆ†ç±»çš„
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            const unclassified = allScreens.filter(f => !classified.has(f));
            
            document.getElementById('unclassified-count').textContent = unclassified.length;
            
            const list = document.getElementById('unclassified-list');
            list.innerHTML = unclassified.map((file, idx) => {
                const num = file.match(/\d+/)?.[0] || idx;
                return `
                    <div class="unclassified-item ${selectedItems.has(file) ? 'selected' : ''}"
                         draggable="true"
                         data-file="${file}"
                         onclick="toggleSelect('${file}', event)"
                         ondblclick="openPreview('${file}')"
                         ondragstart="handleDragStart(event, '${file}')">
                        <img src="/api/thumb/${currentProject}/downloads/${file}" loading="lazy">
                        <span class="num">${num}</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderClassified() {
            PHASES.forEach(phase => {
                const items = classification[phase.id] || [];
                document.getElementById(`count-${phase.id}`).textContent = items.length;
                
                const container = document.getElementById(`phase-${phase.id}`);
                if (items.length === 0) {
                    container.innerHTML = '<div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>';
                } else {
                    container.innerHTML = items.map(file => `
                        <div class="phase-thumb" data-file="${file}" ondblclick="openPreview('${file}')">
                            <img src="/api/thumb/${currentProject}/downloads/${file}">
                            <div class="remove" onclick="removeFromPhase('${phase.id}', '${file}')">Ã—</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        // é€‰æ‹©
        function toggleSelect(file, event) {
            if (event.shiftKey && selectedItems.size > 0) {
                // Shiftå¤šé€‰
                const unclassified = getUnclassifiedList();
                const lastSelected = Array.from(selectedItems).pop();
                const startIdx = unclassified.indexOf(lastSelected);
                const endIdx = unclassified.indexOf(file);
                const [from, to] = startIdx < endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
                for (let i = from; i <= to; i++) {
                    selectedItems.add(unclassified[i]);
                }
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrlå•é€‰åˆ‡æ¢
                if (selectedItems.has(file)) {
                    selectedItems.delete(file);
                } else {
                    selectedItems.add(file);
                }
            } else {
                // æ™®é€šå•é€‰
                selectedItems.clear();
                selectedItems.add(file);
            }
            
            renderUnclassified();
            updateQuickBar();
        }
        
        function clearSelection() {
            selectedItems.clear();
            renderUnclassified();
            updateQuickBar();
        }
        
        function updateQuickBar() {
            const bar = document.getElementById('quick-bar');
            const count = selectedItems.size;
            document.getElementById('selected-count').textContent = count;
            bar.classList.toggle('show', count > 0);
        }
        
        function assignSelected() {
            const phaseId = document.getElementById('target-phase').value;
            if (!phaseId) { alert('è¯·é€‰æ‹©ç›®æ ‡é˜¶æ®µ'); return; }
            
            selectedItems.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                classification[phaseId].push(file);
            });
            
            selectedItems.clear();
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function getUnclassifiedList() {
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            return allScreens.filter(f => !classified.has(f));
        }
        
        // æ‹–æ‹½
        let draggedFile = '';
        
        function handleDragStart(event, file) {
            draggedFile = file;
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event, phaseId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedFile) return;
            
            // å¦‚æœæœ‰å¤šé€‰ï¼Œç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„
            const filesToMove = selectedItems.size > 0 && selectedItems.has(draggedFile) 
                ? Array.from(selectedItems) 
                : [draggedFile];
            
            filesToMove.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                if (!classification[phaseId].includes(file)) {
                    classification[phaseId].push(file);
                }
            });
            
            selectedItems.clear();
            draggedFile = '';
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function removeFromPhase(phaseId, file) {
            const idx = classification[phaseId].indexOf(file);
            if (idx > -1) {
                classification[phaseId].splice(idx, 1);
                renderAll();
                updateStatus();
            }
        }
        
        // é¢„è§ˆ
        function openPreview(file) {
            document.getElementById('preview-img').src = `/api/screenshot/${currentProject}/downloads/${file}`;
            document.getElementById('preview-modal').classList.add('active');
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
        }
        
        // çŠ¶æ€
        function updateStatus() {
            const total = allScreens.length;
            const classified = Object.values(classification).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('status').textContent = `å·²åˆ†ç±» ${classified}/${total} å¼ `;
        }
        
        // ä¿å­˜
        async function saveClassification() {
            if (!currentProject) { alert('è¯·å…ˆé€‰æ‹©äº§å“'); return; }
            
            // æ„å»ºåˆ†ç±»æ•°æ®
            const data = { project: currentProject, classification: {} };
            
            PHASES.forEach(phase => {
                const files = classification[phase.id] || [];
                files.forEach((file, idx) => {
                    const newName = `${phase.id}_${String(idx + 1).padStart(2, '0')}.png`;
                    data.classification[file] = newName;
                });
            });
            
            // å‘é€åˆ°åç«¯
            const res = await fetch('/api/save-classification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²åˆ†ç±» ${result.count} å¼ æˆªå›¾`);
            } else {
                alert(`âŒ ä¿å­˜å¤±è´¥: ${result.error}`);
            }
        }
    </script>
</body>
</html>






<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹åŠ¨åˆ†ç±»å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        
        .header { background: #16213e; padding: 16px 24px; border-bottom: 1px solid #2a2a4a; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; }
        .header select, .header button { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; }
        .header select { background: #2a2a4a; color: #fff; }
        .header button { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; cursor: pointer; }
        .header button:hover { opacity: 0.9; }
        .header .spacer { flex: 1; }
        .header .status { font-size: 13px; color: #888; }
        
        .container { display: flex; height: calc(100vh - 60px); }
        
        /* å·¦ä¾§ï¼šæœªåˆ†ç±»æˆªå›¾ */
        .unclassified { width: 300px; background: #16213e; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .unclassified h2 { padding: 16px; font-size: 14px; color: #888; border-bottom: 1px solid #2a2a4a; }
        .unclassified-list { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start; }
        .unclassified-item { aspect-ratio: 9/16; background: #2a2a4a; border-radius: 6px; overflow: hidden; cursor: grab; position: relative; }
        .unclassified-item:hover { outline: 2px solid #667eea; }
        .unclassified-item.selected { outline: 2px solid #f472b6; }
        .unclassified-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .unclassified-item .num { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        /* å³ä¾§ï¼šé˜¶æ®µåˆ†ç»„ */
        .phases { flex: 1; overflow-y: auto; padding: 20px; }
        .phase-group { background: #1f2937; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .phase-header { padding: 12px 16px; background: #2a3441; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .phase-header:hover { background: #3a4451; }
        .phase-icon { font-size: 20px; }
        .phase-name { flex: 1; font-weight: 600; }
        .phase-count { background: rgba(102,126,234,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .phase-content { padding: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 8px; align-content: start; border: 2px dashed transparent; transition: border-color 0.2s; }
        .phase-content.drag-over { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .phase-thumb { width: 60px; background: #2a2a4a; border-radius: 6px; overflow: hidden; position: relative; cursor: grab; }
        .phase-thumb:hover { outline: 2px solid #667eea; }
        .phase-thumb img { width: 100%; display: block; }
        .phase-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        .phase-thumb:hover .remove { display: flex; }
        .phase-empty { color: #555; font-size: 13px; width: 100%; text-align: center; padding: 20px; }
        
        /* å¿«æ·æ“ä½œæ  */
        .quick-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; }
        .quick-bar.show { display: flex; }
        .quick-bar span { font-size: 13px; color: #888; }
        .quick-bar button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .quick-bar .btn-assign { background: #667eea; color: #fff; }
        .quick-bar .btn-cancel { background: #4b5563; color: #fff; }
        
        /* é¢„è§ˆ */
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .preview-modal.active { display: flex; }
        .preview-modal img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        .preview-modal .close { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #fff; cursor: pointer; background: none; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ æ‰‹åŠ¨åˆ†ç±»å·¥å…·</h1>
        <select id="project-select" onchange="loadProject()">
            <option value="">é€‰æ‹©äº§å“...</option>
        </select>
        <div class="spacer"></div>
        <span class="status" id="status">é€‰æ‹©äº§å“å¼€å§‹åˆ†ç±»</span>
        <button onclick="saveClassification()">ğŸ’¾ ä¿å­˜åˆ†ç±»</button>
        <button onclick="window.location.href='/'">â† è¿”å›</button>
    </div>
    
    <div class="container">
        <div class="unclassified">
            <h2>æœªåˆ†ç±»æˆªå›¾ (<span id="unclassified-count">0</span>)</h2>
            <div class="unclassified-list" id="unclassified-list"></div>
        </div>
        
        <div class="phases" id="phases"></div>
    </div>
    
    <div class="quick-bar" id="quick-bar">
        <span>å·²é€‰ <strong id="selected-count">0</strong> å¼ </span>
        <select id="target-phase">
            <option value="">åˆ†é…åˆ°...</option>
        </select>
        <button class="btn-assign" onclick="assignSelected()">åˆ†é…</button>
        <button class="btn-cancel" onclick="clearSelection()">å–æ¶ˆ</button>
    </div>
    
    <div class="preview-modal" id="preview-modal" onclick="closePreview()">
        <button class="close">Ã—</button>
        <img id="preview-img" src="">
    </div>

    <script>
        // é˜¶æ®µå®šä¹‰
        const PHASES = [
            { id: '01_Launch', name: 'å¯åŠ¨é¡µ', icon: 'ğŸš€' },
            { id: '02_Welcome', name: 'æ¬¢è¿/ä»·å€¼ä¸»å¼ ', icon: 'ğŸ‘‹' },
            { id: '03_Auth', name: 'æ³¨å†Œ/ç™»å½•', icon: 'ğŸ”' },
            { id: '04_Goals', name: 'ç›®æ ‡è®¾ç½®', icon: 'ğŸ¯' },
            { id: '05_Profile', name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ‘¤' },
            { id: '06_Activity', name: 'æ´»åŠ¨æ°´å¹³', icon: 'ğŸƒ' },
            { id: '07_Preference', name: 'åå¥½è®¾ç½®', icon: 'âš™ï¸' },
            { id: '08_Motivation', name: 'æ¿€åŠ±/é¢„æœŸ', icon: 'ğŸ’ª' },
            { id: '09_Permissions', name: 'æƒé™è¯·æ±‚', icon: 'ğŸ””' },
            { id: '10_Paywall', name: 'ä»˜è´¹å¢™', icon: 'ğŸ’°' },
            { id: '11_Home', name: 'é¦–é¡µ/ä»ªè¡¨ç›˜', icon: 'ğŸ ' },
            { id: '12_Logging', name: 'è®°å½•åŠŸèƒ½', icon: 'ğŸ“' },
            { id: '13_Stats', name: 'ç»Ÿè®¡/æŠ¥è¡¨', icon: 'ğŸ“Š' },
            { id: '14_Features', name: 'å…¶ä»–åŠŸèƒ½', icon: 'âœ¨' },
            { id: '15_Social', name: 'ç¤¾äº¤åŠŸèƒ½', icon: 'ğŸ‘¥' },
            { id: '16_Settings', name: 'è®¾ç½®/è´¦æˆ·', icon: 'âš™ï¸' },
        ];
        
        let currentProject = '';
        let allScreens = [];
        let classification = {}; // { phaseId: [filename, ...] }
        let selectedItems = new Set();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            const res = await fetch('/api/projects');
            const data = await res.json();
            const select = document.getElementById('project-select');
            data.projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name.replace('_Analysis', '');
                select.appendChild(opt);
            });
            
            // åˆå§‹åŒ–é˜¶æ®µé€‰æ‹©å™¨
            const targetPhase = document.getElementById('target-phase');
            PHASES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.icon} ${p.name}`;
                targetPhase.appendChild(opt);
            });
            
            // æ¸²æŸ“é˜¶æ®µé¢æ¿
            renderPhases();
        });
        
        async function loadProject() {
            currentProject = document.getElementById('project-select').value;
            if (!currentProject) return;
            
            // åŠ è½½æˆªå›¾
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            allScreens = data.downloads || [];
            
            // åˆå§‹åŒ–åˆ†ç±»ï¼ˆå…¨éƒ¨æœªåˆ†ç±»ï¼‰
            classification = {};
            PHASES.forEach(p => classification[p.id] = []);
            
            // å°è¯•åŠ è½½å·²æœ‰åˆ†ç±»
            await loadExistingClassification();
            
            renderAll();
            updateStatus();
        }
        
        async function loadExistingClassification() {
            // æ£€æŸ¥Screensç›®å½•æ˜¯å¦æœ‰å·²åˆ†ç±»çš„æ–‡ä»¶
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            
            if (data.screens && data.screens.length > 0) {
                // è§£æå·²æœ‰åˆ†ç±»
                data.screens.forEach(filename => {
                    const parts = filename.split('_');
                    if (parts.length >= 2) {
                        const phaseId = `${parts[0]}_${parts[1]}`;
                        if (classification[phaseId]) {
                            // æ‰¾åˆ°å¯¹åº”çš„åŸå§‹æ–‡ä»¶
                            const step = parseInt(parts[2]) || 1;
                            const origFile = `Screen_${String(step).padStart(3, '0')}.png`;
                            if (allScreens.includes(origFile) && !classification[phaseId].includes(origFile)) {
                                classification[phaseId].push(origFile);
                            }
                        }
                    }
                });
            }
        }
        
        function renderPhases() {
            const container = document.getElementById('phases');
            container.innerHTML = PHASES.map(phase => `
                <div class="phase-group" data-phase="${phase.id}">
                    <div class="phase-header">
                        <span class="phase-icon">${phase.icon}</span>
                        <span class="phase-name">${phase.name}</span>
                        <span class="phase-count" id="count-${phase.id}">0</span>
                    </div>
                    <div class="phase-content" 
                         id="phase-${phase.id}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${phase.id}')">
                        <div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderAll() {
            renderUnclassified();
            renderClassified();
        }
        
        function renderUnclassified() {
            // æ‰¾å‡ºæœªåˆ†ç±»çš„
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            const unclassified = allScreens.filter(f => !classified.has(f));
            
            document.getElementById('unclassified-count').textContent = unclassified.length;
            
            const list = document.getElementById('unclassified-list');
            list.innerHTML = unclassified.map((file, idx) => {
                const num = file.match(/\d+/)?.[0] || idx;
                return `
                    <div class="unclassified-item ${selectedItems.has(file) ? 'selected' : ''}"
                         draggable="true"
                         data-file="${file}"
                         onclick="toggleSelect('${file}', event)"
                         ondblclick="openPreview('${file}')"
                         ondragstart="handleDragStart(event, '${file}')">
                        <img src="/api/thumb/${currentProject}/downloads/${file}" loading="lazy">
                        <span class="num">${num}</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderClassified() {
            PHASES.forEach(phase => {
                const items = classification[phase.id] || [];
                document.getElementById(`count-${phase.id}`).textContent = items.length;
                
                const container = document.getElementById(`phase-${phase.id}`);
                if (items.length === 0) {
                    container.innerHTML = '<div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>';
                } else {
                    container.innerHTML = items.map(file => `
                        <div class="phase-thumb" data-file="${file}" ondblclick="openPreview('${file}')">
                            <img src="/api/thumb/${currentProject}/downloads/${file}">
                            <div class="remove" onclick="removeFromPhase('${phase.id}', '${file}')">Ã—</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        // é€‰æ‹©
        function toggleSelect(file, event) {
            if (event.shiftKey && selectedItems.size > 0) {
                // Shiftå¤šé€‰
                const unclassified = getUnclassifiedList();
                const lastSelected = Array.from(selectedItems).pop();
                const startIdx = unclassified.indexOf(lastSelected);
                const endIdx = unclassified.indexOf(file);
                const [from, to] = startIdx < endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
                for (let i = from; i <= to; i++) {
                    selectedItems.add(unclassified[i]);
                }
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrlå•é€‰åˆ‡æ¢
                if (selectedItems.has(file)) {
                    selectedItems.delete(file);
                } else {
                    selectedItems.add(file);
                }
            } else {
                // æ™®é€šå•é€‰
                selectedItems.clear();
                selectedItems.add(file);
            }
            
            renderUnclassified();
            updateQuickBar();
        }
        
        function clearSelection() {
            selectedItems.clear();
            renderUnclassified();
            updateQuickBar();
        }
        
        function updateQuickBar() {
            const bar = document.getElementById('quick-bar');
            const count = selectedItems.size;
            document.getElementById('selected-count').textContent = count;
            bar.classList.toggle('show', count > 0);
        }
        
        function assignSelected() {
            const phaseId = document.getElementById('target-phase').value;
            if (!phaseId) { alert('è¯·é€‰æ‹©ç›®æ ‡é˜¶æ®µ'); return; }
            
            selectedItems.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                classification[phaseId].push(file);
            });
            
            selectedItems.clear();
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function getUnclassifiedList() {
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            return allScreens.filter(f => !classified.has(f));
        }
        
        // æ‹–æ‹½
        let draggedFile = '';
        
        function handleDragStart(event, file) {
            draggedFile = file;
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event, phaseId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedFile) return;
            
            // å¦‚æœæœ‰å¤šé€‰ï¼Œç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„
            const filesToMove = selectedItems.size > 0 && selectedItems.has(draggedFile) 
                ? Array.from(selectedItems) 
                : [draggedFile];
            
            filesToMove.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                if (!classification[phaseId].includes(file)) {
                    classification[phaseId].push(file);
                }
            });
            
            selectedItems.clear();
            draggedFile = '';
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function removeFromPhase(phaseId, file) {
            const idx = classification[phaseId].indexOf(file);
            if (idx > -1) {
                classification[phaseId].splice(idx, 1);
                renderAll();
                updateStatus();
            }
        }
        
        // é¢„è§ˆ
        function openPreview(file) {
            document.getElementById('preview-img').src = `/api/screenshot/${currentProject}/downloads/${file}`;
            document.getElementById('preview-modal').classList.add('active');
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
        }
        
        // çŠ¶æ€
        function updateStatus() {
            const total = allScreens.length;
            const classified = Object.values(classification).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('status').textContent = `å·²åˆ†ç±» ${classified}/${total} å¼ `;
        }
        
        // ä¿å­˜
        async function saveClassification() {
            if (!currentProject) { alert('è¯·å…ˆé€‰æ‹©äº§å“'); return; }
            
            // æ„å»ºåˆ†ç±»æ•°æ®
            const data = { project: currentProject, classification: {} };
            
            PHASES.forEach(phase => {
                const files = classification[phase.id] || [];
                files.forEach((file, idx) => {
                    const newName = `${phase.id}_${String(idx + 1).padStart(2, '0')}.png`;
                    data.classification[file] = newName;
                });
            });
            
            // å‘é€åˆ°åç«¯
            const res = await fetch('/api/save-classification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²åˆ†ç±» ${result.count} å¼ æˆªå›¾`);
            } else {
                alert(`âŒ ä¿å­˜å¤±è´¥: ${result.error}`);
            }
        }
    </script>
</body>
</html>






<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹åŠ¨åˆ†ç±»å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        
        .header { background: #16213e; padding: 16px 24px; border-bottom: 1px solid #2a2a4a; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; }
        .header select, .header button { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; }
        .header select { background: #2a2a4a; color: #fff; }
        .header button { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; cursor: pointer; }
        .header button:hover { opacity: 0.9; }
        .header .spacer { flex: 1; }
        .header .status { font-size: 13px; color: #888; }
        
        .container { display: flex; height: calc(100vh - 60px); }
        
        /* å·¦ä¾§ï¼šæœªåˆ†ç±»æˆªå›¾ */
        .unclassified { width: 300px; background: #16213e; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .unclassified h2 { padding: 16px; font-size: 14px; color: #888; border-bottom: 1px solid #2a2a4a; }
        .unclassified-list { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start; }
        .unclassified-item { aspect-ratio: 9/16; background: #2a2a4a; border-radius: 6px; overflow: hidden; cursor: grab; position: relative; }
        .unclassified-item:hover { outline: 2px solid #667eea; }
        .unclassified-item.selected { outline: 2px solid #f472b6; }
        .unclassified-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .unclassified-item .num { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        /* å³ä¾§ï¼šé˜¶æ®µåˆ†ç»„ */
        .phases { flex: 1; overflow-y: auto; padding: 20px; }
        .phase-group { background: #1f2937; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .phase-header { padding: 12px 16px; background: #2a3441; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .phase-header:hover { background: #3a4451; }
        .phase-icon { font-size: 20px; }
        .phase-name { flex: 1; font-weight: 600; }
        .phase-count { background: rgba(102,126,234,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .phase-content { padding: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 8px; align-content: start; border: 2px dashed transparent; transition: border-color 0.2s; }
        .phase-content.drag-over { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .phase-thumb { width: 60px; background: #2a2a4a; border-radius: 6px; overflow: hidden; position: relative; cursor: grab; }
        .phase-thumb:hover { outline: 2px solid #667eea; }
        .phase-thumb img { width: 100%; display: block; }
        .phase-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        .phase-thumb:hover .remove { display: flex; }
        .phase-empty { color: #555; font-size: 13px; width: 100%; text-align: center; padding: 20px; }
        
        /* å¿«æ·æ“ä½œæ  */
        .quick-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; }
        .quick-bar.show { display: flex; }
        .quick-bar span { font-size: 13px; color: #888; }
        .quick-bar button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .quick-bar .btn-assign { background: #667eea; color: #fff; }
        .quick-bar .btn-cancel { background: #4b5563; color: #fff; }
        
        /* é¢„è§ˆ */
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .preview-modal.active { display: flex; }
        .preview-modal img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        .preview-modal .close { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #fff; cursor: pointer; background: none; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ æ‰‹åŠ¨åˆ†ç±»å·¥å…·</h1>
        <select id="project-select" onchange="loadProject()">
            <option value="">é€‰æ‹©äº§å“...</option>
        </select>
        <div class="spacer"></div>
        <span class="status" id="status">é€‰æ‹©äº§å“å¼€å§‹åˆ†ç±»</span>
        <button onclick="saveClassification()">ğŸ’¾ ä¿å­˜åˆ†ç±»</button>
        <button onclick="window.location.href='/'">â† è¿”å›</button>
    </div>
    
    <div class="container">
        <div class="unclassified">
            <h2>æœªåˆ†ç±»æˆªå›¾ (<span id="unclassified-count">0</span>)</h2>
            <div class="unclassified-list" id="unclassified-list"></div>
        </div>
        
        <div class="phases" id="phases"></div>
    </div>
    
    <div class="quick-bar" id="quick-bar">
        <span>å·²é€‰ <strong id="selected-count">0</strong> å¼ </span>
        <select id="target-phase">
            <option value="">åˆ†é…åˆ°...</option>
        </select>
        <button class="btn-assign" onclick="assignSelected()">åˆ†é…</button>
        <button class="btn-cancel" onclick="clearSelection()">å–æ¶ˆ</button>
    </div>
    
    <div class="preview-modal" id="preview-modal" onclick="closePreview()">
        <button class="close">Ã—</button>
        <img id="preview-img" src="">
    </div>

    <script>
        // é˜¶æ®µå®šä¹‰
        const PHASES = [
            { id: '01_Launch', name: 'å¯åŠ¨é¡µ', icon: 'ğŸš€' },
            { id: '02_Welcome', name: 'æ¬¢è¿/ä»·å€¼ä¸»å¼ ', icon: 'ğŸ‘‹' },
            { id: '03_Auth', name: 'æ³¨å†Œ/ç™»å½•', icon: 'ğŸ”' },
            { id: '04_Goals', name: 'ç›®æ ‡è®¾ç½®', icon: 'ğŸ¯' },
            { id: '05_Profile', name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ‘¤' },
            { id: '06_Activity', name: 'æ´»åŠ¨æ°´å¹³', icon: 'ğŸƒ' },
            { id: '07_Preference', name: 'åå¥½è®¾ç½®', icon: 'âš™ï¸' },
            { id: '08_Motivation', name: 'æ¿€åŠ±/é¢„æœŸ', icon: 'ğŸ’ª' },
            { id: '09_Permissions', name: 'æƒé™è¯·æ±‚', icon: 'ğŸ””' },
            { id: '10_Paywall', name: 'ä»˜è´¹å¢™', icon: 'ğŸ’°' },
            { id: '11_Home', name: 'é¦–é¡µ/ä»ªè¡¨ç›˜', icon: 'ğŸ ' },
            { id: '12_Logging', name: 'è®°å½•åŠŸèƒ½', icon: 'ğŸ“' },
            { id: '13_Stats', name: 'ç»Ÿè®¡/æŠ¥è¡¨', icon: 'ğŸ“Š' },
            { id: '14_Features', name: 'å…¶ä»–åŠŸèƒ½', icon: 'âœ¨' },
            { id: '15_Social', name: 'ç¤¾äº¤åŠŸèƒ½', icon: 'ğŸ‘¥' },
            { id: '16_Settings', name: 'è®¾ç½®/è´¦æˆ·', icon: 'âš™ï¸' },
        ];
        
        let currentProject = '';
        let allScreens = [];
        let classification = {}; // { phaseId: [filename, ...] }
        let selectedItems = new Set();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            const res = await fetch('/api/projects');
            const data = await res.json();
            const select = document.getElementById('project-select');
            data.projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name.replace('_Analysis', '');
                select.appendChild(opt);
            });
            
            // åˆå§‹åŒ–é˜¶æ®µé€‰æ‹©å™¨
            const targetPhase = document.getElementById('target-phase');
            PHASES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.icon} ${p.name}`;
                targetPhase.appendChild(opt);
            });
            
            // æ¸²æŸ“é˜¶æ®µé¢æ¿
            renderPhases();
        });
        
        async function loadProject() {
            currentProject = document.getElementById('project-select').value;
            if (!currentProject) return;
            
            // åŠ è½½æˆªå›¾
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            allScreens = data.downloads || [];
            
            // åˆå§‹åŒ–åˆ†ç±»ï¼ˆå…¨éƒ¨æœªåˆ†ç±»ï¼‰
            classification = {};
            PHASES.forEach(p => classification[p.id] = []);
            
            // å°è¯•åŠ è½½å·²æœ‰åˆ†ç±»
            await loadExistingClassification();
            
            renderAll();
            updateStatus();
        }
        
        async function loadExistingClassification() {
            // æ£€æŸ¥Screensç›®å½•æ˜¯å¦æœ‰å·²åˆ†ç±»çš„æ–‡ä»¶
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            
            if (data.screens && data.screens.length > 0) {
                // è§£æå·²æœ‰åˆ†ç±»
                data.screens.forEach(filename => {
                    const parts = filename.split('_');
                    if (parts.length >= 2) {
                        const phaseId = `${parts[0]}_${parts[1]}`;
                        if (classification[phaseId]) {
                            // æ‰¾åˆ°å¯¹åº”çš„åŸå§‹æ–‡ä»¶
                            const step = parseInt(parts[2]) || 1;
                            const origFile = `Screen_${String(step).padStart(3, '0')}.png`;
                            if (allScreens.includes(origFile) && !classification[phaseId].includes(origFile)) {
                                classification[phaseId].push(origFile);
                            }
                        }
                    }
                });
            }
        }
        
        function renderPhases() {
            const container = document.getElementById('phases');
            container.innerHTML = PHASES.map(phase => `
                <div class="phase-group" data-phase="${phase.id}">
                    <div class="phase-header">
                        <span class="phase-icon">${phase.icon}</span>
                        <span class="phase-name">${phase.name}</span>
                        <span class="phase-count" id="count-${phase.id}">0</span>
                    </div>
                    <div class="phase-content" 
                         id="phase-${phase.id}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${phase.id}')">
                        <div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderAll() {
            renderUnclassified();
            renderClassified();
        }
        
        function renderUnclassified() {
            // æ‰¾å‡ºæœªåˆ†ç±»çš„
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            const unclassified = allScreens.filter(f => !classified.has(f));
            
            document.getElementById('unclassified-count').textContent = unclassified.length;
            
            const list = document.getElementById('unclassified-list');
            list.innerHTML = unclassified.map((file, idx) => {
                const num = file.match(/\d+/)?.[0] || idx;
                return `
                    <div class="unclassified-item ${selectedItems.has(file) ? 'selected' : ''}"
                         draggable="true"
                         data-file="${file}"
                         onclick="toggleSelect('${file}', event)"
                         ondblclick="openPreview('${file}')"
                         ondragstart="handleDragStart(event, '${file}')">
                        <img src="/api/thumb/${currentProject}/downloads/${file}" loading="lazy">
                        <span class="num">${num}</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderClassified() {
            PHASES.forEach(phase => {
                const items = classification[phase.id] || [];
                document.getElementById(`count-${phase.id}`).textContent = items.length;
                
                const container = document.getElementById(`phase-${phase.id}`);
                if (items.length === 0) {
                    container.innerHTML = '<div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>';
                } else {
                    container.innerHTML = items.map(file => `
                        <div class="phase-thumb" data-file="${file}" ondblclick="openPreview('${file}')">
                            <img src="/api/thumb/${currentProject}/downloads/${file}">
                            <div class="remove" onclick="removeFromPhase('${phase.id}', '${file}')">Ã—</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        // é€‰æ‹©
        function toggleSelect(file, event) {
            if (event.shiftKey && selectedItems.size > 0) {
                // Shiftå¤šé€‰
                const unclassified = getUnclassifiedList();
                const lastSelected = Array.from(selectedItems).pop();
                const startIdx = unclassified.indexOf(lastSelected);
                const endIdx = unclassified.indexOf(file);
                const [from, to] = startIdx < endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
                for (let i = from; i <= to; i++) {
                    selectedItems.add(unclassified[i]);
                }
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrlå•é€‰åˆ‡æ¢
                if (selectedItems.has(file)) {
                    selectedItems.delete(file);
                } else {
                    selectedItems.add(file);
                }
            } else {
                // æ™®é€šå•é€‰
                selectedItems.clear();
                selectedItems.add(file);
            }
            
            renderUnclassified();
            updateQuickBar();
        }
        
        function clearSelection() {
            selectedItems.clear();
            renderUnclassified();
            updateQuickBar();
        }
        
        function updateQuickBar() {
            const bar = document.getElementById('quick-bar');
            const count = selectedItems.size;
            document.getElementById('selected-count').textContent = count;
            bar.classList.toggle('show', count > 0);
        }
        
        function assignSelected() {
            const phaseId = document.getElementById('target-phase').value;
            if (!phaseId) { alert('è¯·é€‰æ‹©ç›®æ ‡é˜¶æ®µ'); return; }
            
            selectedItems.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                classification[phaseId].push(file);
            });
            
            selectedItems.clear();
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function getUnclassifiedList() {
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            return allScreens.filter(f => !classified.has(f));
        }
        
        // æ‹–æ‹½
        let draggedFile = '';
        
        function handleDragStart(event, file) {
            draggedFile = file;
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event, phaseId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedFile) return;
            
            // å¦‚æœæœ‰å¤šé€‰ï¼Œç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„
            const filesToMove = selectedItems.size > 0 && selectedItems.has(draggedFile) 
                ? Array.from(selectedItems) 
                : [draggedFile];
            
            filesToMove.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                if (!classification[phaseId].includes(file)) {
                    classification[phaseId].push(file);
                }
            });
            
            selectedItems.clear();
            draggedFile = '';
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function removeFromPhase(phaseId, file) {
            const idx = classification[phaseId].indexOf(file);
            if (idx > -1) {
                classification[phaseId].splice(idx, 1);
                renderAll();
                updateStatus();
            }
        }
        
        // é¢„è§ˆ
        function openPreview(file) {
            document.getElementById('preview-img').src = `/api/screenshot/${currentProject}/downloads/${file}`;
            document.getElementById('preview-modal').classList.add('active');
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
        }
        
        // çŠ¶æ€
        function updateStatus() {
            const total = allScreens.length;
            const classified = Object.values(classification).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('status').textContent = `å·²åˆ†ç±» ${classified}/${total} å¼ `;
        }
        
        // ä¿å­˜
        async function saveClassification() {
            if (!currentProject) { alert('è¯·å…ˆé€‰æ‹©äº§å“'); return; }
            
            // æ„å»ºåˆ†ç±»æ•°æ®
            const data = { project: currentProject, classification: {} };
            
            PHASES.forEach(phase => {
                const files = classification[phase.id] || [];
                files.forEach((file, idx) => {
                    const newName = `${phase.id}_${String(idx + 1).padStart(2, '0')}.png`;
                    data.classification[file] = newName;
                });
            });
            
            // å‘é€åˆ°åç«¯
            const res = await fetch('/api/save-classification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²åˆ†ç±» ${result.count} å¼ æˆªå›¾`);
            } else {
                alert(`âŒ ä¿å­˜å¤±è´¥: ${result.error}`);
            }
        }
    </script>
</body>
</html>






<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹åŠ¨åˆ†ç±»å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        
        .header { background: #16213e; padding: 16px 24px; border-bottom: 1px solid #2a2a4a; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; }
        .header select, .header button { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; }
        .header select { background: #2a2a4a; color: #fff; }
        .header button { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; cursor: pointer; }
        .header button:hover { opacity: 0.9; }
        .header .spacer { flex: 1; }
        .header .status { font-size: 13px; color: #888; }
        
        .container { display: flex; height: calc(100vh - 60px); }
        
        /* å·¦ä¾§ï¼šæœªåˆ†ç±»æˆªå›¾ */
        .unclassified { width: 300px; background: #16213e; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .unclassified h2 { padding: 16px; font-size: 14px; color: #888; border-bottom: 1px solid #2a2a4a; }
        .unclassified-list { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start; }
        .unclassified-item { aspect-ratio: 9/16; background: #2a2a4a; border-radius: 6px; overflow: hidden; cursor: grab; position: relative; }
        .unclassified-item:hover { outline: 2px solid #667eea; }
        .unclassified-item.selected { outline: 2px solid #f472b6; }
        .unclassified-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .unclassified-item .num { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        /* å³ä¾§ï¼šé˜¶æ®µåˆ†ç»„ */
        .phases { flex: 1; overflow-y: auto; padding: 20px; }
        .phase-group { background: #1f2937; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .phase-header { padding: 12px 16px; background: #2a3441; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .phase-header:hover { background: #3a4451; }
        .phase-icon { font-size: 20px; }
        .phase-name { flex: 1; font-weight: 600; }
        .phase-count { background: rgba(102,126,234,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .phase-content { padding: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 8px; align-content: start; border: 2px dashed transparent; transition: border-color 0.2s; }
        .phase-content.drag-over { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .phase-thumb { width: 60px; background: #2a2a4a; border-radius: 6px; overflow: hidden; position: relative; cursor: grab; }
        .phase-thumb:hover { outline: 2px solid #667eea; }
        .phase-thumb img { width: 100%; display: block; }
        .phase-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        .phase-thumb:hover .remove { display: flex; }
        .phase-empty { color: #555; font-size: 13px; width: 100%; text-align: center; padding: 20px; }
        
        /* å¿«æ·æ“ä½œæ  */
        .quick-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; }
        .quick-bar.show { display: flex; }
        .quick-bar span { font-size: 13px; color: #888; }
        .quick-bar button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .quick-bar .btn-assign { background: #667eea; color: #fff; }
        .quick-bar .btn-cancel { background: #4b5563; color: #fff; }
        
        /* é¢„è§ˆ */
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .preview-modal.active { display: flex; }
        .preview-modal img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        .preview-modal .close { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #fff; cursor: pointer; background: none; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ æ‰‹åŠ¨åˆ†ç±»å·¥å…·</h1>
        <select id="project-select" onchange="loadProject()">
            <option value="">é€‰æ‹©äº§å“...</option>
        </select>
        <div class="spacer"></div>
        <span class="status" id="status">é€‰æ‹©äº§å“å¼€å§‹åˆ†ç±»</span>
        <button onclick="saveClassification()">ğŸ’¾ ä¿å­˜åˆ†ç±»</button>
        <button onclick="window.location.href='/'">â† è¿”å›</button>
    </div>
    
    <div class="container">
        <div class="unclassified">
            <h2>æœªåˆ†ç±»æˆªå›¾ (<span id="unclassified-count">0</span>)</h2>
            <div class="unclassified-list" id="unclassified-list"></div>
        </div>
        
        <div class="phases" id="phases"></div>
    </div>
    
    <div class="quick-bar" id="quick-bar">
        <span>å·²é€‰ <strong id="selected-count">0</strong> å¼ </span>
        <select id="target-phase">
            <option value="">åˆ†é…åˆ°...</option>
        </select>
        <button class="btn-assign" onclick="assignSelected()">åˆ†é…</button>
        <button class="btn-cancel" onclick="clearSelection()">å–æ¶ˆ</button>
    </div>
    
    <div class="preview-modal" id="preview-modal" onclick="closePreview()">
        <button class="close">Ã—</button>
        <img id="preview-img" src="">
    </div>

    <script>
        // é˜¶æ®µå®šä¹‰
        const PHASES = [
            { id: '01_Launch', name: 'å¯åŠ¨é¡µ', icon: 'ğŸš€' },
            { id: '02_Welcome', name: 'æ¬¢è¿/ä»·å€¼ä¸»å¼ ', icon: 'ğŸ‘‹' },
            { id: '03_Auth', name: 'æ³¨å†Œ/ç™»å½•', icon: 'ğŸ”' },
            { id: '04_Goals', name: 'ç›®æ ‡è®¾ç½®', icon: 'ğŸ¯' },
            { id: '05_Profile', name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ‘¤' },
            { id: '06_Activity', name: 'æ´»åŠ¨æ°´å¹³', icon: 'ğŸƒ' },
            { id: '07_Preference', name: 'åå¥½è®¾ç½®', icon: 'âš™ï¸' },
            { id: '08_Motivation', name: 'æ¿€åŠ±/é¢„æœŸ', icon: 'ğŸ’ª' },
            { id: '09_Permissions', name: 'æƒé™è¯·æ±‚', icon: 'ğŸ””' },
            { id: '10_Paywall', name: 'ä»˜è´¹å¢™', icon: 'ğŸ’°' },
            { id: '11_Home', name: 'é¦–é¡µ/ä»ªè¡¨ç›˜', icon: 'ğŸ ' },
            { id: '12_Logging', name: 'è®°å½•åŠŸèƒ½', icon: 'ğŸ“' },
            { id: '13_Stats', name: 'ç»Ÿè®¡/æŠ¥è¡¨', icon: 'ğŸ“Š' },
            { id: '14_Features', name: 'å…¶ä»–åŠŸèƒ½', icon: 'âœ¨' },
            { id: '15_Social', name: 'ç¤¾äº¤åŠŸèƒ½', icon: 'ğŸ‘¥' },
            { id: '16_Settings', name: 'è®¾ç½®/è´¦æˆ·', icon: 'âš™ï¸' },
        ];
        
        let currentProject = '';
        let allScreens = [];
        let classification = {}; // { phaseId: [filename, ...] }
        let selectedItems = new Set();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            const res = await fetch('/api/projects');
            const data = await res.json();
            const select = document.getElementById('project-select');
            data.projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name.replace('_Analysis', '');
                select.appendChild(opt);
            });
            
            // åˆå§‹åŒ–é˜¶æ®µé€‰æ‹©å™¨
            const targetPhase = document.getElementById('target-phase');
            PHASES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.icon} ${p.name}`;
                targetPhase.appendChild(opt);
            });
            
            // æ¸²æŸ“é˜¶æ®µé¢æ¿
            renderPhases();
        });
        
        async function loadProject() {
            currentProject = document.getElementById('project-select').value;
            if (!currentProject) return;
            
            // åŠ è½½æˆªå›¾
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            allScreens = data.downloads || [];
            
            // åˆå§‹åŒ–åˆ†ç±»ï¼ˆå…¨éƒ¨æœªåˆ†ç±»ï¼‰
            classification = {};
            PHASES.forEach(p => classification[p.id] = []);
            
            // å°è¯•åŠ è½½å·²æœ‰åˆ†ç±»
            await loadExistingClassification();
            
            renderAll();
            updateStatus();
        }
        
        async function loadExistingClassification() {
            // æ£€æŸ¥Screensç›®å½•æ˜¯å¦æœ‰å·²åˆ†ç±»çš„æ–‡ä»¶
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            
            if (data.screens && data.screens.length > 0) {
                // è§£æå·²æœ‰åˆ†ç±»
                data.screens.forEach(filename => {
                    const parts = filename.split('_');
                    if (parts.length >= 2) {
                        const phaseId = `${parts[0]}_${parts[1]}`;
                        if (classification[phaseId]) {
                            // æ‰¾åˆ°å¯¹åº”çš„åŸå§‹æ–‡ä»¶
                            const step = parseInt(parts[2]) || 1;
                            const origFile = `Screen_${String(step).padStart(3, '0')}.png`;
                            if (allScreens.includes(origFile) && !classification[phaseId].includes(origFile)) {
                                classification[phaseId].push(origFile);
                            }
                        }
                    }
                });
            }
        }
        
        function renderPhases() {
            const container = document.getElementById('phases');
            container.innerHTML = PHASES.map(phase => `
                <div class="phase-group" data-phase="${phase.id}">
                    <div class="phase-header">
                        <span class="phase-icon">${phase.icon}</span>
                        <span class="phase-name">${phase.name}</span>
                        <span class="phase-count" id="count-${phase.id}">0</span>
                    </div>
                    <div class="phase-content" 
                         id="phase-${phase.id}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${phase.id}')">
                        <div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderAll() {
            renderUnclassified();
            renderClassified();
        }
        
        function renderUnclassified() {
            // æ‰¾å‡ºæœªåˆ†ç±»çš„
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            const unclassified = allScreens.filter(f => !classified.has(f));
            
            document.getElementById('unclassified-count').textContent = unclassified.length;
            
            const list = document.getElementById('unclassified-list');
            list.innerHTML = unclassified.map((file, idx) => {
                const num = file.match(/\d+/)?.[0] || idx;
                return `
                    <div class="unclassified-item ${selectedItems.has(file) ? 'selected' : ''}"
                         draggable="true"
                         data-file="${file}"
                         onclick="toggleSelect('${file}', event)"
                         ondblclick="openPreview('${file}')"
                         ondragstart="handleDragStart(event, '${file}')">
                        <img src="/api/thumb/${currentProject}/downloads/${file}" loading="lazy">
                        <span class="num">${num}</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderClassified() {
            PHASES.forEach(phase => {
                const items = classification[phase.id] || [];
                document.getElementById(`count-${phase.id}`).textContent = items.length;
                
                const container = document.getElementById(`phase-${phase.id}`);
                if (items.length === 0) {
                    container.innerHTML = '<div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>';
                } else {
                    container.innerHTML = items.map(file => `
                        <div class="phase-thumb" data-file="${file}" ondblclick="openPreview('${file}')">
                            <img src="/api/thumb/${currentProject}/downloads/${file}">
                            <div class="remove" onclick="removeFromPhase('${phase.id}', '${file}')">Ã—</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        // é€‰æ‹©
        function toggleSelect(file, event) {
            if (event.shiftKey && selectedItems.size > 0) {
                // Shiftå¤šé€‰
                const unclassified = getUnclassifiedList();
                const lastSelected = Array.from(selectedItems).pop();
                const startIdx = unclassified.indexOf(lastSelected);
                const endIdx = unclassified.indexOf(file);
                const [from, to] = startIdx < endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
                for (let i = from; i <= to; i++) {
                    selectedItems.add(unclassified[i]);
                }
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrlå•é€‰åˆ‡æ¢
                if (selectedItems.has(file)) {
                    selectedItems.delete(file);
                } else {
                    selectedItems.add(file);
                }
            } else {
                // æ™®é€šå•é€‰
                selectedItems.clear();
                selectedItems.add(file);
            }
            
            renderUnclassified();
            updateQuickBar();
        }
        
        function clearSelection() {
            selectedItems.clear();
            renderUnclassified();
            updateQuickBar();
        }
        
        function updateQuickBar() {
            const bar = document.getElementById('quick-bar');
            const count = selectedItems.size;
            document.getElementById('selected-count').textContent = count;
            bar.classList.toggle('show', count > 0);
        }
        
        function assignSelected() {
            const phaseId = document.getElementById('target-phase').value;
            if (!phaseId) { alert('è¯·é€‰æ‹©ç›®æ ‡é˜¶æ®µ'); return; }
            
            selectedItems.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                classification[phaseId].push(file);
            });
            
            selectedItems.clear();
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function getUnclassifiedList() {
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            return allScreens.filter(f => !classified.has(f));
        }
        
        // æ‹–æ‹½
        let draggedFile = '';
        
        function handleDragStart(event, file) {
            draggedFile = file;
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event, phaseId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedFile) return;
            
            // å¦‚æœæœ‰å¤šé€‰ï¼Œç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„
            const filesToMove = selectedItems.size > 0 && selectedItems.has(draggedFile) 
                ? Array.from(selectedItems) 
                : [draggedFile];
            
            filesToMove.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                if (!classification[phaseId].includes(file)) {
                    classification[phaseId].push(file);
                }
            });
            
            selectedItems.clear();
            draggedFile = '';
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function removeFromPhase(phaseId, file) {
            const idx = classification[phaseId].indexOf(file);
            if (idx > -1) {
                classification[phaseId].splice(idx, 1);
                renderAll();
                updateStatus();
            }
        }
        
        // é¢„è§ˆ
        function openPreview(file) {
            document.getElementById('preview-img').src = `/api/screenshot/${currentProject}/downloads/${file}`;
            document.getElementById('preview-modal').classList.add('active');
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
        }
        
        // çŠ¶æ€
        function updateStatus() {
            const total = allScreens.length;
            const classified = Object.values(classification).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('status').textContent = `å·²åˆ†ç±» ${classified}/${total} å¼ `;
        }
        
        // ä¿å­˜
        async function saveClassification() {
            if (!currentProject) { alert('è¯·å…ˆé€‰æ‹©äº§å“'); return; }
            
            // æ„å»ºåˆ†ç±»æ•°æ®
            const data = { project: currentProject, classification: {} };
            
            PHASES.forEach(phase => {
                const files = classification[phase.id] || [];
                files.forEach((file, idx) => {
                    const newName = `${phase.id}_${String(idx + 1).padStart(2, '0')}.png`;
                    data.classification[file] = newName;
                });
            });
            
            // å‘é€åˆ°åç«¯
            const res = await fetch('/api/save-classification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²åˆ†ç±» ${result.count} å¼ æˆªå›¾`);
            } else {
                alert(`âŒ ä¿å­˜å¤±è´¥: ${result.error}`);
            }
        }
    </script>
</body>
</html>







<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹åŠ¨åˆ†ç±»å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        
        .header { background: #16213e; padding: 16px 24px; border-bottom: 1px solid #2a2a4a; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; }
        .header select, .header button { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; }
        .header select { background: #2a2a4a; color: #fff; }
        .header button { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; cursor: pointer; }
        .header button:hover { opacity: 0.9; }
        .header .spacer { flex: 1; }
        .header .status { font-size: 13px; color: #888; }
        
        .container { display: flex; height: calc(100vh - 60px); }
        
        /* å·¦ä¾§ï¼šæœªåˆ†ç±»æˆªå›¾ */
        .unclassified { width: 300px; background: #16213e; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .unclassified h2 { padding: 16px; font-size: 14px; color: #888; border-bottom: 1px solid #2a2a4a; }
        .unclassified-list { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start; }
        .unclassified-item { aspect-ratio: 9/16; background: #2a2a4a; border-radius: 6px; overflow: hidden; cursor: grab; position: relative; }
        .unclassified-item:hover { outline: 2px solid #667eea; }
        .unclassified-item.selected { outline: 2px solid #f472b6; }
        .unclassified-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .unclassified-item .num { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        /* å³ä¾§ï¼šé˜¶æ®µåˆ†ç»„ */
        .phases { flex: 1; overflow-y: auto; padding: 20px; }
        .phase-group { background: #1f2937; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .phase-header { padding: 12px 16px; background: #2a3441; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .phase-header:hover { background: #3a4451; }
        .phase-icon { font-size: 20px; }
        .phase-name { flex: 1; font-weight: 600; }
        .phase-count { background: rgba(102,126,234,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .phase-content { padding: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 8px; align-content: start; border: 2px dashed transparent; transition: border-color 0.2s; }
        .phase-content.drag-over { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .phase-thumb { width: 60px; background: #2a2a4a; border-radius: 6px; overflow: hidden; position: relative; cursor: grab; }
        .phase-thumb:hover { outline: 2px solid #667eea; }
        .phase-thumb img { width: 100%; display: block; }
        .phase-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        .phase-thumb:hover .remove { display: flex; }
        .phase-empty { color: #555; font-size: 13px; width: 100%; text-align: center; padding: 20px; }
        
        /* å¿«æ·æ“ä½œæ  */
        .quick-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; }
        .quick-bar.show { display: flex; }
        .quick-bar span { font-size: 13px; color: #888; }
        .quick-bar button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .quick-bar .btn-assign { background: #667eea; color: #fff; }
        .quick-bar .btn-cancel { background: #4b5563; color: #fff; }
        
        /* é¢„è§ˆ */
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .preview-modal.active { display: flex; }
        .preview-modal img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        .preview-modal .close { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #fff; cursor: pointer; background: none; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ æ‰‹åŠ¨åˆ†ç±»å·¥å…·</h1>
        <select id="project-select" onchange="loadProject()">
            <option value="">é€‰æ‹©äº§å“...</option>
        </select>
        <div class="spacer"></div>
        <span class="status" id="status">é€‰æ‹©äº§å“å¼€å§‹åˆ†ç±»</span>
        <button onclick="saveClassification()">ğŸ’¾ ä¿å­˜åˆ†ç±»</button>
        <button onclick="window.location.href='/'">â† è¿”å›</button>
    </div>
    
    <div class="container">
        <div class="unclassified">
            <h2>æœªåˆ†ç±»æˆªå›¾ (<span id="unclassified-count">0</span>)</h2>
            <div class="unclassified-list" id="unclassified-list"></div>
        </div>
        
        <div class="phases" id="phases"></div>
    </div>
    
    <div class="quick-bar" id="quick-bar">
        <span>å·²é€‰ <strong id="selected-count">0</strong> å¼ </span>
        <select id="target-phase">
            <option value="">åˆ†é…åˆ°...</option>
        </select>
        <button class="btn-assign" onclick="assignSelected()">åˆ†é…</button>
        <button class="btn-cancel" onclick="clearSelection()">å–æ¶ˆ</button>
    </div>
    
    <div class="preview-modal" id="preview-modal" onclick="closePreview()">
        <button class="close">Ã—</button>
        <img id="preview-img" src="">
    </div>

    <script>
        // é˜¶æ®µå®šä¹‰
        const PHASES = [
            { id: '01_Launch', name: 'å¯åŠ¨é¡µ', icon: 'ğŸš€' },
            { id: '02_Welcome', name: 'æ¬¢è¿/ä»·å€¼ä¸»å¼ ', icon: 'ğŸ‘‹' },
            { id: '03_Auth', name: 'æ³¨å†Œ/ç™»å½•', icon: 'ğŸ”' },
            { id: '04_Goals', name: 'ç›®æ ‡è®¾ç½®', icon: 'ğŸ¯' },
            { id: '05_Profile', name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ‘¤' },
            { id: '06_Activity', name: 'æ´»åŠ¨æ°´å¹³', icon: 'ğŸƒ' },
            { id: '07_Preference', name: 'åå¥½è®¾ç½®', icon: 'âš™ï¸' },
            { id: '08_Motivation', name: 'æ¿€åŠ±/é¢„æœŸ', icon: 'ğŸ’ª' },
            { id: '09_Permissions', name: 'æƒé™è¯·æ±‚', icon: 'ğŸ””' },
            { id: '10_Paywall', name: 'ä»˜è´¹å¢™', icon: 'ğŸ’°' },
            { id: '11_Home', name: 'é¦–é¡µ/ä»ªè¡¨ç›˜', icon: 'ğŸ ' },
            { id: '12_Logging', name: 'è®°å½•åŠŸèƒ½', icon: 'ğŸ“' },
            { id: '13_Stats', name: 'ç»Ÿè®¡/æŠ¥è¡¨', icon: 'ğŸ“Š' },
            { id: '14_Features', name: 'å…¶ä»–åŠŸèƒ½', icon: 'âœ¨' },
            { id: '15_Social', name: 'ç¤¾äº¤åŠŸèƒ½', icon: 'ğŸ‘¥' },
            { id: '16_Settings', name: 'è®¾ç½®/è´¦æˆ·', icon: 'âš™ï¸' },
        ];
        
        let currentProject = '';
        let allScreens = [];
        let classification = {}; // { phaseId: [filename, ...] }
        let selectedItems = new Set();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            const res = await fetch('/api/projects');
            const data = await res.json();
            const select = document.getElementById('project-select');
            data.projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name.replace('_Analysis', '');
                select.appendChild(opt);
            });
            
            // åˆå§‹åŒ–é˜¶æ®µé€‰æ‹©å™¨
            const targetPhase = document.getElementById('target-phase');
            PHASES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.icon} ${p.name}`;
                targetPhase.appendChild(opt);
            });
            
            // æ¸²æŸ“é˜¶æ®µé¢æ¿
            renderPhases();
        });
        
        async function loadProject() {
            currentProject = document.getElementById('project-select').value;
            if (!currentProject) return;
            
            // åŠ è½½æˆªå›¾
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            allScreens = data.downloads || [];
            
            // åˆå§‹åŒ–åˆ†ç±»ï¼ˆå…¨éƒ¨æœªåˆ†ç±»ï¼‰
            classification = {};
            PHASES.forEach(p => classification[p.id] = []);
            
            // å°è¯•åŠ è½½å·²æœ‰åˆ†ç±»
            await loadExistingClassification();
            
            renderAll();
            updateStatus();
        }
        
        async function loadExistingClassification() {
            // æ£€æŸ¥Screensç›®å½•æ˜¯å¦æœ‰å·²åˆ†ç±»çš„æ–‡ä»¶
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            
            if (data.screens && data.screens.length > 0) {
                // è§£æå·²æœ‰åˆ†ç±»
                data.screens.forEach(filename => {
                    const parts = filename.split('_');
                    if (parts.length >= 2) {
                        const phaseId = `${parts[0]}_${parts[1]}`;
                        if (classification[phaseId]) {
                            // æ‰¾åˆ°å¯¹åº”çš„åŸå§‹æ–‡ä»¶
                            const step = parseInt(parts[2]) || 1;
                            const origFile = `Screen_${String(step).padStart(3, '0')}.png`;
                            if (allScreens.includes(origFile) && !classification[phaseId].includes(origFile)) {
                                classification[phaseId].push(origFile);
                            }
                        }
                    }
                });
            }
        }
        
        function renderPhases() {
            const container = document.getElementById('phases');
            container.innerHTML = PHASES.map(phase => `
                <div class="phase-group" data-phase="${phase.id}">
                    <div class="phase-header">
                        <span class="phase-icon">${phase.icon}</span>
                        <span class="phase-name">${phase.name}</span>
                        <span class="phase-count" id="count-${phase.id}">0</span>
                    </div>
                    <div class="phase-content" 
                         id="phase-${phase.id}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${phase.id}')">
                        <div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderAll() {
            renderUnclassified();
            renderClassified();
        }
        
        function renderUnclassified() {
            // æ‰¾å‡ºæœªåˆ†ç±»çš„
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            const unclassified = allScreens.filter(f => !classified.has(f));
            
            document.getElementById('unclassified-count').textContent = unclassified.length;
            
            const list = document.getElementById('unclassified-list');
            list.innerHTML = unclassified.map((file, idx) => {
                const num = file.match(/\d+/)?.[0] || idx;
                return `
                    <div class="unclassified-item ${selectedItems.has(file) ? 'selected' : ''}"
                         draggable="true"
                         data-file="${file}"
                         onclick="toggleSelect('${file}', event)"
                         ondblclick="openPreview('${file}')"
                         ondragstart="handleDragStart(event, '${file}')">
                        <img src="/api/thumb/${currentProject}/downloads/${file}" loading="lazy">
                        <span class="num">${num}</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderClassified() {
            PHASES.forEach(phase => {
                const items = classification[phase.id] || [];
                document.getElementById(`count-${phase.id}`).textContent = items.length;
                
                const container = document.getElementById(`phase-${phase.id}`);
                if (items.length === 0) {
                    container.innerHTML = '<div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>';
                } else {
                    container.innerHTML = items.map(file => `
                        <div class="phase-thumb" data-file="${file}" ondblclick="openPreview('${file}')">
                            <img src="/api/thumb/${currentProject}/downloads/${file}">
                            <div class="remove" onclick="removeFromPhase('${phase.id}', '${file}')">Ã—</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        // é€‰æ‹©
        function toggleSelect(file, event) {
            if (event.shiftKey && selectedItems.size > 0) {
                // Shiftå¤šé€‰
                const unclassified = getUnclassifiedList();
                const lastSelected = Array.from(selectedItems).pop();
                const startIdx = unclassified.indexOf(lastSelected);
                const endIdx = unclassified.indexOf(file);
                const [from, to] = startIdx < endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
                for (let i = from; i <= to; i++) {
                    selectedItems.add(unclassified[i]);
                }
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrlå•é€‰åˆ‡æ¢
                if (selectedItems.has(file)) {
                    selectedItems.delete(file);
                } else {
                    selectedItems.add(file);
                }
            } else {
                // æ™®é€šå•é€‰
                selectedItems.clear();
                selectedItems.add(file);
            }
            
            renderUnclassified();
            updateQuickBar();
        }
        
        function clearSelection() {
            selectedItems.clear();
            renderUnclassified();
            updateQuickBar();
        }
        
        function updateQuickBar() {
            const bar = document.getElementById('quick-bar');
            const count = selectedItems.size;
            document.getElementById('selected-count').textContent = count;
            bar.classList.toggle('show', count > 0);
        }
        
        function assignSelected() {
            const phaseId = document.getElementById('target-phase').value;
            if (!phaseId) { alert('è¯·é€‰æ‹©ç›®æ ‡é˜¶æ®µ'); return; }
            
            selectedItems.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                classification[phaseId].push(file);
            });
            
            selectedItems.clear();
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function getUnclassifiedList() {
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            return allScreens.filter(f => !classified.has(f));
        }
        
        // æ‹–æ‹½
        let draggedFile = '';
        
        function handleDragStart(event, file) {
            draggedFile = file;
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event, phaseId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedFile) return;
            
            // å¦‚æœæœ‰å¤šé€‰ï¼Œç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„
            const filesToMove = selectedItems.size > 0 && selectedItems.has(draggedFile) 
                ? Array.from(selectedItems) 
                : [draggedFile];
            
            filesToMove.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                if (!classification[phaseId].includes(file)) {
                    classification[phaseId].push(file);
                }
            });
            
            selectedItems.clear();
            draggedFile = '';
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function removeFromPhase(phaseId, file) {
            const idx = classification[phaseId].indexOf(file);
            if (idx > -1) {
                classification[phaseId].splice(idx, 1);
                renderAll();
                updateStatus();
            }
        }
        
        // é¢„è§ˆ
        function openPreview(file) {
            document.getElementById('preview-img').src = `/api/screenshot/${currentProject}/downloads/${file}`;
            document.getElementById('preview-modal').classList.add('active');
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
        }
        
        // çŠ¶æ€
        function updateStatus() {
            const total = allScreens.length;
            const classified = Object.values(classification).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('status').textContent = `å·²åˆ†ç±» ${classified}/${total} å¼ `;
        }
        
        // ä¿å­˜
        async function saveClassification() {
            if (!currentProject) { alert('è¯·å…ˆé€‰æ‹©äº§å“'); return; }
            
            // æ„å»ºåˆ†ç±»æ•°æ®
            const data = { project: currentProject, classification: {} };
            
            PHASES.forEach(phase => {
                const files = classification[phase.id] || [];
                files.forEach((file, idx) => {
                    const newName = `${phase.id}_${String(idx + 1).padStart(2, '0')}.png`;
                    data.classification[file] = newName;
                });
            });
            
            // å‘é€åˆ°åç«¯
            const res = await fetch('/api/save-classification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²åˆ†ç±» ${result.count} å¼ æˆªå›¾`);
            } else {
                alert(`âŒ ä¿å­˜å¤±è´¥: ${result.error}`);
            }
        }
    </script>
</body>
</html>






<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹åŠ¨åˆ†ç±»å·¥å…·</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a2e; color: #fff; min-height: 100vh; }
        
        .header { background: #16213e; padding: 16px 24px; border-bottom: 1px solid #2a2a4a; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 18px; }
        .header select, .header button { padding: 8px 16px; border-radius: 6px; border: none; font-size: 14px; }
        .header select { background: #2a2a4a; color: #fff; }
        .header button { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; cursor: pointer; }
        .header button:hover { opacity: 0.9; }
        .header .spacer { flex: 1; }
        .header .status { font-size: 13px; color: #888; }
        
        .container { display: flex; height: calc(100vh - 60px); }
        
        /* å·¦ä¾§ï¼šæœªåˆ†ç±»æˆªå›¾ */
        .unclassified { width: 300px; background: #16213e; border-right: 1px solid #2a2a4a; display: flex; flex-direction: column; }
        .unclassified h2 { padding: 16px; font-size: 14px; color: #888; border-bottom: 1px solid #2a2a4a; }
        .unclassified-list { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; align-content: start; }
        .unclassified-item { aspect-ratio: 9/16; background: #2a2a4a; border-radius: 6px; overflow: hidden; cursor: grab; position: relative; }
        .unclassified-item:hover { outline: 2px solid #667eea; }
        .unclassified-item.selected { outline: 2px solid #f472b6; }
        .unclassified-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .unclassified-item .num { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        
        /* å³ä¾§ï¼šé˜¶æ®µåˆ†ç»„ */
        .phases { flex: 1; overflow-y: auto; padding: 20px; }
        .phase-group { background: #1f2937; border-radius: 12px; margin-bottom: 16px; overflow: hidden; }
        .phase-header { padding: 12px 16px; background: #2a3441; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .phase-header:hover { background: #3a4451; }
        .phase-icon { font-size: 20px; }
        .phase-name { flex: 1; font-weight: 600; }
        .phase-count { background: rgba(102,126,234,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .phase-content { padding: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 8px; align-content: start; border: 2px dashed transparent; transition: border-color 0.2s; }
        .phase-content.drag-over { border-color: #667eea; background: rgba(102,126,234,0.1); }
        .phase-thumb { width: 60px; background: #2a2a4a; border-radius: 6px; overflow: hidden; position: relative; cursor: grab; }
        .phase-thumb:hover { outline: 2px solid #667eea; }
        .phase-thumb img { width: 100%; display: block; }
        .phase-thumb .remove { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: #ef4444; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        .phase-thumb:hover .remove { display: flex; }
        .phase-empty { color: #555; font-size: 13px; width: 100%; text-align: center; padding: 20px; }
        
        /* å¿«æ·æ“ä½œæ  */
        .quick-bar { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #1f2937; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none; align-items: center; gap: 12px; }
        .quick-bar.show { display: flex; }
        .quick-bar span { font-size: 13px; color: #888; }
        .quick-bar button { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; }
        .quick-bar .btn-assign { background: #667eea; color: #fff; }
        .quick-bar .btn-cancel { background: #4b5563; color: #fff; }
        
        /* é¢„è§ˆ */
        .preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .preview-modal.active { display: flex; }
        .preview-modal img { max-width: 90vw; max-height: 90vh; border-radius: 8px; }
        .preview-modal .close { position: absolute; top: 20px; right: 20px; font-size: 32px; color: #fff; cursor: pointer; background: none; border: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ æ‰‹åŠ¨åˆ†ç±»å·¥å…·</h1>
        <select id="project-select" onchange="loadProject()">
            <option value="">é€‰æ‹©äº§å“...</option>
        </select>
        <div class="spacer"></div>
        <span class="status" id="status">é€‰æ‹©äº§å“å¼€å§‹åˆ†ç±»</span>
        <button onclick="saveClassification()">ğŸ’¾ ä¿å­˜åˆ†ç±»</button>
        <button onclick="window.location.href='/'">â† è¿”å›</button>
    </div>
    
    <div class="container">
        <div class="unclassified">
            <h2>æœªåˆ†ç±»æˆªå›¾ (<span id="unclassified-count">0</span>)</h2>
            <div class="unclassified-list" id="unclassified-list"></div>
        </div>
        
        <div class="phases" id="phases"></div>
    </div>
    
    <div class="quick-bar" id="quick-bar">
        <span>å·²é€‰ <strong id="selected-count">0</strong> å¼ </span>
        <select id="target-phase">
            <option value="">åˆ†é…åˆ°...</option>
        </select>
        <button class="btn-assign" onclick="assignSelected()">åˆ†é…</button>
        <button class="btn-cancel" onclick="clearSelection()">å–æ¶ˆ</button>
    </div>
    
    <div class="preview-modal" id="preview-modal" onclick="closePreview()">
        <button class="close">Ã—</button>
        <img id="preview-img" src="">
    </div>

    <script>
        // é˜¶æ®µå®šä¹‰
        const PHASES = [
            { id: '01_Launch', name: 'å¯åŠ¨é¡µ', icon: 'ğŸš€' },
            { id: '02_Welcome', name: 'æ¬¢è¿/ä»·å€¼ä¸»å¼ ', icon: 'ğŸ‘‹' },
            { id: '03_Auth', name: 'æ³¨å†Œ/ç™»å½•', icon: 'ğŸ”' },
            { id: '04_Goals', name: 'ç›®æ ‡è®¾ç½®', icon: 'ğŸ¯' },
            { id: '05_Profile', name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ‘¤' },
            { id: '06_Activity', name: 'æ´»åŠ¨æ°´å¹³', icon: 'ğŸƒ' },
            { id: '07_Preference', name: 'åå¥½è®¾ç½®', icon: 'âš™ï¸' },
            { id: '08_Motivation', name: 'æ¿€åŠ±/é¢„æœŸ', icon: 'ğŸ’ª' },
            { id: '09_Permissions', name: 'æƒé™è¯·æ±‚', icon: 'ğŸ””' },
            { id: '10_Paywall', name: 'ä»˜è´¹å¢™', icon: 'ğŸ’°' },
            { id: '11_Home', name: 'é¦–é¡µ/ä»ªè¡¨ç›˜', icon: 'ğŸ ' },
            { id: '12_Logging', name: 'è®°å½•åŠŸèƒ½', icon: 'ğŸ“' },
            { id: '13_Stats', name: 'ç»Ÿè®¡/æŠ¥è¡¨', icon: 'ğŸ“Š' },
            { id: '14_Features', name: 'å…¶ä»–åŠŸèƒ½', icon: 'âœ¨' },
            { id: '15_Social', name: 'ç¤¾äº¤åŠŸèƒ½', icon: 'ğŸ‘¥' },
            { id: '16_Settings', name: 'è®¾ç½®/è´¦æˆ·', icon: 'âš™ï¸' },
        ];
        
        let currentProject = '';
        let allScreens = [];
        let classification = {}; // { phaseId: [filename, ...] }
        let selectedItems = new Set();
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // åŠ è½½é¡¹ç›®åˆ—è¡¨
            const res = await fetch('/api/projects');
            const data = await res.json();
            const select = document.getElementById('project-select');
            data.projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name;
                opt.textContent = p.name.replace('_Analysis', '');
                select.appendChild(opt);
            });
            
            // åˆå§‹åŒ–é˜¶æ®µé€‰æ‹©å™¨
            const targetPhase = document.getElementById('target-phase');
            PHASES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.icon} ${p.name}`;
                targetPhase.appendChild(opt);
            });
            
            // æ¸²æŸ“é˜¶æ®µé¢æ¿
            renderPhases();
        });
        
        async function loadProject() {
            currentProject = document.getElementById('project-select').value;
            if (!currentProject) return;
            
            // åŠ è½½æˆªå›¾
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            allScreens = data.downloads || [];
            
            // åˆå§‹åŒ–åˆ†ç±»ï¼ˆå…¨éƒ¨æœªåˆ†ç±»ï¼‰
            classification = {};
            PHASES.forEach(p => classification[p.id] = []);
            
            // å°è¯•åŠ è½½å·²æœ‰åˆ†ç±»
            await loadExistingClassification();
            
            renderAll();
            updateStatus();
        }
        
        async function loadExistingClassification() {
            // æ£€æŸ¥Screensç›®å½•æ˜¯å¦æœ‰å·²åˆ†ç±»çš„æ–‡ä»¶
            const res = await fetch(`/api/screenshots/${currentProject}`);
            const data = await res.json();
            
            if (data.screens && data.screens.length > 0) {
                // è§£æå·²æœ‰åˆ†ç±»
                data.screens.forEach(filename => {
                    const parts = filename.split('_');
                    if (parts.length >= 2) {
                        const phaseId = `${parts[0]}_${parts[1]}`;
                        if (classification[phaseId]) {
                            // æ‰¾åˆ°å¯¹åº”çš„åŸå§‹æ–‡ä»¶
                            const step = parseInt(parts[2]) || 1;
                            const origFile = `Screen_${String(step).padStart(3, '0')}.png`;
                            if (allScreens.includes(origFile) && !classification[phaseId].includes(origFile)) {
                                classification[phaseId].push(origFile);
                            }
                        }
                    }
                });
            }
        }
        
        function renderPhases() {
            const container = document.getElementById('phases');
            container.innerHTML = PHASES.map(phase => `
                <div class="phase-group" data-phase="${phase.id}">
                    <div class="phase-header">
                        <span class="phase-icon">${phase.icon}</span>
                        <span class="phase-name">${phase.name}</span>
                        <span class="phase-count" id="count-${phase.id}">0</span>
                    </div>
                    <div class="phase-content" 
                         id="phase-${phase.id}"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)"
                         ondrop="handleDrop(event, '${phase.id}')">
                        <div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderAll() {
            renderUnclassified();
            renderClassified();
        }
        
        function renderUnclassified() {
            // æ‰¾å‡ºæœªåˆ†ç±»çš„
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            const unclassified = allScreens.filter(f => !classified.has(f));
            
            document.getElementById('unclassified-count').textContent = unclassified.length;
            
            const list = document.getElementById('unclassified-list');
            list.innerHTML = unclassified.map((file, idx) => {
                const num = file.match(/\d+/)?.[0] || idx;
                return `
                    <div class="unclassified-item ${selectedItems.has(file) ? 'selected' : ''}"
                         draggable="true"
                         data-file="${file}"
                         onclick="toggleSelect('${file}', event)"
                         ondblclick="openPreview('${file}')"
                         ondragstart="handleDragStart(event, '${file}')">
                        <img src="/api/thumb/${currentProject}/downloads/${file}" loading="lazy">
                        <span class="num">${num}</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderClassified() {
            PHASES.forEach(phase => {
                const items = classification[phase.id] || [];
                document.getElementById(`count-${phase.id}`).textContent = items.length;
                
                const container = document.getElementById(`phase-${phase.id}`);
                if (items.length === 0) {
                    container.innerHTML = '<div class="phase-empty">æ‹–æ‹½æˆªå›¾åˆ°è¿™é‡Œ</div>';
                } else {
                    container.innerHTML = items.map(file => `
                        <div class="phase-thumb" data-file="${file}" ondblclick="openPreview('${file}')">
                            <img src="/api/thumb/${currentProject}/downloads/${file}">
                            <div class="remove" onclick="removeFromPhase('${phase.id}', '${file}')">Ã—</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        // é€‰æ‹©
        function toggleSelect(file, event) {
            if (event.shiftKey && selectedItems.size > 0) {
                // Shiftå¤šé€‰
                const unclassified = getUnclassifiedList();
                const lastSelected = Array.from(selectedItems).pop();
                const startIdx = unclassified.indexOf(lastSelected);
                const endIdx = unclassified.indexOf(file);
                const [from, to] = startIdx < endIdx ? [startIdx, endIdx] : [endIdx, startIdx];
                for (let i = from; i <= to; i++) {
                    selectedItems.add(unclassified[i]);
                }
            } else if (event.ctrlKey || event.metaKey) {
                // Ctrlå•é€‰åˆ‡æ¢
                if (selectedItems.has(file)) {
                    selectedItems.delete(file);
                } else {
                    selectedItems.add(file);
                }
            } else {
                // æ™®é€šå•é€‰
                selectedItems.clear();
                selectedItems.add(file);
            }
            
            renderUnclassified();
            updateQuickBar();
        }
        
        function clearSelection() {
            selectedItems.clear();
            renderUnclassified();
            updateQuickBar();
        }
        
        function updateQuickBar() {
            const bar = document.getElementById('quick-bar');
            const count = selectedItems.size;
            document.getElementById('selected-count').textContent = count;
            bar.classList.toggle('show', count > 0);
        }
        
        function assignSelected() {
            const phaseId = document.getElementById('target-phase').value;
            if (!phaseId) { alert('è¯·é€‰æ‹©ç›®æ ‡é˜¶æ®µ'); return; }
            
            selectedItems.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                classification[phaseId].push(file);
            });
            
            selectedItems.clear();
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function getUnclassifiedList() {
            const classified = new Set();
            Object.values(classification).forEach(arr => arr.forEach(f => classified.add(f)));
            return allScreens.filter(f => !classified.has(f));
        }
        
        // æ‹–æ‹½
        let draggedFile = '';
        
        function handleDragStart(event, file) {
            draggedFile = file;
            event.dataTransfer.effectAllowed = 'move';
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(event, phaseId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            if (!draggedFile) return;
            
            // å¦‚æœæœ‰å¤šé€‰ï¼Œç§»åŠ¨æ‰€æœ‰é€‰ä¸­çš„
            const filesToMove = selectedItems.size > 0 && selectedItems.has(draggedFile) 
                ? Array.from(selectedItems) 
                : [draggedFile];
            
            filesToMove.forEach(file => {
                // ä»å…¶ä»–é˜¶æ®µç§»é™¤
                Object.keys(classification).forEach(pid => {
                    const idx = classification[pid].indexOf(file);
                    if (idx > -1) classification[pid].splice(idx, 1);
                });
                // æ·»åŠ åˆ°ç›®æ ‡é˜¶æ®µ
                if (!classification[phaseId].includes(file)) {
                    classification[phaseId].push(file);
                }
            });
            
            selectedItems.clear();
            draggedFile = '';
            renderAll();
            updateQuickBar();
            updateStatus();
        }
        
        function removeFromPhase(phaseId, file) {
            const idx = classification[phaseId].indexOf(file);
            if (idx > -1) {
                classification[phaseId].splice(idx, 1);
                renderAll();
                updateStatus();
            }
        }
        
        // é¢„è§ˆ
        function openPreview(file) {
            document.getElementById('preview-img').src = `/api/screenshot/${currentProject}/downloads/${file}`;
            document.getElementById('preview-modal').classList.add('active');
        }
        
        function closePreview() {
            document.getElementById('preview-modal').classList.remove('active');
        }
        
        // çŠ¶æ€
        function updateStatus() {
            const total = allScreens.length;
            const classified = Object.values(classification).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('status').textContent = `å·²åˆ†ç±» ${classified}/${total} å¼ `;
        }
        
        // ä¿å­˜
        async function saveClassification() {
            if (!currentProject) { alert('è¯·å…ˆé€‰æ‹©äº§å“'); return; }
            
            // æ„å»ºåˆ†ç±»æ•°æ®
            const data = { project: currentProject, classification: {} };
            
            PHASES.forEach(phase => {
                const files = classification[phase.id] || [];
                files.forEach((file, idx) => {
                    const newName = `${phase.id}_${String(idx + 1).padStart(2, '0')}.png`;
                    data.classification[file] = newName;
                });
            });
            
            // å‘é€åˆ°åç«¯
            const res = await fetch('/api/save-classification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await res.json();
            if (result.success) {
                alert(`âœ… ä¿å­˜æˆåŠŸï¼å·²åˆ†ç±» ${result.count} å¼ æˆªå›¾`);
            } else {
                alert(`âŒ ä¿å­˜å¤±è´¥: ${result.error}`);
            }
        }
    </script>
</body>
</html>






























