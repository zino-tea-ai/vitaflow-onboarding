<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="view-transition" content="same-origin">
    <title>App Store ÂïÜÂüéÂØπÊØî - PM Lab</title>
    <!-- Urbanist Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* View Transition - ‰ºòÂåñÂä®ÁîªÈÅÆÁõñÂä†ËΩΩ */
        @view-transition { navigation: auto; }
        
        /* ‰æßËæπÊ†è‰øùÊåÅÈùôÊ≠¢ */
        .sidebar { view-transition-name: sidebar; }
        ::view-transition-old(sidebar),
        ::view-transition-new(sidebar) {
            animation: none;
            mix-blend-mode: normal;
        }
        
        /* ‰∏ªÂÜÖÂÆπÂå∫ - ‰∫§ÂèâÊ∑°ÂÖ•Ê∑°Âá∫ */
        .main { view-transition-name: main-content; }
        ::view-transition-old(main-content) {
            animation: fade-out 0.15s ease-out forwards;
        }
        ::view-transition-new(main-content) {
            animation: fade-in 0.15s ease-in 0.1s forwards;
            opacity: 0;
        }
        @keyframes fade-out {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Êï¥‰ΩìÈ°µÈù¢Êó†Âä®Áîª */
        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
        
        /* Linear Style - White Accent */
        * { font-family: 'Urbanist', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { overflow: hidden; background: #0a0a0a; color: #fff; font-size: 14px; }
        
        /* Layout - Linear Style */
        .app { display: flex; height: 100vh; }
        .sidebar { 
            width: 240px; 
            background: #111111; 
            border-right: 1px solid rgba(255,255,255,0.06); 
            display: flex; 
            flex-direction: column;
            flex-shrink: 0;
        }
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Sidebar - Linear Style */
        .sidebar-header { 
            height: 60px;
            padding: 0 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
        }
        .logo { 
            font-size: 18px; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            color: #fff; 
        }
        
        .sidebar-section { 
            padding: 16px; 
            border-bottom: 1px solid rgba(255,255,255,0.04); 
        }
        .sidebar-section h3 { 
            font-size: 12px; 
            color: #6b7280; 
            margin-bottom: 12px; 
            letter-spacing: 0.02em; 
            font-weight: 500;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        .sidebar-section h3 span {
            font-size: 11px;
            opacity: 0.5;
            font-weight: 400;
        }
        
        /* Navigation - Linear Style */
        .nav-list { display: flex; flex-direction: column; gap: 0; }
        .nav-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 10px 0; 
            border-radius: 0; 
            cursor: pointer; 
            color: #6b7280;
            text-decoration: none;
            transition: all 0.15s ease;
            font-size: 14px;
            border: none;
            border-left: 2px solid transparent;
            margin-left: -16px;
            padding-left: 14px;
            background: none;
        }
        .nav-item:hover { 
            color: #fff;
            background: rgba(255,255,255,0.02);
        }
        .nav-item.active { 
            color: #fff;
            border-left-color: #fff;
            background: rgba(255,255,255,0.03);
        }
        .nav-item .icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; opacity: 0.7; }
        .nav-item.active .icon { opacity: 1; }
        .nav-item .icon svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.5; display: block; }
        .nav-item .nav-en { opacity: 0.5; font-size: 12px; margin-left: 2px; }
        
        /* Sort Options */
        .sort-options { display: flex; flex-direction: column; gap: 6px; }
        .sort-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            color: #9ca3af;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        .sort-option:hover { background: rgba(255,255,255,0.04); }
        .sort-option.active { 
            background: rgba(255,255,255,0.06); 
            color: #fff; 
        }
        .sort-option input { display: none; }
        .sort-radio {
            width: 14px;
            height: 14px;
            border: 2px solid #4b5563;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sort-option.active .sort-radio {
            border-color: #fff;
        }
        .sort-option.active .sort-radio::after {
            content: '';
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
        }
        
        /* Filter Options */
        .filter-options { display: flex; flex-direction: column; gap: 6px; }
        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            color: #9ca3af;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        .filter-option:hover { background: rgba(255,255,255,0.04); }
        .filter-option.active { color: #fff; }
        .filter-checkbox {
            width: 14px;
            height: 14px;
            border: 2px solid #4b5563;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .filter-option.active .filter-checkbox {
            border-color: #fff;
            background: #fff;
            color: #000;
        }
        
        /* Top Bar */
        .topbar { 
            height: 60px; 
            background: #111111; 
            border-bottom: 1px solid rgba(255,255,255,0.06); 
            display: flex; 
            align-items: center; 
            padding: 0 24px; 
            gap: 16px; 
        }
        .topbar-title { 
            font-size: 18px; 
            font-weight: 500; 
            color: #fff;
            letter-spacing: -0.01em;
        }
        .topbar-stats {
            display: flex;
            gap: 20px;
            margin-left: auto;
            font-size: 13px;
            color: #6b7280;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .stat-value {
            color: #fff;
            font-weight: 600;
        }
        
        /* Table Container */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 0;
        }
        
        /* Store Table */
        .store-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }
        
        .store-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .store-table th {
            background: #111111;
            color: #9ca3af;
            font-weight: 600;
            padding: 14px 16px;
            text-align: left;
            border-bottom: 2px solid rgba(255,255,255,0.06);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        
        .store-table th:hover {
            background: rgba(255,255,255,0.04);
        }
        
        .store-table th.sorted {
            color: #fff;
        }
        
        .store-table th .sort-arrow {
            margin-left: 4px;
            opacity: 0.5;
        }
        
        .store-table th.sorted .sort-arrow {
            opacity: 1;
        }
        
        .store-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            vertical-align: middle;
        }
        
        .store-table tbody tr {
            transition: background 0.2s;
        }
        
        .store-table tbody tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        /* App Cell */
        .app-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .app-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .app-info {
            min-width: 0;
        }
        
        .app-name {
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .app-subtitle {
            font-size: 11px;
            color: #6b7280;
            margin-top: 2px;
        }
        
        /* Priority Badge */
        .priority-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .priority-badge.p0 {
            background: rgba(255,255,255,0.1);
            color: #9ca3af;
        }
        .priority-badge.p1 {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }
        
        /* Rating */
        .rating {
            color: #fff;
            font-weight: 600;
        }
        
        /* Revenue */
        .revenue {
            color: #fff;
            font-weight: 600;
        }
        
        /* Growth */
        .growth {
            font-weight: 600;
            color: #9ca3af;
        }
        .growth.positive { color: #9ca3af; }
        .growth.negative { color: #6b7280; }
        
        /* Action Buttons - Linear Style */
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.15);
            background: transparent;
            cursor: pointer;
            font-size: 11px;
            color: #9ca3af;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 6px;
        }
        .action-btn.screenshots {
            background: transparent;
            color: #9ca3af;
            border-color: rgba(255,255,255,0.15);
        }
        .action-btn.screenshots:hover {
            background: rgba(255,255,255,0.04);
            color: #fff;
            border-color: rgba(255,255,255,0.25);
        }
        .action-btn.view {
            background: transparent;
            color: #9ca3af;
            border-color: rgba(255,255,255,0.15);
        }
        .action-btn.view:hover {
            background: rgba(255,255,255,0.04);
            color: #fff;
            border-color: rgba(255,255,255,0.25);
        }
        
        /* Screenshot Modal */
        .screenshot-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        .screenshot-modal.active {
            display: flex;
        }
        .screenshot-modal-content {
            background: #111111;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.06);
            display: flex;
            flex-direction: column;
        }
        .screenshot-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .screenshot-modal-header h3 {
            color: #fff;
            font-size: 16px;
        }
        .screenshot-modal-body {
            padding: 20px;
            overflow: auto;
            display: flex;
            gap: 16px;
            flex-wrap: nowrap;
        }
        .screenshot-item {
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .screenshot-item:hover {
            transform: scale(1.02);
        }
        .screenshot-item img {
            height: 400px;
            border-radius: 8px;
            border: 2px solid transparent;
        }
        .screenshot-item:hover img {
            border-color: rgba(255,255,255,0.3);
        }
        .close-btn {
            background: rgba(255,255,255,0.08);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .close-btn:hover {
            background: #4b5563;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 60px;
            color: #6b7280;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #6b7280;
        }
        
        /* View Options */
        .view-options { display: flex; flex-direction: column; gap: 6px; }
        .view-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            color: #9ca3af;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        .view-option:hover { background: rgba(255,255,255,0.04); }
        .view-option.active {
            background: rgba(255,255,255,0.06);
            color: #fff;
        }
        .view-radio {
            width: 14px;
            height: 14px;
            border: 2px solid #4b5563;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .view-option.active .view-radio {
            border-color: #fff;
        }
        .view-option.active .view-radio::after {
            content: '';
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
        }
        
        /* Screenshots Compare View */
        .screenshots-compare {
            flex: 1;
            overflow: auto;
            background: #0d0d0d;
        }
        
        .screenshots-compare-content {
            padding: 0;
        }
        
        .screenshot-row {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            background: #0d0d0d;
        }
        
        .screenshot-row:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .screenshot-row .row-header {
            width: 220px;
            flex-shrink: 0;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 5;
            border-right: 1px solid rgba(255,255,255,0.06);
        }
        
        .screenshot-row .row-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .screenshot-row .row-info {
            min-width: 0;
            flex: 1;
        }
        
        .screenshot-row .row-name {
            font-weight: 600;
            color: #fff;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .screenshot-row .row-meta {
            font-size: 11px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .screenshot-row .row-meta .revenue {
            color: #fff;
            font-weight: 600;
        }
        
        .screenshot-row .row-meta .rating {
            color: #fff;
        }
        
        .screenshot-row .screenshots-scroll {
            flex: 1;
            display: flex;
            gap: 12px;
            padding: 16px;
            overflow-x: auto;
            align-items: flex-start;
        }
        
        .screenshot-row .screenshots-scroll::-webkit-scrollbar {
            height: 6px;
        }
        
        .screenshot-row .screenshots-scroll::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.04);
            border-radius: 3px;
        }
        
        .screenshot-row .screenshots-scroll::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
        }
        
        .screenshot-thumb {
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
        }
        
        .screenshot-thumb:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.2);
        }
        
        .screenshot-thumb img {
            height: 280px;
            width: auto;
            display: block;
        }
        
        .screenshot-thumb .thumb-index {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .no-screenshots {
            color: #4b5563;
            font-size: 13px;
            padding: 20px;
            text-align: center;
            background: #111111;
            border-radius: 8px;
            min-width: 150px;
        }
        
        /* ==================== Âè≥‰æßÈ¢ÑËßàÈù¢Êùø ==================== */
        .preview-panel {
            position: fixed;
            right: -450px;
            top: 0;
            width: 450px;
            height: 100vh;
            background: #111111;
            border-left: 1px solid rgba(255, 255, 255, 0.06);
            z-index: 100;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 24px rgba(0,0,0,0.5);
        }
        .preview-panel.active {
            right: 0;
        }
        
        .preview-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            gap: 12px;
            background: #0a0a0a;
        }
        .preview-app-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .preview-app-info {
            flex: 1;
            min-width: 0;
        }
        .preview-app-name {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .preview-app-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
        .preview-index {
            font-size: 13px;
            color: #fff;
            font-weight: 600;
            background: rgba(255,255,255,0.08);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Consolas', monospace;
        }
        .preview-close {
            background: none;
            border: none;
            color: #6b7280;
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }
        .preview-close:hover {
            color: #e1e1e1;
        }
        
        .preview-image-container {
            padding: 16px;
            display: flex;
            justify-content: center;
            background: #0a0a0a;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .preview-image {
            max-height: 360px;
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        
        .preview-nav {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 12px;
            background: #0a0a0a;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .preview-nav-btn {
            background: #1a1a1a;
            border: 1px solid rgba(255,255,255,0.1);
            color: #e1e1e1;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .preview-nav-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            color: #fff;
        }
        .preview-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .preview-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 0 16px;
            background: #1a1a1a;
        }
        .preview-tab {
            flex: 1;
            padding: 12px 8px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: #6b7280;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preview-tab:hover {
            color: #e1e1e1;
        }
        .preview-tab.active {
            color: #fff;
            border-bottom-color: #fff;
        }
        
        .preview-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        .preview-tab-pane {
            display: none;
        }
        .preview-tab-pane.active {
            display: block;
        }
        
        /* AI ÂàÜÊûêÊ†∑Âºè */
        .analysis-loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        .analysis-loading .spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .analysis-section {
            margin-bottom: 20px;
        }
        .analysis-section-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #6b7280;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .analysis-section-content {
            font-size: 14px;
            color: #e1e1e1;
            line-height: 1.6;
        }
        .analysis-section-content ul {
            margin: 0;
            padding-left: 20px;
        }
        .analysis-section-content li {
            margin-bottom: 6px;
        }
        
        .analysis-btn {
            width: 100%;
            padding: 12px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .analysis-btn:hover {
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.25);
        }
        .analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .analysis-cached {
            font-size: 11px;
            color: #6b7280;
            text-align: center;
            margin-top: 8px;
        }
        
        /* Âü∫Êú¨‰ø°ÊÅØÊ†∑Âºè */
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #6b7280;
            font-size: 13px;
        }
        .info-value {
            color: #e1e1e1;
            font-size: 13px;
            font-weight: 500;
        }
        
        /* Êà™ÂõæÁº©Áï•ÂõæÂàóË°® */
        .screenshot-thumbs {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
        }
        .screenshot-thumb-small {
            flex-shrink: 0;
            width: 60px;
            height: 130px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            overflow: hidden;
        }
        .screenshot-thumb-small:hover {
            border-color: rgba(255,255,255,0.3);
        }
        .screenshot-thumb-small.active {
            border-color: #fff;
        }
        .screenshot-thumb-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ‰∏ªÂÜÖÂÆπÂå∫Ëá™ÈÄÇÂ∫î */
        .main.preview-active {
            margin-right: 450px;
            transition: margin-right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <div class="sidebar">
            {% if not frame_mode %}
            <div class="sidebar-header">
                <div class="logo">ÂïÜÂüéÂØπÊØî</div>
            </div>
            
            <div class="sidebar-section">
                <h3>ÂØºËà™ <span>Navigation</span></h3>
                <div class="nav-list">
                    <a href="/" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></span>È¶ñÈ°µ <span class="nav-en">Home</span></a>
                    <a href="/sort" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg></span>ÊéíÂ∫è <span class="nav-en">Sort</span></a>
                    <a href="/onboarding" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></span>ÂºïÂØºÊµÅÁ®ã <span class="nav-en">Onboarding</span></a>
                    <a href="/store" class="nav-item active"><span class="icon"><svg viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></span>ÂïÜÂüéÂØπÊØî <span class="nav-en">Store</span></a>
                </div>
            </div>
            {% endif %}
            
            <div class="sidebar-section">
                <h3>ËßÜÂõæÊ®°Âºè <span>View Mode</span></h3>
                <div class="view-options" id="viewOptions">
                    <label class="view-option active" data-view="screenshots">
                        <div class="view-radio"></div>
                        <span>Êà™ÂõæÂØπÊØî</span>
                    </label>
                    <label class="view-option" data-view="table">
                        <div class="view-radio"></div>
                        <span>Ë°®Ê†ºËßÜÂõæ</span>
                    </label>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>ÊéíÂ∫èÊñπÂºè <span>Sort By</span></h3>
                <div class="sort-options" id="sortOptions">
                    <label class="sort-option active" data-sort="revenue">
                        <div class="sort-radio"></div>
                        <span><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5" style="vertical-align:-2px;margin-right:4px;"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>ÊåâÊî∂ÂÖ•ÊéíÂ∫è</span>
                    </label>
                    <label class="sort-option" data-sort="rating">
                        <div class="sort-radio"></div>
                        <span><svg viewBox="0 0 24 24" width="14" height="14" fill="#fbbf24" stroke="none" style="vertical-align:-2px;margin-right:4px;"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>ÊåâËØÑÂàÜÊéíÂ∫è</span>
                    </label>
                    <label class="sort-option" data-sort="rating_count">
                        <div class="sort-radio"></div>
                        <span><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5" style="vertical-align:-2px;margin-right:4px;"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>ÊåâËØÑËÆ∫Êï∞ÊéíÂ∫è</span>
                    </label>
                    <label class="sort-option" data-sort="downloads">
                        <div class="sort-radio"></div>
                        <span><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5" style="vertical-align:-2px;margin-right:4px;"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>Êåâ‰∏ãËΩΩÈáèÊéíÂ∫è</span>
                    </label>
                    <label class="sort-option" data-sort="growth_rate">
                        <div class="sort-radio"></div>
                        <span><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="1.5" style="vertical-align:-2px;margin-right:4px;"><path d="M23 6l-9.5 9.5-5-5L1 18"/><path d="M17 6h6v6"/></svg>ÊåâÂ¢ûÈïøÁéáÊéíÂ∫è</span>
                    </label>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>‰ºòÂÖàÁ∫ßÁ≠õÈÄâ <span>Priority</span></h3>
                <div class="filter-options" id="filterOptions">
                    <label class="filter-option active" data-filter="P0">
                        <div class="filter-checkbox">‚úì</div>
                        <span>P0 - Ê†∏ÂøÉÁ´ûÂìÅ</span>
                    </label>
                    <label class="filter-option active" data-filter="P1">
                        <div class="filter-checkbox">‚úì</div>
                        <span>P1 - ÈáçË¶ÅÁ´ûÂìÅ</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main">
            <div class="topbar">
                <div class="topbar-title">Á´ûÂìÅ App Store Êï∞ÊçÆÂØπÊØî</div>
                <div class="topbar-stats">
                    <div class="stat-item">
                        <span>ÂÖ±</span>
                        <span class="stat-value" id="totalCount">0</span>
                        <span>‰∏™Â∫îÁî®</span>
                    </div>
                    <div class="stat-item">
                        <span>ÊÄªÊî∂ÂÖ•</span>
                        <span class="stat-value" id="totalRevenue">$0</span>
                    </div>
                </div>
            </div>
            
            <div class="table-container" id="tableContainer" style="display: none;">
                <table class="store-table" id="storeTable">
                    <thead>
                        <tr>
                            <th data-sort="name">Â∫îÁî® <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="priority">‰ºòÂÖàÁ∫ß <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="revenue" class="sorted">Êî∂ÂÖ• <span class="sort-arrow">‚Üì</span></th>
                            <th data-sort="downloads">‰∏ãËΩΩÈáè <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="rating">ËØÑÂàÜ <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="rating_count">ËØÑËÆ∫Êï∞ <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="growth_rate">Â¢ûÈïøÁéá <span class="sort-arrow">‚Üï</span></th>
                            <th data-sort="screenshot_count">ÂïÜÂüéÊà™Âõæ <span class="sort-arrow">‚Üï</span></th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="9" class="loading">Âä†ËΩΩ‰∏≠...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Êà™ÂõæÂØπÊØîËßÜÂõæ -->
            <div class="screenshots-compare" id="screenshotsCompare">
                <div class="screenshots-compare-content" id="screenshotsCompareContent">
                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Âè≥‰æßÈ¢ÑËßàÈù¢Êùø -->
    <div class="preview-panel" id="previewPanel">
        <div class="preview-header">
            <img class="preview-app-icon" id="previewAppIcon" src="" alt="">
            <div class="preview-app-info">
                <div class="preview-app-name" id="previewAppName">App Name</div>
                <div class="preview-app-meta" id="previewAppMeta">Developer</div>
            </div>
            <span class="preview-index" id="previewIndex">#1/10</span>
            <button class="preview-close" onclick="closePreviewPanel()">√ó</button>
        </div>
        
        <div class="preview-image-container">
            <img class="preview-image" id="previewImage" src="" alt="">
        </div>
        
        <div class="preview-nav">
            <button class="preview-nav-btn" id="prevBtn" onclick="navigateScreenshot(-1)">‚Üê ‰∏ä‰∏ÄÂº†</button>
            <button class="preview-nav-btn" id="nextBtn" onclick="navigateScreenshot(1)">‰∏ã‰∏ÄÂº† ‚Üí</button>
        </div>
        
        <div class="preview-tabs">
            <button class="preview-tab active" data-tab="analysis" onclick="switchPreviewTab('analysis')">AI ÂàÜÊûê</button>
            <button class="preview-tab" data-tab="info" onclick="switchPreviewTab('info')">üìã Âü∫Êú¨‰ø°ÊÅØ</button>
            <button class="preview-tab" data-tab="screenshots" onclick="switchPreviewTab('screenshots')">ÂÖ®ÈÉ®Êà™Âõæ</button>
        </div>
        
        <div class="preview-content">
            <!-- AI ÂàÜÊûê Tab -->
            <div class="preview-tab-pane active" id="tabAnalysis">
                <div id="analysisContent">
                    <button class="analysis-btn" id="analyzeBtn" onclick="analyzeCurrentScreenshot()">
                        ÂºÄÂßã AI ÂàÜÊûê
                    </button>
                    <p style="text-align:center; color:#6b7280; font-size:12px; margin-top:12px;">
                        ÂàÜÊûêËê•ÈîÄÁ≠ñÁï•„ÄÅËÆæËÆ°ÂÖÉÁ¥†„ÄÅASO Ê¥ûÂØü
                    </p>
                </div>
            </div>
            
            <!-- Âü∫Êú¨‰ø°ÊÅØ Tab -->
            <div class="preview-tab-pane" id="tabInfo">
                <div class="info-item">
                    <span class="info-label">Â∫îÁî®ÂêçÁß∞</span>
                    <span class="info-value" id="infoTrackName">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ÂºÄÂèëËÄÖ</span>
                    <span class="info-value" id="infoDeveloper">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ËØÑÂàÜ</span>
                    <span class="info-value" id="infoRating">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">ËØÑËÆ∫Êï∞</span>
                    <span class="info-value" id="infoRatingCount">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Êî∂ÂÖ•</span>
                    <span class="info-value" id="infoRevenue">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">‰∏ãËΩΩÈáè</span>
                    <span class="info-value" id="infoDownloads">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Êà™ÂõæÊï∞Èáè</span>
                    <span class="info-value" id="infoScreenshotCount">-</span>
                </div>
            </div>
            
            <!-- ÂÖ®ÈÉ®Êà™Âõæ Tab -->
            <div class="preview-tab-pane" id="tabScreenshots">
                <div class="screenshot-thumbs" id="screenshotThumbs">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Screenshot Modal -->
    <div class="screenshot-modal" id="screenshotModal">
        <div class="screenshot-modal-content">
            <div class="screenshot-modal-header">
                <h3 id="modalTitle">ÂïÜÂüéÊà™Âõæ</h3>
                <button class="close-btn" onclick="closeModal()">‚úï ÂÖ≥Èó≠</button>
            </div>
            <div class="screenshot-modal-body" id="modalBody">
            </div>
        </div>
    </div>
    
    <script>
        let allData = [];
        let filteredData = [];
        let currentSort = 'revenue';
        let sortDirection = 'desc';
        let activeFilters = new Set(['P0', 'P1']);
        let currentView = 'screenshots';  // 'screenshots' Êàñ 'table'
        let screenshotsCache = {};  // ÁºìÂ≠òÊà™ÂõæÊï∞ÊçÆ
        
        // Âä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            try {
                const res = await fetch('/api/store-comparison');
                if (!res.ok) throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                const data = await res.json();
                allData = data.apps || [];
                applyFiltersAndSort();
            } catch (e) {
                document.getElementById('tableBody').innerHTML = 
                    '<tr><td colspan="9" class="empty-state">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÂÖàËøêË°å fetch_store_data.py ËÑöÊú¨</td></tr>';
            }
        }
        
        // Â∫îÁî®Á≠õÈÄâÂíåÊéíÂ∫è
        function applyFiltersAndSort() {
            // Á≠õÈÄâ
            filteredData = allData.filter(app => {
                const priority = app.priority || 'P1';
                return activeFilters.has(priority);
            });
            
            // ÊéíÂ∫è
            filteredData.sort((a, b) => {
                let aVal = a[currentSort] || 0;
                let bVal = b[currentSort] || 0;
                
                // Â≠óÁ¨¶‰∏≤ÊéíÂ∫è
                if (currentSort === 'name' || currentSort === 'priority') {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    return sortDirection === 'asc' ? 
                        aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                
                // Êï∞Â≠óÊéíÂ∫è
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            renderTable();
            updateStats();
        }
        
        // Ê∏≤ÊüìË°®Ê†º
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state">Ê≤°ÊúâÂåπÈÖçÁöÑÊï∞ÊçÆ</td></tr>';
                return;
            }
            
            let html = '';
            for (const app of filteredData) {
                const rating = app.rating ? app.rating.toFixed(1) : 'N/A';
                const ratingCount = app.rating_count ? app.rating_count.toLocaleString() : 'N/A';
                const revenue = app.revenue ? `$${(app.revenue / 1000).toFixed(0)}K` : 'N/A';
                const downloads = app.downloads ? `${(app.downloads / 1000).toFixed(0)}K` : 'N/A';
                const growth = app.growth_rate || 0;
                const growthClass = growth >= 0 ? 'positive' : 'negative';
                const growthSign = growth >= 0 ? '+' : '';
                const priority = app.priority || 'P1';
                const priorityClass = priority.toLowerCase();
                const screenshotCount = app.screenshot_count || 0;
                
                html += `
                    <tr>
                        <td>
                            <div class="app-cell">
                                <img class="app-icon" src="/api/store-screenshot/${app.name}/icon.png" 
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 44 44%22><rect fill=%22%23374151%22 width=%2244%22 height=%2244%22 rx=%2210%22/><text x=%2222%22 y=%2228%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2216%22>${app.name ? app.name[0] : '?'}</text></svg>'" 
                                     alt="${app.name}">
                                <div class="app-info">
                                    <div class="app-name">${app.track_name || app.name}</div>
                                    <div class="app-subtitle">${app.developer || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td><span class="priority-badge ${priorityClass}">${priority}</span></td>
                        <td><span class="revenue">${revenue}</span></td>
                        <td>${downloads}</td>
                        <td><span class="rating"><svg viewBox="0 0 24 24" width="12" height="12" fill="#fbbf24" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ${rating}</span></td>
                        <td>${ratingCount}</td>
                        <td><span class="growth ${growthClass}">${growthSign}${growth.toFixed(1)}%</span></td>
                        <td>${screenshotCount} Âº†</td>
                        <td>
                            ${screenshotCount > 0 ? 
                                `<button class="action-btn screenshots" onclick="showScreenshots('${app.name}')">Êà™Âõæ</button>` : ''}
                            <button class="action-btn view" onclick="viewApp('${app.name}')">Êü•Áúã</button>
                        </td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats() {
            document.getElementById('totalCount').textContent = filteredData.length;
            
            const totalRevenue = filteredData.reduce((sum, app) => sum + (app.revenue || 0), 0);
            document.getElementById('totalRevenue').textContent = `$${(totalRevenue / 1000000).toFixed(1)}M`;
        }
        
        // ÊéíÂ∫èÈÄâÈ°πÁÇπÂáª
        document.getElementById('sortOptions').addEventListener('click', function(e) {
            const option = e.target.closest('.sort-option');
            if (!option) return;
            
            const sortField = option.dataset.sort;
            
            // Êõ¥Êñ∞ UI
            document.querySelectorAll('.sort-option').forEach(el => el.classList.remove('active'));
            option.classList.add('active');
            
            // Êõ¥Êñ∞ÊéíÂ∫è
            if (currentSort === sortField) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = sortField;
                sortDirection = 'desc';
            }
            
            applyFiltersAndSort();
            updateTableHeaders();
        });
        
        // Á≠õÈÄâÈÄâÈ°πÁÇπÂáª
        document.getElementById('filterOptions').addEventListener('click', function(e) {
            const option = e.target.closest('.filter-option');
            if (!option) return;
            
            const filter = option.dataset.filter;
            
            if (activeFilters.has(filter)) {
                activeFilters.delete(filter);
                option.classList.remove('active');
            } else {
                activeFilters.add(filter);
                option.classList.add('active');
            }
            
            applyFiltersAndSort();
        });
        
        // Ë°®Â§¥ÁÇπÂáªÊéíÂ∫è
        document.querySelector('.store-table thead').addEventListener('click', function(e) {
            const th = e.target.closest('th');
            if (!th || !th.dataset.sort) return;
            
            const sortField = th.dataset.sort;
            
            if (currentSort === sortField) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = sortField;
                sortDirection = 'desc';
            }
            
            // Êõ¥Êñ∞‰æßËæπÊ†è
            document.querySelectorAll('.sort-option').forEach(el => {
                el.classList.toggle('active', el.dataset.sort === currentSort);
            });
            
            applyFiltersAndSort();
            updateTableHeaders();
        });
        
        // Êõ¥Êñ∞Ë°®Â§¥Ê†∑Âºè
        function updateTableHeaders() {
            document.querySelectorAll('.store-table th').forEach(th => {
                const isCurrentSort = th.dataset.sort === currentSort;
                th.classList.toggle('sorted', isCurrentSort);
                
                const arrow = th.querySelector('.sort-arrow');
                if (arrow) {
                    if (isCurrentSort) {
                        arrow.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                    } else {
                        arrow.textContent = '‚Üï';
                    }
                }
            });
        }
        
        // ÊòæÁ§∫Êà™Âõæ
        async function showScreenshots(appName) {
            const modal = document.getElementById('screenshotModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = `${appName} ÂïÜÂüéÊà™Âõæ`;
            body.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            modal.classList.add('active');
            
            try {
                const res = await fetch(`/api/store-info/${appName}`);
                const data = await res.json();
                
                if (data.local_screenshots && data.local_screenshots.length > 0) {
                    let html = '';
                    for (const filename of data.local_screenshots) {
                        html += `
                            <div class="screenshot-item" onclick="window.open('/api/store-screenshot/${appName}/${filename}', '_blank')">
                                <img src="/api/store-screenshot/${appName}/${filename}" alt="${filename}">
                            </div>
                        `;
                    }
                    body.innerHTML = html;
                } else {
                    body.innerHTML = '<div class="empty-state">ÊöÇÊó†ÂïÜÂüéÊà™Âõæ</div>';
                }
            } catch (e) {
                body.innerHTML = '<div class="empty-state">Âä†ËΩΩÂ§±Ë¥•</div>';
            }
        }
        
        // ÂÖ≥Èó≠ÂºπÁ™ó
        function closeModal() {
            document.getElementById('screenshotModal').classList.remove('active');
        }
        
        // Êü•ÁúãÂ∫îÁî®
        function viewApp(appName) {
            window.location.href = `/sort?project=downloads_2024/${appName}`;
        }
        
        // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
        document.getElementById('screenshotModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // ESC ÂÖ≥Èó≠ÂºπÁ™ó
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // ËßÜÂõæÂàáÊç¢ÁÇπÂáª
        document.getElementById('viewOptions').addEventListener('click', function(e) {
            const option = e.target.closest('.view-option');
            if (!option) return;
            
            const view = option.dataset.view;
            if (view === currentView) return;
            
            // Êõ¥Êñ∞ UI
            document.querySelectorAll('.view-option').forEach(el => el.classList.remove('active'));
            option.classList.add('active');
            
            // ÂàáÊç¢ËßÜÂõæ
            currentView = view;
            switchView();
        });
        
        // ÂàáÊç¢ËßÜÂõæ
        function switchView() {
            const tableContainer = document.getElementById('tableContainer');
            const screenshotsCompare = document.getElementById('screenshotsCompare');

            if (currentView === 'table') {
                tableContainer.style.display = 'block';
                screenshotsCompare.style.display = 'none';
                renderTable();  // ÂàáÊç¢Âà∞Ë°®Ê†ºËßÜÂõæÊó∂Ê∏≤ÊüìË°®Ê†º
            } else {
                tableContainer.style.display = 'none';
                screenshotsCompare.style.display = 'block';
                renderScreenshotsCompare();
            }
        }
        
        // Ê∏≤ÊüìÊà™ÂõæÂØπÊØîËßÜÂõæ
        async function renderScreenshotsCompare() {
            const container = document.getElementById('screenshotsCompareContent');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="empty-state">Ê≤°ÊúâÂåπÈÖçÁöÑÊï∞ÊçÆ</div>';
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩ‰∏≠
            container.innerHTML = '<div class="loading">Âä†ËΩΩÊà™ÂõæÊï∞ÊçÆ‰∏≠...</div>';
            
            // È¢ÑÂä†ËΩΩÊâÄÊúâÊà™ÂõæÊï∞ÊçÆ
            const loadPromises = filteredData.map(app => loadAppScreenshots(app.name));
            await Promise.all(loadPromises);
            
            // Ê∏≤Êüì
            let html = '';
            for (const app of filteredData) {
                const screenshots = screenshotsCache[app.name] || [];
                const revenue = app.revenue ? `$${(app.revenue / 1000).toFixed(0)}K` : 'N/A';
                const rating = app.rating ? app.rating.toFixed(1) : 'N/A';
                
                html += `
                    <div class="screenshot-row">
                        <div class="row-header">
                            <img class="row-icon" src="/api/store-screenshot/${app.name}/icon.png" 
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 48 48%22><rect fill=%22%23374151%22 width=%2248%22 height=%2248%22 rx=%2212%22/><text x=%2224%22 y=%2230%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2218%22>${app.name ? app.name[0] : '?'}</text></svg>'" 
                                 alt="${app.name}">
                            <div class="row-info">
                                <div class="row-name" title="${app.track_name || app.name}">${app.track_name || app.name}</div>
                                <div class="row-meta">
                                    <span class="revenue">${revenue}</span>
                                    <span class="rating"><svg viewBox="0 0 24 24" width="12" height="12" fill="#fbbf24" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ${rating}</span>
                                    <span>${screenshots.length} Âº†Êà™Âõæ</span>
                                </div>
                            </div>
                        </div>
                        <div class="screenshots-scroll">
                            ${screenshots.length > 0 ? 
                                screenshots.map((filename, idx) => `
                                    <div class="screenshot-thumb" onclick="window.open('/api/store-screenshot/${app.name}/${filename}', '_blank')">
                                        <img src="/api/store-screenshot/${app.name}/${filename}" alt="${filename}" loading="lazy">
                                    </div>
                                `).join('') : 
                                '<div class="no-screenshots">ÊöÇÊó†ÂïÜÂüéÊà™Âõæ</div>'
                            }
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Âä†ËΩΩÂçï‰∏™ APP ÁöÑÊà™ÂõæÂàóË°®
        async function loadAppScreenshots(appName) {
            if (screenshotsCache[appName]) return;
            
            try {
                const res = await fetch(`/api/store-info/${appName}`);
                const data = await res.json();
                screenshotsCache[appName] = data.local_screenshots || [];
            } catch (e) {
                screenshotsCache[appName] = [];
            }
        }
        
        // ‰øÆÊîπ applyFiltersAndSort ‰ª•ÊîØÊåÅËßÜÂõæÂà∑Êñ∞
        const originalApplyFiltersAndSort = applyFiltersAndSort;
        applyFiltersAndSort = function() {
            // Á≠õÈÄâ
            filteredData = allData.filter(app => {
                const priority = app.priority || 'P1';
                return activeFilters.has(priority);
            });
            
            // ÊéíÂ∫è
            filteredData.sort((a, b) => {
                let aVal = a[currentSort] || 0;
                let bVal = b[currentSort] || 0;
                
                if (currentSort === 'name' || currentSort === 'priority') {
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    return sortDirection === 'asc' ? 
                        aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            // Ê†πÊçÆÂΩìÂâçËßÜÂõæÂà∑Êñ∞
            if (currentView === 'table') {
                renderTable();
            } else {
                renderScreenshotsCompare();
            }
            updateStats();
        };
        
        // ==================== È¢ÑËßàÈù¢ÊùøÁõ∏ÂÖ≥ ====================
        
        let previewState = {
            appName: null,
            appData: null,
            screenshots: [],
            currentIndex: 0,
            analysisCache: {}  // ÂâçÁ´ØÁºìÂ≠ò
        };
        
        // ÊâìÂºÄÈ¢ÑËßàÈù¢Êùø
        function openPreviewPanel(appName, filename, index) {
            const app = filteredData.find(a => a.name === appName);
            if (!app) return;
            
            previewState.appName = appName;
            previewState.appData = app;
            previewState.screenshots = screenshotsCache[appName] || [];
            previewState.currentIndex = index || 0;
            
            // Êõ¥Êñ∞Èù¢ÊùøÂÜÖÂÆπ
            updatePreviewPanel();
            
            // ÊòæÁ§∫Èù¢Êùø
            document.getElementById('previewPanel').classList.add('active');
            document.querySelector('.main').classList.add('preview-active');
        }
        
        // ÂÖ≥Èó≠È¢ÑËßàÈù¢Êùø
        function closePreviewPanel() {
            document.getElementById('previewPanel').classList.remove('active');
            document.querySelector('.main').classList.remove('preview-active');
        }
        
        // Êõ¥Êñ∞È¢ÑËßàÈù¢ÊùøÂÜÖÂÆπ
        function updatePreviewPanel() {
            const app = previewState.appData;
            const screenshots = previewState.screenshots;
            const idx = previewState.currentIndex;
            const filename = screenshots[idx];
            
            // Êõ¥Êñ∞Â§¥ÈÉ®‰ø°ÊÅØ
            document.getElementById('previewAppIcon').src = `/api/store-screenshot/${app.name}/icon.png`;
            document.getElementById('previewAppIcon').onerror = function() {
                this.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 44"><rect fill="%23374151" width="44" height="44" rx="10"/><text x="22" y="28" text-anchor="middle" fill="white" font-size="16">${app.name ? app.name[0] : '?'}</text></svg>`;
            };
            document.getElementById('previewAppName').textContent = app.track_name || app.name;
            document.getElementById('previewAppMeta').textContent = app.developer || '';
            document.getElementById('previewIndex').textContent = `#${idx + 1}/${screenshots.length}`;
            
            // Êõ¥Êñ∞‰∏ªÂõæÁâá
            if (filename) {
                document.getElementById('previewImage').src = `/api/store-screenshot/${app.name}/${filename}`;
            }
            
            // Êõ¥Êñ∞ÂØºËà™ÊåâÈíÆ
            document.getElementById('prevBtn').disabled = idx === 0;
            document.getElementById('nextBtn').disabled = idx >= screenshots.length - 1;
            
            // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ Tab
            document.getElementById('infoTrackName').textContent = app.track_name || app.name;
            document.getElementById('infoDeveloper').textContent = app.developer || '-';
            document.getElementById('infoRating').innerHTML = app.rating ? `<svg viewBox="0 0 24 24" width="12" height="12" fill="#fbbf24" stroke="none" style="vertical-align:-1px;"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ${app.rating.toFixed(1)}` : '-';
            document.getElementById('infoRatingCount').textContent = app.rating_count ? app.rating_count.toLocaleString() : '-';
            document.getElementById('infoRevenue').textContent = app.revenue ? `$${(app.revenue / 1000).toFixed(0)}K` : '-';
            document.getElementById('infoDownloads').textContent = app.downloads ? `${(app.downloads / 1000).toFixed(0)}K` : '-';
            document.getElementById('infoScreenshotCount').textContent = `${screenshots.length} Âº†`;
            
            // Êõ¥Êñ∞Êà™ÂõæÁº©Áï•ÂõæÂàóË°®
            const thumbsContainer = document.getElementById('screenshotThumbs');
            thumbsContainer.innerHTML = screenshots.map((fname, i) => `
                <div class="screenshot-thumb-small ${i === idx ? 'active' : ''}" onclick="jumpToScreenshot(${i})">
                    <img src="/api/store-screenshot/${app.name}/${fname}" alt="${fname}">
                </div>
            `).join('');
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÁºìÂ≠òÁöÑÂàÜÊûêÁªìÊûú
            const cacheKey = `${app.name}_${filename}`;
            if (previewState.analysisCache[cacheKey]) {
                displayAnalysis(previewState.analysisCache[cacheKey]);
            } else {
                // ÈáçÁΩÆÂàÜÊûêÂå∫Âüü
                document.getElementById('analysisContent').innerHTML = `
                    <button class="analysis-btn" id="analyzeBtn" onclick="analyzeCurrentScreenshot()">
                        ÂºÄÂßã AI ÂàÜÊûê
                    </button>
                    <p style="text-align:center; color:#6b7280; font-size:12px; margin-top:12px;">
                        ÂàÜÊûêËê•ÈîÄÁ≠ñÁï•„ÄÅËÆæËÆ°ÂÖÉÁ¥†„ÄÅASO Ê¥ûÂØü
                    </p>
                `;
                // Ê£ÄÊü•ÊúçÂä°Á´ØÁºìÂ≠ò
                checkServerCache(app.name, filename);
            }
        }
        
        // Ê£ÄÊü•ÊúçÂä°Á´ØÁºìÂ≠ò
        async function checkServerCache(appName, filename) {
            try {
                const res = await fetch(`/api/store-analysis-cache/${appName}/${filename}`);
                const data = await res.json();
                if (data.success) {
                    const cacheKey = `${appName}_${filename}`;
                    previewState.analysisCache[cacheKey] = data;
                    displayAnalysis(data);
                }
            } catch (e) {
                // ÂøΩÁï•ÈîôËØØ
            }
        }
        
        // ÂØºËà™Êà™Âõæ
        function navigateScreenshot(delta) {
            const newIndex = previewState.currentIndex + delta;
            if (newIndex >= 0 && newIndex < previewState.screenshots.length) {
                previewState.currentIndex = newIndex;
                updatePreviewPanel();
            }
        }
        
        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÊà™Âõæ
        function jumpToScreenshot(index) {
            previewState.currentIndex = index;
            updatePreviewPanel();
        }
        
        // ÂàáÊç¢È¢ÑËßàÈù¢Êùø Tab
        function switchPreviewTab(tabName) {
            document.querySelectorAll('.preview-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            document.querySelectorAll('.preview-tab-pane').forEach(pane => {
                pane.classList.toggle('active', pane.id === `tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            });
        }
        
        // AI ÂàÜÊûêÂΩìÂâçÊà™Âõæ
        async function analyzeCurrentScreenshot() {
            const app = previewState.appData;
            const filename = previewState.screenshots[previewState.currentIndex];
            
            if (!app || !filename) return;
            
            const analysisContent = document.getElementById('analysisContent');
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            analysisContent.innerHTML = `
                <div class="analysis-loading">
                    <div class="spinner"></div>
                    <p>AI Ê≠£Âú®ÂàÜÊûê‰∏≠...</p>
                    <p style="font-size:11px; color:#4b5563; margin-top:8px;">ÂàÜÊûêËê•ÈîÄÁ≠ñÁï•„ÄÅËÆæËÆ°ÂÖÉÁ¥†„ÄÅASO Ê¥ûÂØü</p>
                </div>
            `;
            
            try {
                const res = await fetch('/api/analyze-store-screenshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        app_name: app.name,
                        filename: filename
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    // ÁºìÂ≠òÁªìÊûú
                    const cacheKey = `${app.name}_${filename}`;
                    previewState.analysisCache[cacheKey] = data;
                    displayAnalysis(data);
                } else {
                    analysisContent.innerHTML = `
                        <div style="text-align:center; color:#ef4444; padding:20px;">
                            <p>ÂàÜÊûêÂ§±Ë¥•</p>
                            <p style="font-size:12px; color:#6b7280; margin-top:8px;">${data.error || 'Êú™Áü•ÈîôËØØ'}</p>
                            <button class="analysis-btn" style="margin-top:16px;" onclick="analyzeCurrentScreenshot()">
                                ÈáçËØï
                            </button>
                        </div>
                    `;
                }
            } catch (e) {
                analysisContent.innerHTML = `
                    <div style="text-align:center; color:#ef4444; padding:20px;">
                        <p>ÁΩëÁªúÈîôËØØ</p>
                        <button class="analysis-btn" style="margin-top:16px;" onclick="analyzeCurrentScreenshot()">
                            ÈáçËØï
                        </button>
                    </div>
                `;
            }
        }
        
        // ÊòæÁ§∫ÂàÜÊûêÁªìÊûú
        function displayAnalysis(data) {
            const analysisContent = document.getElementById('analysisContent');
            
            // Â∞Ü markdown Ê†ºÂºèÁöÑÂàÜÊûêÁªìÊûúËΩ¨Êç¢‰∏∫ HTML
            let analysisHtml = data.analysis
                .replace(/## 1\. Ëê•ÈîÄÁ≠ñÁï•.*?\n/g, '<div class="analysis-section"><div class="analysis-section-title">Ëê•ÈîÄÁ≠ñÁï•</div><div class="analysis-section-content">')
                .replace(/## 2\. ËÆæËÆ°ÂÖÉÁ¥†.*?\n/g, '</div></div><div class="analysis-section"><div class="analysis-section-title">ËÆæËÆ°ÂÖÉÁ¥†</div><div class="analysis-section-content">')
                .replace(/## 3\. ASO Ê¥ûÂØü.*?\n/g, '</div></div><div class="analysis-section"><div class="analysis-section-title">üîç ASO Ê¥ûÂØü</div><div class="analysis-section-content">')
                .replace(/\n- /g, '<br>‚Ä¢ ')
                .replace(/\n/g, '<br>');
            
            // Á°Æ‰øùÈó≠ÂêàÊ†áÁ≠æ
            if (!analysisHtml.endsWith('</div></div>')) {
                analysisHtml += '</div></div>';
            }
            
            analysisContent.innerHTML = `
                ${analysisHtml}
                ${data.from_cache ? '<p class="analysis-cached">‚úì Êù•Ëá™ÁºìÂ≠ò</p>' : ''}
                <button class="analysis-btn" style="margin-top:16px; background:#374151;" onclick="analyzeCurrentScreenshot()">
                    ÈáçÊñ∞ÂàÜÊûê
                </button>
            `;
        }
        
        // ‰øÆÊîπÊà™ÂõæÂØπÊØîËßÜÂõæ‰∏≠ÁöÑÁÇπÂáª‰∫ã‰ª∂
        const originalRenderScreenshotsCompare = renderScreenshotsCompare;
        renderScreenshotsCompare = async function() {
            const container = document.getElementById('screenshotsCompareContent');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="empty-state">Ê≤°ÊúâÂåπÈÖçÁöÑÊï∞ÊçÆ</div>';
                return;
            }
            
            container.innerHTML = '<div class="loading">Âä†ËΩΩÊà™ÂõæÊï∞ÊçÆ‰∏≠...</div>';
            
            const loadPromises = filteredData.map(app => loadAppScreenshots(app.name));
            await Promise.all(loadPromises);
            
            let html = '';
            for (const app of filteredData) {
                const screenshots = screenshotsCache[app.name] || [];
                const revenue = app.revenue ? `$${(app.revenue / 1000).toFixed(0)}K` : 'N/A';
                const rating = app.rating ? app.rating.toFixed(1) : 'N/A';
                
                html += `
                    <div class="screenshot-row">
                        <div class="row-header">
                            <img class="row-icon" src="/api/store-screenshot/${app.name}/icon.png" 
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 48 48%22><rect fill=%22%23374151%22 width=%2248%22 height=%2248%22 rx=%2212%22/><text x=%2224%22 y=%2230%22 text-anchor=%22middle%22 fill=%22white%22 font-size=%2218%22>${app.name ? app.name[0] : '?'}</text></svg>'" 
                                 alt="${app.name}">
                            <div class="row-info">
                                <div class="row-name" title="${app.track_name || app.name}">${app.track_name || app.name}</div>
                                <div class="row-meta">
                                    <span class="revenue">${revenue}</span>
                                    <span class="rating"><svg viewBox="0 0 24 24" width="12" height="12" fill="#fbbf24" stroke="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg> ${rating}</span>
                                    <span>${screenshots.length} Âº†Êà™Âõæ</span>
                                </div>
                            </div>
                        </div>
                        <div class="screenshots-scroll">
                            ${screenshots.length > 0 ? 
                                screenshots.map((filename, idx) => `
                                    <div class="screenshot-thumb" onclick="openPreviewPanel('${app.name}', '${filename}', ${idx})">
                                        <img src="/api/store-screenshot/${app.name}/${filename}" alt="${filename}" loading="lazy">
                                    </div>
                                `).join('') : 
                                '<div class="no-screenshots">ÊöÇÊó†ÂïÜÂüéÊà™Âõæ</div>'
                            }
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        };
        
        // ÈîÆÁõòÂØºËà™
        document.addEventListener('keydown', function(e) {
            // È¢ÑËßàÈù¢ÊùøÊâìÂºÄÊó∂ÁöÑÈîÆÁõòÂØºËà™
            if (document.getElementById('previewPanel').classList.contains('active')) {
                if (e.key === 'ArrowLeft') {
                    navigateScreenshot(-1);
                    e.preventDefault();
                } else if (e.key === 'ArrowRight') {
                    navigateScreenshot(1);
                    e.preventDefault();
                } else if (e.key === 'Escape') {
                    closePreviewPanel();
                    e.preventDefault();
                }
            }
        });
        
        // ÂàùÂßãÂåñ
        loadData();
    </script>
</body>
</html>

