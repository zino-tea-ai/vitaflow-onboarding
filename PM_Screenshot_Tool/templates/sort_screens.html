<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="view-transition" content="same-origin">
    <title>æˆªå›¾æ’åºä¸ç­›é€‰å·¥å…·</title>
    <!-- Urbanist Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* View Transition - ä¼˜åŒ–åŠ¨ç”»é®ç›–åŠ è½½ */
        @view-transition { navigation: auto; }
        
        /* ä¾§è¾¹æ ä¿æŒé™æ­¢ */
        .sidebar { view-transition-name: sidebar; }
        ::view-transition-old(sidebar),
        ::view-transition-new(sidebar) {
            animation: none;
            mix-blend-mode: normal;
        }
        
        /* ä¸»å†…å®¹åŒº - äº¤å‰æ·¡å…¥æ·¡å‡º */
        .main-content { view-transition-name: main-content; }
        ::view-transition-old(main-content) {
            animation: fade-out 0.15s ease-out forwards;
        }
        ::view-transition-new(main-content) {
            animation: fade-in 0.15s ease-in 0.1s forwards;
            opacity: 0;
        }
        @keyframes fade-out {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* æ•´ä½“é¡µé¢æ— åŠ¨ç”» */
        ::view-transition-old(root),
        ::view-transition-new(root) {
            animation: none;
            mix-blend-mode: normal;
        }
        
        /* Linear Style - White Accent */
        * { font-family: 'Urbanist', -apple-system, BlinkMacSystemFont, sans-serif; }
        body { overflow: hidden; background: #0a0a0a; color: #fff; font-size: 14px; }
        
        /* ==================== å¸ƒå±€ - Linear Style (ä¸ Onboarding ä¸€è‡´) ==================== */
        .app { display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar {
            width: 240px;
            background: #111111;
            border-right: 1px solid rgba(255,255,255,0.06);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }
        
        .sidebar-header {
            height: 60px;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
        }
        
        .sidebar-header .logo {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        
        .sidebar-section h3 {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 12px;
            letter-spacing: 0.02em;
            font-weight: 500;
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        .sidebar-section h3 span {
            font-size: 11px;
            opacity: 0.5;
            font-weight: 400;
        }
        
        /* å¯¼èˆªåˆ—è¡¨ - Linear Style (ä¸ Onboarding ä¸€è‡´) */
        .nav-list { display: flex; flex-direction: column; gap: 0; }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-radius: 0;
            cursor: pointer;
            color: #6b7280;
            text-decoration: none;
            transition: all 0.15s ease;
            font-size: 14px;
            border: none;
            border-left: 2px solid transparent;
            margin-left: -16px;
            padding-left: 14px;
            background: none;
        }
        .nav-item:hover {
            color: #fff;
            background: rgba(255,255,255,0.02);
        }
        .nav-item.active {
            color: #fff;
            border-left-color: #fff;
            background: rgba(255,255,255,0.03);
        }
        .nav-item .icon { width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; opacity: 0.7; }
        .nav-item.active .icon { opacity: 1; }
        .nav-item .icon svg { width: 18px; height: 18px; stroke: currentColor; fill: none; stroke-width: 1.5; display: block; }
        .nav-item .nav-en { opacity: 0.5; font-size: 12px; margin-left: 2px; }
        
        /* é¡¹ç›®é€‰æ‹©å™¨ */
        .project-select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            background: #111111;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 13px;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }
        .project-select:hover {
            border-color: rgba(255,255,255,0.2);
        }
        .project-select:focus {
            outline: none;
            border-color: rgba(255,255,255,0.3);
        }
        .project-select option {
            background: #111111;
            color: #fff;
            padding: 10px;
        }
        .project-select option:checked,
        .project-select option:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        
        /* çŠ¶æ€ä¿¡æ¯ */
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 13px;
            color: #9ca3af;
        }
        .status-value {
            font-weight: 500;
            color: #fff;
        }
        .status-value.success { color: #fff; }
        .status-value.warning { color: #9ca3af; }
        .status-value.danger { color: #6b7280; }
        .status-value.accent { color: #fff; }
        
        /* æ£€æŸ¥çŠ¶æ€æŒ‰é’® */
        .check-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: #9ca3af;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .check-btn:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.2);
        }
        .check-btn.checked {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            color: #fff;
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* é¡¶æ  - Linear Style (ä¸ Onboarding ä¸€è‡´) */
        .topbar {
            height: 60px;
            background: #111111;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 16px;
        }
        
        .topbar-title {
            font-size: 14px;
            color: #6b7280;
        }
        .topbar-title strong {
            color: #fff;
            font-weight: 500;
        }
        
        .topbar-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* æŒ‰é’®æ ·å¼ - Linear Style (ä¸ Onboarding ä¸€è‡´) */
        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: #a1a1a1;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }
        .btn:hover {
            background: rgba(255,255,255,0.04);
            color: #fff;
            border-color: rgba(255,255,255,0.2);
        }
        .btn-primary { 
            background: rgba(255,255,255,0.08);
            color: #fff; 
            border: 1px solid rgba(255,255,255,0.15);
        }
        .btn-primary:hover { 
            background: rgba(255,255,255,0.12);
            border-color: rgba(255,255,255,0.25);
        }
        .btn-secondary { background: rgba(255,255,255,0.06); color: #d1d5db; border-color: rgba(255,255,255,0.1); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .btn-danger { 
            background: transparent; 
            color: #9ca3af; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .btn-danger:hover { 
            background: rgba(255,255,255,0.04); 
            border-color: rgba(255,255,255,0.2);
            color: #fff;
        }
        .btn-danger:disabled { background: rgba(255,255,255,0.04); color: #555; border-color: transparent; cursor: not-allowed; }
        
        .btn-mark {
            background: transparent;
            color: #9ca3af;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-mark:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.2);
            color: #fff;
        }
        .btn-mark.active {
            background: #22c55e;
            color: #000;
            border-color: #22c55e;
            font-weight: 600;
        }
        .btn-mark.active:hover {
            background: #16a34a;
        }
        
        /* å¿«æ·é”®æç¤º */
        .shortcuts {
            font-size: 12px;
            color: #6b7280;
        }
        .shortcuts kbd {
            background: rgba(255,255,255,0.06);
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
        }
        
        /* ç½‘æ ¼å®¹å™¨ */
        .grid-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            position: relative;
        }
        
        /* æ‹–æ‹½ä¸Šä¼ æç¤º */
        .grid-container.drag-over {
            background: rgba(255,255,255,0.02);
            border: 2px dashed rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        
        /* æ‹–æ‹½æ’å…¥æŒ‡ç¤ºå™¨ */
        .drag-indicator {
            width: 4px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin: 0 2px;
        }
        .drag-indicator-line {
            width: 4px;
            height: 100%;
            background: #fff;
            border-radius: 2px;
            box-shadow: 0 0 12px rgba(255,255,255,0.5);
            animation: pulse-indicator 1s ease-in-out infinite;
        }
        @keyframes pulse-indicator {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* å·²åˆ é™¤æˆªå›¾çŠ¶æ€ */
        #deletedToggle {
            cursor: pointer;
            transition: all 0.2s;
        }
        #deletedToggle:hover {
            background: rgba(239, 68, 68, 0.1);
            border-radius: 4px;
            margin: -4px;
            padding: 4px;
        }
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }
        .insert-mode-hint.show {
            display: block;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        /* å•†åŸå¯¹æ¯”å¼¹çª— */
        .store-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow: auto;
        }
        
        .store-modal.active {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 20px;
        }
        
        .store-modal-content {
            background: #111111;
            border-radius: 16px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .store-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .store-modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #fff;
        }
        
        .store-modal-body {
            flex: 1;
            overflow: auto;
            padding: 0;
        }
        
        /* å•†åŸå¯¹æ¯”è¡¨æ ¼ */
        .store-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }
        
        .store-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .store-table th,
        .store-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .store-table th {
            background: #111111;
            color: #9ca3af;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .store-table th:first-child {
            border-radius: 0;
        }
        
        .store-table tr:hover {
            background: rgba(255,255,255,0.02);
        }
        
        .store-table .app-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .store-table .app-name {
            font-weight: 600;
            color: #fff;
        }
        
        .store-table .app-subtitle {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }
        
        .store-table .rating {
            color: #fff;
            font-weight: 600;
        }
        
        .store-table .rating-count {
            color: #6b7280;
            font-size: 11px;
        }
        
        .store-table .screenshots-btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .store-table .screenshots-btn:hover {
            background: #e5e5e5;
        }
        
        /* å•†åŸæˆªå›¾é¢„è§ˆ */
        .store-screenshots-panel {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #0a0a0a;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 2001;
            padding: 16px 20px;
        }
        
        .store-screenshots-panel.active {
            display: block;
        }
        
        .store-screenshots-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .store-screenshots-header h3 {
            margin: 0;
            font-size: 14px;
            color: #fff;
        }
        
        .store-screenshots-grid {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .store-screenshot-item {
            flex-shrink: 0;
            width: 120px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .store-screenshot-item:hover {
            transform: scale(1.05);
        }
        
        .store-screenshot-item img {
            width: 100%;
            border-radius: 8px;
            border: 2px solid transparent;
        }
        
        .store-screenshot-item:hover img {
            border-color: #fff;
        }
        
        /* å·²åˆ é™¤æˆªå›¾é¢æ¿ */
        .deleted-panel {
            display: none;
            background: #111111;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            margin: 10px 20px;
            padding: 15px;
        }
        
        .deleted-panel.show {
            display: block;
        }
        
        .deleted-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        
        .deleted-panel-header h3 {
            margin: 0;
            color: #ef4444;
            font-size: 14px;
        }
        
        .deleted-panel-content {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .deleted-item {
            position: relative;
            width: 80px;
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .deleted-item:hover {
            border-color: #ef4444;
        }
        
        .deleted-item img {
            width: 100%;
            display: block;
            opacity: 0.7;
        }
        
        .deleted-item:hover img {
            opacity: 1;
        }
        
        .deleted-item .restore-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            font-size: 10px;
            padding: 3px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .deleted-item:hover .restore-btn {
            opacity: 1;
        }
        .info-value { color: #fff; font-weight: 500; }
        .info-value.changed { color: #9ca3af; }
        .info-value.selected { color: #fff; }
        .info-value.inserted { color: #fff; }
        .info-value.danger { color: #6b7280; }
        
        .instructions {
            background: #0a0a0a;
            padding: 10px 24px;
            font-size: 12px;
            color: #6b7280;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        
        .instructions kbd {
            background: rgba(255,255,255,0.06);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin: 0 2px;
        }
        
        /* ç§»é™¤æ—§å¸ƒå±€æ ·å¼ï¼Œä½¿ç”¨æ–°çš„ .grid-container */
        
        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-content: flex-start;
        }
        
        .preview-panel {
            width: 320px;
            background: #0a0a0a;
            border-left: 1px solid rgba(255,255,255,0.06);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .preview-header {
            padding: 12px 16px;
            background: #111111;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            font-size: 13px;
            font-weight: 600;
        }
        
        .preview-image {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow: hidden;
        }
        
        .preview-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        .preview-info {
            padding: 12px 16px;
            background: #111111;
            border-top: 1px solid rgba(255,255,255,0.06);
            font-size: 12px;
            color: #9ca3af;
        }
        
        .preview-info .filename {
            color: #fff;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .preview-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 13px;
        }
        
        .card {
            width: 120px;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            cursor: grab;
            transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
            border: 2px solid rgba(255,255,255,0.15);
            position: relative;
            flex-shrink: 0;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .card:active { cursor: grabbing; }
        
        .card.dragging {
            opacity: 0.9;
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 1000;
            border-color: #fff;
        }
        
        .card.moved {
            border-color: rgba(255,255,255,0.3);
            background: #111111;
        }
        
        .card.moved .card-index {
            background: rgba(255,255,255,0.2);
            color: #fff;
        }
        
        .card.selected {
            border-color: #fff;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }
        
        .card.selected .card-checkbox {
            opacity: 1;
            background: #fff;
        }
        
        .card.marked-delete {
            border-color: rgba(255,255,255,0.2);
            opacity: 0.5;
            background: #111111;
        }
        
        .card.marked-delete .card-index {
            background: rgba(255,255,255,0.15);
            color: #fff;
        }
        
        .card.marked-delete::after {
            content: 'Ã—';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #ef4444;
            font-weight: bold;
            pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Onboarding èŒƒå›´æ ·å¼ - ç®€æ´å½©è‰²æ–¹æ¡ˆ */
        .card.in-onboarding {
            border-color: #22c55e;
        }
        
        .card.onboarding-start {
            border-color: #22c55e;
            border-width: 3px;
        }
        
        .card.onboarding-start::after {
            content: 'START';
            position: absolute;
            bottom: 24px;
            left: 0;
            right: 0;
            background: #22c55e;
            color: #000;
            font-size: 11px;
            padding: 5px 0;
            text-align: center;
            z-index: 10;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .card.onboarding-end {
            border-color: #ef4444;
            border-width: 3px;
        }
        
        .card.onboarding-end::after {
            content: 'END';
            position: absolute;
            bottom: 24px;
            left: 0;
            right: 0;
            background: #ef4444;
            color: #fff;
            font-size: 11px;
            padding: 5px 0;
            text-align: center;
            z-index: 10;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        /* æ ‡è®°æ¨¡å¼æç¤ºæ¡ */
        .mark-mode-bar {
            background: #111;
            padding: 14px 24px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 20px;
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .mark-mode-bar.show {
            display: flex;
        }
        
        .mark-mode-bar .hint {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .mark-mode-bar .step-badge {
            background: #22c55e;
            color: #000;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
        }
        
        .mark-mode-bar .btn-exit {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: #fff;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }
        
        .mark-mode-bar .btn-exit:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.5);
        }
        
        /* æ ‡è®°æ¨¡å¼ä¸‹çš„å¡ç‰‡æ ·å¼ */
        body.mark-mode .card {
            cursor: crosshair;
        }
        
        body.mark-mode .card:hover {
            border-color: #fff;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
        }
        
        body.mark-mode .card.in-onboarding {
            border-color: rgba(139, 92, 246, 0.5);
            background: rgba(139, 92, 246, 0.1);
        }
        
        /* Onboarding ä¿¡æ¯æ  */
        .onboarding-info {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            padding: 8px 24px;
            border-bottom: 1px solid #1a1a2a;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
        }
        
        .onboarding-info .ob-label {
            color: #9ca3af;
            font-weight: 600;
        }
        
        .onboarding-info .ob-range {
            color: #e1e1e1;
            font-weight: 500;
        }
        
        .onboarding-info .ob-count {
            color: #fff;
        }
        
        .card-checkbox {
            position: absolute;
            top: 3px;
            right: 3px;
            width: 18px;
            height: 18px;
            background: rgba(0,0,0,0.6);
            border: 2px solid #5e6ad2;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .card:hover .card-checkbox {
            opacity: 0.7;
        }
        
        .card-index {
            position: absolute;
            top: 4px;
            left: 4px;
            background: rgba(0,0,0,0.85);
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            z-index: 1;
        }
        
        .card img {
            width: 100%;
            height: 213px;
            object-fit: cover;
            display: block;
            pointer-events: none;
            user-select: none;
        }
        
        .card-footer {
            padding: 6px;
            font-size: 10px;
            color: #9ca3af;
            text-align: center;
            background: #111111;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: #6b7280;
            width: 100%;
        }
        
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: rgba(255,255,255,0.15);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #ef4444; }
        
        /* æ‹–æ‹½æ—¶çš„å ä½çº¿ */
        .drop-indicator {
            width: 3px;
            background: #5e6ad2;
            border-radius: 2px;
            margin: 0 -5px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        
        .drop-indicator.active {
            opacity: 1;
        }
        
        /* å¿«æ·é”®æç¤º - é»˜è®¤æŠ˜å ï¼Œhover å±•å¼€ */
        .shortcuts-help {
            position: fixed;
            bottom: 24px;
            left: 24px;
            background: rgba(17, 17, 17, 0.95);
            border-radius: 8px;
            font-size: 12px;
            color: #9ca3af;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            transition: all 0.2s ease;
            z-index: 100;
        }

        .shortcuts-help .shortcuts-toggle {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #6b7280;
            font-size: 11px;
        }

        .shortcuts-help .shortcuts-toggle:hover {
            color: #fff;
        }

        .shortcuts-help .shortcuts-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease, padding 0.2s ease;
            padding: 0 14px;
        }

        .shortcuts-help:hover .shortcuts-content {
            max-height: 200px;
            padding: 0 14px 12px 14px;
        }

        .shortcuts-help .shortcuts-content div {
            margin: 6px 0;
        }

        .shortcuts-help kbd {
            background: rgba(255,255,255,0.08);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 10px;
            min-width: 60px;
            display: inline-block;
            text-align: center;
            color: #fff;
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            {% if not frame_mode %}
            <div class="sidebar-header">
                <div class="logo">æˆªå›¾æ’åº</div>
            </div>
            
            <!-- å¯¼èˆª -->
            <div class="sidebar-section">
                <h3>å¯¼èˆª <span>Navigation</span></h3>
                <div class="nav-list">
                    <a href="/" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></span>é¦–é¡µ <span class="nav-en">Home</span></a>
                    <a href="/sort" class="nav-item active"><span class="icon"><svg viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg></span>æ’åº <span class="nav-en">Sort</span></a>
                    <a href="/onboarding" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></span>å¼•å¯¼æµç¨‹ <span class="nav-en">Onboarding</span></a>
                    <a href="/store" class="nav-item"><span class="icon"><svg viewBox="0 0 24 24"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></span>å•†åŸå¯¹æ¯” <span class="nav-en">Store</span></a>
                </div>
            </div>
            {% endif %}
            
            <!-- é¡¹ç›®é€‰æ‹© -->
            <div class="sidebar-section">
                <h3>é¡¹ç›® <span>Project</span></h3>
                <select class="project-select" id="projectSelect" onchange="loadProject()">
                    <option value="">é€‰æ‹©äº§å“...</option>
                </select>
            </div>
            
            <!-- çŠ¶æ€ä¿¡æ¯ -->
            <div class="sidebar-section" id="statusSection" style="display: none;">
                <h3>çŠ¶æ€</h3>
                <div class="status-item">
                    <span>æ€»æˆªå›¾</span>
                    <span class="status-value" id="totalCount">0</span>
                </div>
                <div class="status-item">
                    <span>å·²é€‰ä¸­</span>
                    <span class="status-value accent" id="selectedCount">0</span>
                </div>
                <div class="status-item">
                    <span>Onboarding</span>
                    <span class="status-value success" id="obRange">æœªè®¾ç½®</span>
                </div>
                <div class="status-item" id="deletedToggle" onclick="toggleDeletedView()" style="display: none;">
                    <span>å·²åˆ é™¤ (ç‚¹å‡»æŸ¥çœ‹)</span>
                    <span class="status-value danger" id="deletedCount">0</span>
                </div>
            </div>
            
            <!-- æ£€æŸ¥çŠ¶æ€ -->
            <div class="sidebar-section" id="checkSection" style="display: none;">
                <button class="check-btn" id="checkBtn" onclick="toggleCheckStatus()">
                    <span>â˜</span>
                    <span>æ ‡è®°å·²æ£€æŸ¥</span>
                </button>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- é¡¶æ  -->
            <div class="topbar">
                <div class="topbar-title">
                    <span id="projectTitle">è¯·é€‰æ‹©é¡¹ç›®</span>
                </div>
                <div class="shortcuts">
                    <kbd>æ‹–æ‹½</kbd>æ’åº <kbd>Delete</kbd>åˆ é™¤ <kbd>æ‹–å…¥æ–‡ä»¶</kbd>æ’å…¥ <kbd>Ctrl+Z</kbd>æ’¤é”€
                </div>
                <div class="topbar-actions">
                    <button class="btn btn-danger" id="deleteBtn" onclick="deleteSelected()" disabled>
                        ğŸ—‘ï¸ åˆ é™¤ (<span id="deleteCount">0</span>)
                    </button>
                    <button class="btn btn-mark" id="markModeBtn" onclick="toggleMarkMode()">
                        ğŸ¯ æ ‡è®° Onboarding
                    </button>
                </div>
            </div>
            
            <!-- æ ‡è®°æ¨¡å¼æç¤ºæ¡ -->
            <div class="mark-mode-bar" id="markModeBar">
                <div class="hint">
                    <span class="step-badge" id="markStep">æ­¥éª¤ 1/2</span>
                    <span id="markHint">ğŸ‘† è¯·ç‚¹å‡» Onboarding æµç¨‹çš„ã€ç¬¬ä¸€å¼ ã€‘æˆªå›¾</span>
                </div>
                <button class="btn-exit" onclick="exitMarkMode()">âœ• é€€å‡ºæ ‡è®°</button>
            </div>
            
            <!-- å·²åˆ é™¤æˆªå›¾é¢æ¿ -->
            <div class="deleted-panel" id="deletedPanel">
                <div class="deleted-panel-header">
                    <h3>ğŸ—‘ï¸ å·²åˆ é™¤çš„æˆªå›¾ï¼ˆå¯æ¢å¤ï¼‰</h3>
                    <button class="btn btn-secondary" onclick="toggleDeletedView()" style="padding: 4px 10px; font-size: 12px;">å…³é—­</button>
                </div>
                <div class="deleted-panel-content" id="deletedContent">
                    åŠ è½½ä¸­...
                </div>
            </div>
            
            <!-- ç½‘æ ¼åŒºåŸŸ -->
            <div class="grid-container">
                <div class="grid" id="grid">
                    <div class="loading">è¯·å…ˆé€‰æ‹©äº§å“</div>
                </div>
            </div>
        </div>
        
        <!-- é¢„è§ˆé¢æ¿ -->
        <div class="preview-panel">
            <div class="preview-header">
                <span id="previewTitle">é¢„è§ˆ</span>
            </div>
            <div class="preview-image" id="previewImage">
                <div class="preview-placeholder">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹å¤§å›¾</div>
            </div>
            <div class="preview-info" id="previewInfo" style="display:none;">
                <div class="filename" id="previewFilename"></div>
                <div id="previewPosition"></div>
            </div>
        </div>
    </div>
    
    <div class="shortcuts-help">
        <div class="shortcuts-toggle">âŒ¨ å¿«æ·é”®</div>
        <div class="shortcuts-content">
            <div><kbd>Ctrl+A</kbd> å…¨é€‰</div>
            <div><kbd>Delete</kbd> åˆ é™¤é€‰ä¸­</div>
            <div><kbd>Ctrl+Z</kbd> æ’¤é”€</div>
            <div><kbd>â† â†’</kbd> å¯¼èˆª</div>
            <div><kbd>Esc</kbd> å–æ¶ˆé€‰æ‹©</div>
            <div><kbd>æ‹–æ‹½</kbd> æ’åº/æ’å…¥</div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <!-- å•†åŸå¯¹æ¯”å¼¹çª— -->
    <div class="store-modal" id="storeModal">
        <div class="store-modal-content">
            <div class="store-modal-header">
                <h2>ğŸª App Store å•†åŸå¯¹æ¯”</h2>
                <button class="btn btn-secondary" onclick="closeStoreModal()" style="padding: 6px 12px;">âœ• å…³é—­</button>
            </div>
            <div class="store-modal-body">
                <table class="store-table" id="storeTable">
                    <thead>
                        <tr>
                            <th>åº”ç”¨</th>
                            <th>è¯„åˆ†</th>
                            <th>è¯„è®ºæ•°</th>
                            <th>ä»·æ ¼</th>
                            <th>å¤§å°</th>
                            <th>å•†åŸæˆªå›¾</th>
                            <th>æ›´æ–°æ—¥æœŸ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="storeTableBody">
                        <tr><td colspan="8" style="text-align: center; padding: 40px;">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- å•†åŸæˆªå›¾é¢„è§ˆé¢æ¿ -->
    <div class="store-screenshots-panel" id="storeScreenshotsPanel">
        <div class="store-screenshots-header">
            <h3 id="storeScreenshotsTitle">å•†åŸæˆªå›¾</h3>
            <button class="btn btn-secondary" onclick="closeStoreScreenshots()" style="padding: 4px 10px; font-size: 12px;">å…³é—­</button>
        </div>
        <div class="store-screenshots-grid" id="storeScreenshotsGrid">
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        let screens = [];
        let movedSet = new Set();      // è®°å½•è¢«ç§»åŠ¨è¿‡çš„å¡ç‰‡
        let selectedSet = new Set();   // è®°å½•è¢«é€‰ä¸­çš„å¡ç‰‡
        let toDeleteSet = new Set();   // è®°å½•å¾…åˆ é™¤çš„å¡ç‰‡
        let currentProject = '';
        let sortable = null;
        let lastClickedIndex = -1;     // ç”¨äº Shift é€‰æ‹©
        let projectLoadTime = 0;       // é¡¹ç›®åŠ è½½æ—¶é—´æˆ³ï¼ˆç”¨äºç¼“å­˜ç ´åï¼‰
        
        // Onboarding èŒƒå›´
        let onboardingStart = -1;
        let onboardingEnd = -1;
        
        // æ ‡è®°æ¨¡å¼
        let markMode = false;      // æ˜¯å¦å¤„äºæ ‡è®°æ¨¡å¼
        let markStep = 0;          // æ ‡è®°æ­¥éª¤: 0=æœªå¼€å§‹, 1=ç­‰å¾…é€‰æ‹©å¼€å§‹, 2=ç­‰å¾…é€‰æ‹©ç»“æŸ
        
        // æ£€æŸ¥çŠ¶æ€
        let isChecked = false;     // é¡¹ç›®æ˜¯å¦å·²æ£€æŸ¥
        let checkedAt = null;      // æ£€æŸ¥æ—¶é—´
        
        // é¡¹ç›®åˆ—è¡¨æ•°æ®ï¼ˆç”¨äºè¿›åº¦ç»Ÿè®¡ï¼‰
        let allProjects = [];
        let projectStats = { total: 0, checked: 0, onboarding_marked: 0 };
        
        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            try {
                const res = await fetch('/api/sort-projects');
                const data = await res.json();
                allProjects = data.projects || [];
                projectStats = data.stats || { total: 0, checked: 0, onboarding_marked: 0 };
                
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">é€‰æ‹©äº§å“...</option>';
                
                allProjects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    
                    // æ„å»ºçŠ¶æ€æ ‡è¯†
                    let status = '';
                    if (p.checked) {
                        status = 'âœ… ';
                    } else {
                        status = 'â—‹ ';
                    }
                    
                    // Onboarding æ ‡è¯†
                    let obInfo = '';
                    if (p.onboarding_start > 0 && p.onboarding_end > 0) {
                        obInfo = ` [OB:${p.onboarding_start}-${p.onboarding_end}]`;
                    }
                    
                    const baseName = p.display_name || p.name.replace('_Analysis', '');
                    opt.textContent = `${status}${baseName} (${p.screen_count}å¼ )${obInfo}`;
                    opt.dataset.checked = p.checked;
                    opt.dataset.obStart = p.onboarding_start;
                    opt.dataset.obEnd = p.onboarding_end;
                    
                    select.appendChild(opt);
                });
                
                // æ›´æ–°è¿›åº¦æ¡
                updateProgressBar();
                
                // æ£€æŸ¥ URL å‚æ•°ï¼Œå¦‚æœæœ‰ project å‚æ•°åˆ™è‡ªåŠ¨é€‰æ‹©
                const urlParams = new URLSearchParams(window.location.search);
                const projectParam = urlParams.get('project');
                if (projectParam) {
                    // å°è¯•åŒ¹é…é¡¹ç›®åç§°
                    const matchedOption = Array.from(select.options).find(opt => 
                        opt.value === projectParam || 
                        opt.value.toLowerCase().includes(projectParam.toLowerCase()) ||
                        projectParam.toLowerCase().includes(opt.value.toLowerCase().replace('downloads_2024/', ''))
                    );
                    if (matchedOption) {
                        select.value = matchedOption.value;
                        loadProject();
                    }
                }
            } catch (e) {
                console.error(e);
                showToast('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥', true);
            }
        }
        
        // åŠ è½½é¡¹ç›®æˆªå›¾
        async function loadProject() {
            const select = document.getElementById('projectSelect');
            currentProject = select.value;
            
            if (!currentProject) {
                document.getElementById('grid').innerHTML = '<div class="loading">è¯·å…ˆé€‰æ‹©äº§å“</div>';
                document.getElementById('statusSection').style.display = 'none';
                document.getElementById('checkSection').style.display = 'none';
                document.getElementById('projectTitle').textContent = 'è¯·é€‰æ‹©é¡¹ç›®';
                return;
            }
            
            // æ˜¾ç¤ºçŠ¶æ€åŒºåŸŸ
            document.getElementById('statusSection').style.display = 'block';
            document.getElementById('checkSection').style.display = 'block';
            
            // æ›´æ–°é¡¹ç›®æ ‡é¢˜
            const projectDisplayName = currentProject.replace('downloads_2024/', '').replace('_Analysis', '');
            document.getElementById('projectTitle').innerHTML = `<strong>${projectDisplayName}</strong>`;
            
            document.getElementById('grid').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            try {
                const res = await fetch(`/api/screenshots/${currentProject}`);
                const data = await res.json();
                
                screens = data.screens.map((file, idx) => ({
                    file: file,
                    originalIndex: idx
                }));
                
                // æ¯æ¬¡åŠ è½½é¡¹ç›®æ—¶æ›´æ–°æ—¶é—´æˆ³ï¼Œç¡®ä¿è·å–æœ€æ–°ç¼©ç•¥å›¾
                projectLoadTime = Date.now();
                
                movedSet.clear();
                selectedSet.clear();
                toDeleteSet.clear();
                lastClickedIndex = -1;
                insertedCount = 0;
                
                // é‡ç½®å¹¶åŠ è½½ Onboarding èŒƒå›´
                onboardingStart = -1;
                onboardingEnd = -1;
                await loadOnboardingRange();
                
                // åŠ è½½æ£€æŸ¥çŠ¶æ€
                await loadCheckStatus();
                
                // åŠ è½½å·²åˆ é™¤æˆªå›¾ä¿¡æ¯
                await loadDeletedScreens();
                
                // å…³é—­å·²åˆ é™¤é¢æ¿ï¼ˆå¦‚æœæ‰“å¼€çš„è¯ï¼‰
                showDeletedPanel = false;
                document.getElementById('deletedPanel').classList.remove('show');
                
                // é‡ç½®å³ä¾§é¢„è§ˆé¢æ¿
                resetPreviewPanel();
                
                renderGrid();
                initSortable();
                updateInfo();
            } catch (e) {
                document.getElementById('grid').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
                showToast('åŠ è½½æˆªå›¾å¤±è´¥', true);
            }
        }
        
        // æ¸²æŸ“ç½‘æ ¼ï¼ˆå®Œæ•´é‡å»º DOMï¼Œåªåœ¨åŠ è½½é¡¹ç›®æˆ–æ’åºåè°ƒç”¨ï¼‰
        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            // ä½¿ç”¨é¡¹ç›®åŠ è½½æ—¶é—´æˆ³ç¡®ä¿è·å–æœ€æ–°ç¼©ç•¥å›¾
            const cacheBuster = `&_t=${projectLoadTime}`;
            
            // æ’å…¥æ¨¡å¼ï¼šåœ¨å¼€å¤´æ·»åŠ ä¸€ä¸ªæ’å…¥ç‚¹
            if (insertMode) {
                grid.classList.add('insert-mode');
                const insertPoint = createInsertPoint(0);
                grid.appendChild(insertPoint);
            } else {
                grid.classList.remove('insert-mode');
            }
            
            // ä½¿ç”¨ DocumentFragment ä¼˜åŒ–æ‰¹é‡ DOM æ“ä½œ
            const fragment = document.createDocumentFragment();
            
            screens.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.file = item.file;
                card.dataset.index = idx;
                
                // æ·»åŠ  loading="lazy" å®ç°åŸç”Ÿæ‡’åŠ è½½
                card.innerHTML = `
                    <span class="card-checkbox">âœ“</span>
                    <span class="card-index">${idx + 1}</span>
                    <img src="/api/thumb/${currentProject}/screens/${item.file}?size=small${cacheBuster}" alt="${item.file}" loading="lazy">
                    <div class="card-footer">${item.file.replace('Screen_', '').replace('.png', '')}</div>
                `;
                
                // ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨é—­åŒ…ç»‘å®š fileï¼Œä» data-index åŠ¨æ€è·å–ç´¢å¼•ï¼‰
                const file = item.file;
                card.addEventListener('click', (e) => {
                    const currentIdx = parseInt(card.dataset.index) || 0;
                    handleCardClick(e, file, currentIdx);
                });
                
                // åŒå‡»é¢„è§ˆå¤§å›¾
                card.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    const currentIdx = parseInt(card.dataset.index) || 0;
                    showPreview(file, currentIdx);
                });
                
                fragment.appendChild(card);
                
                // æ’å…¥æ¨¡å¼ï¼šåœ¨æ¯å¼ å›¾åæ·»åŠ æ’å…¥ç‚¹
                if (insertMode) {
                    const insertPoint = createInsertPoint(idx + 1);
                    fragment.appendChild(insertPoint);
                }
            });
            
            // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å…ƒç´ åˆ° DOM
            grid.appendChild(fragment);
            
            // åº”ç”¨æ ·å¼
            updateCardStyles();
        }
        
        // åˆ›å»ºæ’å…¥ç‚¹å…ƒç´ 
        function createInsertPoint(position) {
            const point = document.createElement('div');
            point.className = 'insert-point';
            point.dataset.position = position;
            point.innerHTML = '<span class="insert-point-icon">+</span>';
            point.addEventListener('click', () => triggerInsertUpload(position));
            return point;
        }
        
        // åªæ›´æ–°å¡ç‰‡æ ·å¼ï¼ˆä¸é‡å»º DOMï¼Œéå¸¸å¿«ï¼‰
        function updateCardStyles() {
            const cards = document.querySelectorAll('#grid .card');
            cards.forEach((card, idx) => {
                const file = card.dataset.file;
                const displayIdx = idx + 1;
                
                // æ›´æ–°é€‰ä¸­/ç§»åŠ¨/åˆ é™¤çŠ¶æ€
                card.classList.toggle('moved', movedSet.has(file));
                card.classList.toggle('selected', selectedSet.has(file));
                card.classList.toggle('marked-delete', toDeleteSet.has(file));
                
                // æ›´æ–° Onboarding èŒƒå›´æ ·å¼
                const inRange = onboardingStart > 0 && onboardingEnd > 0 && 
                               displayIdx >= onboardingStart && displayIdx <= onboardingEnd;
                card.classList.toggle('in-onboarding', inRange);
                card.classList.toggle('onboarding-start', displayIdx === onboardingStart);
                card.classList.toggle('onboarding-end', displayIdx === onboardingEnd);
            });
        }
        
        // å¤„ç†å¡ç‰‡ç‚¹å‡»
        function handleCardClick(e, file, idx) {
            e.preventDefault();
            
            // æ ‡è®°æ¨¡å¼ä¸‹çš„å¤„ç†
            if (markMode) {
                handleMarkModeClick(idx + 1);  // ä½¿ç”¨æ˜¾ç¤ºåºå·(1-based)
                return;
            }
            
            if (e.ctrlKey || e.metaKey) {
                // Ctrl+ç‚¹å‡»ï¼šåˆ‡æ¢é€‰ä¸­çŠ¶æ€
                if (selectedSet.has(file)) {
                    selectedSet.delete(file);
                } else {
                    selectedSet.add(file);
                }
            } else if (e.shiftKey && lastClickedIndex >= 0) {
                // Shift+ç‚¹å‡»ï¼šèŒƒå›´é€‰æ‹©
                const start = Math.min(lastClickedIndex, idx);
                const end = Math.max(lastClickedIndex, idx);
                for (let i = start; i <= end; i++) {
                    selectedSet.add(screens[i].file);
                }
            } else {
                // æ™®é€šç‚¹å‡»ï¼šå•é€‰å¹¶é¢„è§ˆ
                selectedSet.clear();
                selectedSet.add(file);
                showPreview(file, idx);
            }
            
            lastClickedIndex = idx;
            updateCardStyles();  // åªæ›´æ–°æ ·å¼ï¼Œä¸é‡å»º DOM
            updateInfo();
        }
        
        // åˆå§‹åŒ– Sortable
        function initSortable() {
            const grid = document.getElementById('grid');
            
            if (sortable) {
                sortable.destroy();
            }
            
            sortable = new Sortable(grid, {
                animation: 150,
                ghostClass: 'dragging',
                chosenClass: 'dragging',
                dragClass: 'dragging',
                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                filter: '.marked-delete,.drag-indicator,.insert-point',
                
                onEnd: async function(evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    
                    if (oldIndex !== newIndex) {
                        // è®°å½•åŸé¡ºåºç”¨äºæ’¤é”€
                        const originalOrder = screens.map(s => s.file);
                        originalOrder.splice(newIndex, 0, originalOrder.splice(oldIndex, 1)[0]);
                        const beforeOrder = screens.map(s => s.file);
                        
                        // æ›´æ–°æ•°æ®
                        const [moved] = screens.splice(oldIndex, 1);
                        screens.splice(newIndex, 0, moved);
                        
                        // è®°å½•æ“ä½œå†å²
                        pushToHistory({
                            type: 'reorder',
                            originalOrder: beforeOrder
                        });
                        
                        // è‡ªåŠ¨ä¿å­˜æ’åº
                        await autoSaveOrder();
                        
                        // æ¸…é™¤æ£€æŸ¥çŠ¶æ€ï¼ˆå› ä¸ºé¡ºåºå·²ä¿®æ”¹ï¼‰
                        clearCheckStatus();
                        
                        // å¢é‡æ›´æ–°åºå·
                        updateCardIndexes();
                        updateInfo();
                    }
                }
            });
        }
        
        // è‡ªåŠ¨ä¿å­˜æ’åº
        async function autoSaveOrder() {
            if (!currentProject || screens.length === 0) return;
            
            showToast('ä¿å­˜ä¸­...', false);
            
            try {
                const newOrder = screens.map(s => s.file);
                const res = await fetch('/api/reorder-screens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        project: currentProject, 
                        new_order: newOrder 
                    })
                });
                
                const result = await res.json();
                if (result.success) {
                    showToast('å·²ä¿å­˜');
                    movedSet.clear();
                } else {
                    showToast('ä¿å­˜å¤±è´¥: ' + result.error, true);
                }
            } catch (err) {
                showToast('ä¿å­˜å¤±è´¥: ' + err.message, true);
            }
        }
        
        // å¢é‡æ›´æ–°å¡ç‰‡åºå·ï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªç½‘æ ¼ï¼‰
        function updateCardIndexes() {
            const cards = document.querySelectorAll('#grid .card');
            cards.forEach((card, idx) => {
                // æ›´æ–°ç´¢å¼•
                card.dataset.index = idx;
                const indexEl = card.querySelector('.card-index');
                if (indexEl) {
                    indexEl.textContent = idx + 1;
                }
            });
        }
        
        // æ›´æ–°ä¿¡æ¯
        function updateInfo() {
            // ä¾§è¾¹æ çŠ¶æ€æ›´æ–°
            document.getElementById('totalCount').textContent = screens.length;
            document.getElementById('selectedCount').textContent = selectedSet.size;
            document.getElementById('deleteCount').textContent = selectedSet.size;
            
            // æ›´æ–°åˆ é™¤æŒ‰é’®çŠ¶æ€
            const deleteBtn = document.getElementById('deleteBtn');
            deleteBtn.disabled = selectedSet.size === 0;
        }
        
        // æ›´æ–°è¿›åº¦æ¡
        function updateProgressBar() {
            const total = projectStats.total || 0;
            const checked = projectStats.checked || 0;
            const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
            
            // å®‰å…¨æ£€æŸ¥ï¼šå…ƒç´ å¯èƒ½ä¸å­˜åœ¨
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            
            if (progressText) progressText.textContent = `${checked}/${total}`;
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (progressPercent) progressPercent.textContent = `${percent}%`;
        }
        
        // åˆ·æ–°é¡¹ç›®åˆ—è¡¨ï¼ˆæ£€æŸ¥çŠ¶æ€å˜åŒ–åè°ƒç”¨ï¼‰
        async function refreshProjectList() {
            try {
                const res = await fetch('/api/sort-projects');
                const data = await res.json();
                allProjects = data.projects || [];
                projectStats = data.stats || { total: 0, checked: 0, onboarding_marked: 0 };
                
                // æ›´æ–°ä¸‹æ‹‰èœå•ä¸­å½“å‰é€‰ä¸­é¡¹çš„æ˜¾ç¤º
                const select = document.getElementById('projectSelect');
                const currentValue = select.value;
                
                // é‡æ–°æ„å»ºé€‰é¡¹
                select.innerHTML = '<option value="">é€‰æ‹©äº§å“...</option>';
                allProjects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.name;
                    
                    let status = p.checked ? 'âœ… ' : 'â—‹ ';
                    let obInfo = '';
                    if (p.onboarding_start > 0 && p.onboarding_end > 0) {
                        obInfo = ` [OB:${p.onboarding_start}-${p.onboarding_end}]`;
                    }
                    
                    const baseName = p.display_name || p.name.replace('_Analysis', '');
                    opt.textContent = `${status}${baseName} (${p.screen_count}å¼ )${obInfo}`;
                    
                    if (p.name === currentValue) {
                        opt.selected = true;
                    }
                    
                    select.appendChild(opt);
                });
                
                updateProgressBar();
            } catch (e) {
                console.error('åˆ·æ–°é¡¹ç›®åˆ—è¡¨å¤±è´¥:', e);
            }
        }
        
        // é‡ç½®é¡ºåº
        function resetOrder() {
            if (!currentProject) return;
            
            screens.sort((a, b) => a.originalIndex - b.originalIndex);
            movedSet.clear();
            selectedSet.clear();
            toDeleteSet.clear();
            
            renderGrid();
            initSortable();
            updateInfo();
            showToast('å·²é‡ç½®');
        }
        
        // åˆ é™¤é€‰ä¸­çš„æˆªå›¾
        async function deleteSelected() {
            if (selectedSet.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æˆªå›¾', true);
                return;
            }
            
            const filesToDelete = Array.from(selectedSet);
            const count = filesToDelete.length;
            
            // ç«‹å³åˆ é™¤å¹¶ä¿å­˜
            showToast(`æ­£åœ¨åˆ é™¤ ${count} å¼ æˆªå›¾...`);
            
            try {
                const res = await fetch('/api/delete-screens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        project: currentProject, 
                        files: filesToDelete
                    })
                });
                
                const result = await res.json();
                if (result.success) {
                    // è®°å½•åˆ é™¤æ“ä½œç”¨äºæ’¤é”€
                    pushToHistory({
                        type: 'delete',
                        files: filesToDelete
                    });
                    
                    showToast(`å·²åˆ é™¤ ${count} å¼ æˆªå›¾ (Ctrl+Z æ’¤é”€)`);
                    
                    // ä»æ•°æ®ä¸­ç§»é™¤
                    screens = screens.filter(s => !selectedSet.has(s.file));
                    selectedSet.clear();
                    
                    // æ¸…é™¤æ£€æŸ¥çŠ¶æ€
                    clearCheckStatus();
                    
                    // å¢é‡æ›´æ–°ï¼šç§»é™¤ DOM èŠ‚ç‚¹
                    removeDeletedCards(filesToDelete);
                    updateCardIndexes();
                    updateInfo();
                    
                    // æ›´æ–°å·²åˆ é™¤è®¡æ•°
                    await loadDeletedScreens();
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + result.error, true);
                }
            } catch (err) {
                showToast('åˆ é™¤å¤±è´¥: ' + err.message, true);
            }
        }
        
        // å¢é‡ç§»é™¤å·²åˆ é™¤çš„å¡ç‰‡
        function removeDeletedCards(files) {
            files.forEach(file => {
                const card = document.querySelector(`.card[data-file="${file}"]`);
                if (card) {
                    card.remove();
                }
            });
        }
        
        // å…¨é€‰
        function selectAll() {
            if (selectedSet.size === screens.length) {
                // å¦‚æœå·²å…¨é€‰ï¼Œåˆ™å–æ¶ˆå…¨é€‰
                selectedSet.clear();
            } else {
                screens.forEach(item => selectedSet.add(item.file));
            }
            updateCardStyles();
            updateInfo();
        }
        
        // å–æ¶ˆé€‰æ‹©
        function clearSelection() {
            selectedSet.clear();
            updateCardStyles();
            updateInfo();
        }
        
        // åº”ç”¨ä¿®æ”¹ï¼ˆæ’åº+åˆ é™¤ï¼‰
        async function applyChanges() {
            if (!currentProject) {
                showToast('è¯·å…ˆé€‰æ‹©äº§å“', true);
                return;
            }
            
            const hasOrderChanges = movedSet.size > 0;
            const hasDeleteChanges = toDeleteSet.size > 0;
            
            if (!hasOrderChanges && !hasDeleteChanges) {
                showToast('æ²¡æœ‰éœ€è¦åº”ç”¨çš„ä¿®æ”¹', true);
                return;
            }
            
            let confirmMsg = 'ç¡®å®šè¦åº”ç”¨ä¿®æ”¹å—ï¼Ÿ\n\n';
            if (hasDeleteChanges) {
                confirmMsg += `å°†åˆ é™¤ ${toDeleteSet.size} å¼ æˆªå›¾ï¼ˆç§»è‡³ deleted æ–‡ä»¶å¤¹å¤‡ä»½ï¼‰\n`;
            }
            if (hasOrderChanges) {
                confirmMsg += `å°†é‡å‘½å ${screens.length - toDeleteSet.size} å¼ æˆªå›¾\n`;
            }
            confirmMsg += '\nåŸæ–‡ä»¶ä¼šè‡ªåŠ¨å¤‡ä»½ã€‚';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                // 1. å…ˆåˆ é™¤æˆªå›¾
                if (hasDeleteChanges) {
                    const deleteRes = await fetch('/api/delete-screens', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            project: currentProject, 
                            files: Array.from(toDeleteSet)
                        })
                    });
                    
                    const deleteResult = await deleteRes.json();
                    if (!deleteResult.success) {
                        showToast('åˆ é™¤å¤±è´¥: ' + deleteResult.error, true);
                        return;
                    }
                }
                
                // 2. è¿‡æ»¤æ‰å·²åˆ é™¤çš„ï¼Œå‡†å¤‡æ’åºæ•°æ®
                const remainingScreens = screens.filter(s => !toDeleteSet.has(s.file));
                
                // 3. åº”ç”¨æ’åºï¼ˆå¦‚æœæœ‰æ’åºå˜åŒ–æˆ–åˆ é™¤æ“ä½œï¼‰
                if (hasOrderChanges || hasDeleteChanges) {
                    const order = remainingScreens.map((item, idx) => ({
                        original_file: item.file,
                        new_index: idx + 1
                    }));
                    
                    const sortRes = await fetch('/api/apply-sort-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ project: currentProject, order: order })
                    });
                    
                    const sortResult = await sortRes.json();
                    if (!sortResult.success) {
                        showToast('æ’åºå¤±è´¥: ' + sortResult.error, true);
                        return;
                    }
                }
                
                showToast('ä¿®æ”¹å·²åº”ç”¨ï¼');
                movedSet.clear();
                toDeleteSet.clear();
                selectedSet.clear();
                
                // æ¸…é™¤æ£€æŸ¥çŠ¶æ€ï¼ˆå› ä¸ºå†…å®¹å·²ä¿®æ”¹ï¼‰
                await clearCheckStatus();
                
                // é‡æ–°åŠ è½½é¡¹ç›®ï¼ˆloadProject ä¼šè‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³ï¼‰
                setTimeout(() => loadProject(), 1000);
                
            } catch (e) {
                console.error(e);
                showToast('åº”ç”¨å¤±è´¥', true);
            }
        }
        
        // é‡ç½®é¢„è§ˆé¢æ¿
        function resetPreviewPanel() {
            const previewImage = document.getElementById('previewImage');
            previewImage.innerHTML = '<div class="preview-placeholder">ç‚¹å‡»å¡ç‰‡æŸ¥çœ‹å¤§å›¾</div>';
            document.getElementById('previewTitle').textContent = 'é¢„è§ˆ';
            document.getElementById('previewInfo').style.display = 'none';
        }
        
        // æ˜¾ç¤ºé¢„è§ˆ
        function showPreview(file, idx) {
            // æ·»åŠ ç¼“å­˜ç ´åå‚æ•°ç¡®ä¿è·å–æœ€æ–°å›¾ç‰‡
            const cacheBuster = `?_t=${projectLoadTime}`;
            
            // æ˜¾ç¤ºå¤§å›¾
            const previewImage = document.getElementById('previewImage');
            previewImage.innerHTML = `<img src="/api/screenshot/${currentProject}/screens/${file}${cacheBuster}" alt="${file}">`;
            
            // æ˜¾ç¤ºä¿¡æ¯
            document.getElementById('previewTitle').textContent = `#${idx + 1} é¢„è§ˆ`;
            document.getElementById('previewFilename').textContent = file;
            
            const origIdx = screens.find(s => s.file === file)?.originalIndex;
            const moved = movedSet.has(file);
            const toDelete = toDeleteSet.has(file);
            
            let positionHtml = `åŸä½ç½®: #${origIdx + 1} â†’ å½“å‰: #${idx + 1}`;
            if (moved) positionHtml += ' <span style="color:#9ca3af;">å·²ç§»åŠ¨</span>';
            if (toDelete) positionHtml += ' <span style="color:#ef4444;">å¾…åˆ é™¤</span>';
            
            document.getElementById('previewPosition').innerHTML = positionHtml;
            document.getElementById('previewInfo').style.display = 'block';
        }
        
        // Toast æç¤º
        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // è®¡ç®—æ¯è¡Œçš„åˆ—æ•°
        function getColumnsPerRow() {
            const grid = document.getElementById('grid');
            const cards = grid.querySelectorAll('.card');
            if (cards.length < 2) return 1;
            
            const firstTop = cards[0].offsetTop;
            let cols = 1;
            for (let i = 1; i < cards.length; i++) {
                if (cards[i].offsetTop === firstTop) {
                    cols++;
                } else {
                    break;
                }
            }
            return cols;
        }
        
        // æ–¹å‘é”®å¯¼èˆªé€‰æ‹©
        function navigateByArrow(direction) {
            if (!currentProject || screens.length === 0) return;
            
            // è·å–å½“å‰é€‰ä¸­çš„ç´¢å¼•
            let currentIdx = lastClickedIndex;
            if (currentIdx < 0 || currentIdx >= screens.length) {
                currentIdx = 0;
            }
            
            const cols = getColumnsPerRow();
            let newIdx = currentIdx;
            
            switch(direction) {
                case 'left':
                    newIdx = Math.max(0, currentIdx - 1);
                    break;
                case 'right':
                    newIdx = Math.min(screens.length - 1, currentIdx + 1);
                    break;
                case 'up':
                    newIdx = Math.max(0, currentIdx - cols);
                    break;
                case 'down':
                    newIdx = Math.min(screens.length - 1, currentIdx + cols);
                    break;
            }
            
            if (newIdx !== currentIdx || currentIdx === 0) {
                // é€‰ä¸­æ–°çš„å¡ç‰‡
                selectedSet.clear();
                selectedSet.add(screens[newIdx].file);
                lastClickedIndex = newIdx;
                showPreview(screens[newIdx].file, newIdx);
                updateCardStyles();
                updateInfo();
                
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                const cards = document.querySelectorAll('#grid .card');
                if (cards[newIdx]) {
                    cards[newIdx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            // æ–¹å‘é”®å¯¼èˆªï¼ˆä¸ä¸å…¶ä»–ä¿®é¥°é”®ç»„åˆæ—¶ï¼‰
            if (!e.ctrlKey && !e.metaKey && !e.altKey) {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateByArrow('left');
                    return;
                }
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateByArrow('right');
                    return;
                }
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    navigateByArrow('up');
                    return;
                }
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    navigateByArrow('down');
                    return;
                }
            }
            
            // Ctrl+A å…¨é€‰
            if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
                e.preventDefault();
                selectAll();
            }
            
            // Delete åˆ é™¤é€‰ä¸­
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (selectedSet.size > 0) {
                    e.preventDefault();
                    deleteSelected();
                }
            }
            
            // Esc å–æ¶ˆé€‰æ‹© / é€€å‡ºæ ‡è®°æ¨¡å¼
            if (e.key === 'Escape') {
                if (markMode) {
                    exitMarkMode();
                    showToast('å·²é€€å‡ºæ ‡è®°æ¨¡å¼');
                } else {
                    clearSelection();
                }
            }
        });
        
        // ========== æ ‡è®°æ¨¡å¼åŠŸèƒ½ ==========
        
        // åˆ‡æ¢æ ‡è®°æ¨¡å¼
        function toggleMarkMode() {
            if (!currentProject) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäº§å“', true);
                return;
            }
            
            if (markMode) {
                exitMarkMode();
            } else {
                enterMarkMode();
            }
        }
        
        // è¿›å…¥æ ‡è®°æ¨¡å¼
        function enterMarkMode() {
            markMode = true;
            markStep = 1;
            
            document.body.classList.add('mark-mode');
            document.getElementById('markModeBtn').classList.add('active');
            document.getElementById('markModeBtn').textContent = 'ğŸ¯ æ ‡è®°ä¸­...';
            document.getElementById('markModeBar').classList.add('show');
            
            updateMarkModeHint();
            showToast('å·²è¿›å…¥æ ‡è®°æ¨¡å¼ï¼Œè¯·ç‚¹å‡»ç¬¬ä¸€å¼  Onboarding æˆªå›¾');
        }
        
        // é€€å‡ºæ ‡è®°æ¨¡å¼
        function exitMarkMode() {
            markMode = false;
            markStep = 0;
            
            document.body.classList.remove('mark-mode');
            document.getElementById('markModeBtn').classList.remove('active');
            document.getElementById('markModeBtn').textContent = 'ğŸ¯ æ ‡è®° Onboarding';
            document.getElementById('markModeBar').classList.remove('show');
        }
        
        // æ›´æ–°æ ‡è®°æ¨¡å¼æç¤º
        function updateMarkModeHint() {
            const stepEl = document.getElementById('markStep');
            const hintEl = document.getElementById('markHint');
            
            if (markStep === 1) {
                stepEl.textContent = 'æ­¥éª¤ 1/2';
                hintEl.textContent = 'ğŸ‘† è¯·ç‚¹å‡» Onboarding æµç¨‹çš„ã€ç¬¬ä¸€å¼ ã€‘æˆªå›¾';
            } else if (markStep === 2) {
                stepEl.textContent = 'æ­¥éª¤ 2/2';
                hintEl.textContent = 'ğŸ‘† è¯·ç‚¹å‡» Onboarding æµç¨‹çš„ã€æœ€åä¸€å¼ ã€‘æˆªå›¾';
            }
        }
        
        // å¤„ç†æ ‡è®°æ¨¡å¼ä¸‹çš„ç‚¹å‡»
        function handleMarkModeClick(displayIdx) {
            if (markStep === 1) {
                // è®¾ç½®å¼€å§‹ä½ç½®
                onboardingStart = displayIdx;
                markStep = 2;
                updateMarkModeHint();
                updateOnboardingInfo();
                updateCardStyles();
                showToast(`âœ… å¼€å§‹ä½ç½®å·²è®¾ä¸º #${displayIdx}ï¼Œè¯·ç‚¹å‡»æœ€åä¸€å¼ `);
            } else if (markStep === 2) {
                // è®¾ç½®ç»“æŸä½ç½®
                onboardingEnd = displayIdx;
                
                // ç¡®ä¿ start <= end
                if (onboardingStart > onboardingEnd) {
                    [onboardingStart, onboardingEnd] = [onboardingEnd, onboardingStart];
                }
                
                updateOnboardingInfo();
                saveOnboardingRange();
                updateCardStyles();
                
                const count = onboardingEnd - onboardingStart + 1;
                showToast(`âœ… å·²æ ‡è®° Onboarding èŒƒå›´: #${onboardingStart} â†’ #${onboardingEnd} (${count} å¼ )`);
                
                // è‡ªåŠ¨é€€å‡ºæ ‡è®°æ¨¡å¼
                exitMarkMode();
            }
        }
        
        // ========== Onboarding èŒƒå›´åŠŸèƒ½ ==========
        
        // è®¾ç½® Onboarding å¼€å§‹ä½ç½®
        function setOnboardingStart(idx) {
            onboardingStart = idx;
            if (onboardingEnd > 0 && onboardingEnd < onboardingStart) {
                // å¦‚æœç»“æŸä½ç½®åœ¨å¼€å§‹ä½ç½®ä¹‹å‰ï¼Œäº¤æ¢
                [onboardingStart, onboardingEnd] = [onboardingEnd, onboardingStart];
            }
            updateOnboardingInfo();
            saveOnboardingRange();
            updateCardStyles();
            showToast(`Onboarding å¼€å§‹ä½ç½®è®¾ä¸º #${onboardingStart}`);
        }
        
        // è®¾ç½® Onboarding ç»“æŸä½ç½®
        function setOnboardingEnd(idx) {
            onboardingEnd = idx;
            if (onboardingStart > 0 && onboardingStart > onboardingEnd) {
                // å¦‚æœå¼€å§‹ä½ç½®åœ¨ç»“æŸä½ç½®ä¹‹åï¼Œäº¤æ¢
                [onboardingStart, onboardingEnd] = [onboardingEnd, onboardingStart];
            }
            updateOnboardingInfo();
            saveOnboardingRange();
            updateCardStyles();
            showToast(`Onboarding ç»“æŸä½ç½®è®¾ä¸º #${onboardingEnd}`);
        }
        
        // æ¸…é™¤ Onboarding èŒƒå›´
        function clearOnboardingRange() {
            onboardingStart = -1;
            onboardingEnd = -1;
            updateOnboardingInfo();
            saveOnboardingRange();
            updateCardStyles();
            showToast('å·²æ¸…é™¤ Onboarding èŒƒå›´');
        }
        
        // æ›´æ–° Onboarding ä¿¡æ¯æ˜¾ç¤º
        function updateOnboardingInfo() {
            const rangeEl = document.getElementById('obRange');
            
            if (onboardingStart > 0 && onboardingEnd > 0) {
                const count = onboardingEnd - onboardingStart + 1;
                rangeEl.textContent = `#${onboardingStart}-${onboardingEnd} (${count}å¼ )`;
            } else if (onboardingStart > 0) {
                rangeEl.textContent = `#${onboardingStart} â†’ ?`;
            } else if (onboardingEnd > 0) {
                rangeEl.textContent = `? â†’ #${onboardingEnd}`;
            } else {
                rangeEl.textContent = 'æœªè®¾ç½®';
            }
        }
        
        // ä¿å­˜ Onboarding èŒƒå›´åˆ°æœåŠ¡å™¨
        async function saveOnboardingRange() {
            if (!currentProject) return;
            
            try {
                await fetch(`/api/onboarding-range/${currentProject}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start: onboardingStart,
                        end: onboardingEnd
                    })
                });
                // åˆ·æ–°é¡¹ç›®åˆ—è¡¨ä»¥æ›´æ–° Onboarding çŠ¶æ€
                refreshProjectList();
            } catch (e) {
                console.error('ä¿å­˜ Onboarding èŒƒå›´å¤±è´¥:', e);
            }
        }
        
        // åŠ è½½ Onboarding èŒƒå›´
        async function loadOnboardingRange() {
            if (!currentProject) return;
            
            try {
                const res = await fetch(`/api/onboarding-range/${currentProject}`);
                const data = await res.json();
                
                if (data.start && data.start > 0) {
                    onboardingStart = data.start;
                }
                if (data.end && data.end > 0) {
                    onboardingEnd = data.end;
                }
                
                updateOnboardingInfo();
            } catch (e) {
                // æ²¡æœ‰ä¿å­˜è¿‡èŒƒå›´ï¼Œå¿½ç•¥é”™è¯¯
                onboardingStart = -1;
                onboardingEnd = -1;
            }
        }
        
        // ========== å·²åˆ é™¤æˆªå›¾åŠŸèƒ½ ==========
        
        let deletedData = null;      // å·²åˆ é™¤æˆªå›¾æ•°æ®
        let showDeletedPanel = false; // æ˜¯å¦æ˜¾ç¤ºå·²åˆ é™¤é¢æ¿
        
        // åŠ è½½å·²åˆ é™¤æˆªå›¾
        async function loadDeletedScreens() {
            if (!currentProject) return;
            
            try {
                const res = await fetch(`/api/deleted-screens/${currentProject}`);
                deletedData = await res.json();
                
                // æ›´æ–°æ˜¾ç¤º
                const toggle = document.getElementById('deletedToggle');
                const countEl = document.getElementById('deletedCount');
                
                if (deletedData.total > 0) {
                    toggle.style.display = 'flex';
                    countEl.textContent = deletedData.total;
                } else {
                    toggle.style.display = 'none';
                }
            } catch (e) {
                deletedData = null;
            }
        }
        
        // åˆ‡æ¢å·²åˆ é™¤é¢æ¿æ˜¾ç¤º
        function toggleDeletedView() {
            showDeletedPanel = !showDeletedPanel;
            
            const panel = document.getElementById('deletedPanel');
            const toggle = document.getElementById('deletedToggle');
            
            if (showDeletedPanel) {
                panel.classList.add('show');
                toggle.classList.add('active');
                renderDeletedContent();
            } else {
                panel.classList.remove('show');
                toggle.classList.remove('active');
            }
        }
        
        // æ¸²æŸ“å·²åˆ é™¤æˆªå›¾å†…å®¹
        function renderDeletedContent() {
            const content = document.getElementById('deletedContent');
            
            if (!deletedData || deletedData.total === 0) {
                content.innerHTML = '<div style="color: #6b7280;">æš‚æ— å·²åˆ é™¤çš„æˆªå›¾</div>';
                return;
            }
            
            let html = '';
            deletedData.batches.forEach(batch => {
                batch.files.forEach(file => {
                    // å·²åˆ é™¤çš„æˆªå›¾æ²¡æœ‰ç¼©ç•¥å›¾ï¼Œä½¿ç”¨åŸå›¾
                    html += `
                        <div class="deleted-item" onclick="restoreScreen('${batch.timestamp}', '${file}')">
                            <img src="/api/deleted-thumb/${currentProject}/${batch.timestamp}/${file}" alt="${file}">
                            <div class="restore-btn">æ¢å¤</div>
                        </div>
                    `;
                });
            });
            
            content.innerHTML = html;
        }
        
        // æ¢å¤å•å¼ æˆªå›¾
        async function restoreScreen(timestamp, filename) {
            if (!confirm(`ç¡®å®šè¦æ¢å¤ ${filename} å—ï¼Ÿ`)) return;
            
            try {
                const res = await fetch(`/api/restore-single/${currentProject}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timestamp, filename })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast(data.message);
                    // é‡æ–°åŠ è½½
                    await loadDeletedScreens();
                    renderDeletedContent();
                    loadProject();  // åˆ·æ–°ä¸»åˆ—è¡¨
                } else {
                    showToast('æ¢å¤å¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('æ¢å¤å¤±è´¥', true);
            }
        }
        
        // ========== æ£€æŸ¥çŠ¶æ€åŠŸèƒ½ ==========
        
        // åŠ è½½æ£€æŸ¥çŠ¶æ€
        async function loadCheckStatus() {
            if (!currentProject) return;
            
            try {
                const res = await fetch(`/api/check-status/${currentProject}`);
                const data = await res.json();
                
                isChecked = data.checked || false;
                checkedAt = data.checked_at || null;
                
                updateCheckStatusUI();
            } catch (e) {
                isChecked = false;
                checkedAt = null;
                updateCheckStatusUI();
            }
        }
        
        // æ›´æ–°æ£€æŸ¥çŠ¶æ€ UI
        function updateCheckStatusUI() {
            const btn = document.getElementById('checkBtn');
            if (!btn) return;
            
            if (isChecked) {
                btn.classList.add('checked');
                let timeStr = '';
                if (checkedAt) {
                    const date = new Date(checkedAt);
                    timeStr = ` ${date.getMonth()+1}/${date.getDate()}`;
                }
                btn.innerHTML = `<span>âœ“</span><span>å·²æ£€æŸ¥${timeStr}</span>`;
            } else {
                btn.classList.remove('checked');
                btn.innerHTML = '<span>â˜</span><span>æ ‡è®°å·²æ£€æŸ¥</span>';
            }
        }
        
        // åˆ‡æ¢æ£€æŸ¥çŠ¶æ€
        async function toggleCheckStatus() {
            if (!currentProject) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®', true);
                return;
            }
            
            const newStatus = !isChecked;
            
            try {
                const res = await fetch(`/api/check-status/${currentProject}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checked: newStatus })
                });
                const data = await res.json();
                
                if (data.success) {
                    isChecked = data.data.checked;
                    checkedAt = data.data.checked_at;
                    updateCheckStatusUI();
                    showToast(isChecked ? 'å·²æ ‡è®°ä¸ºæ£€æŸ¥å®Œæˆ' : 'å·²å–æ¶ˆæ£€æŸ¥æ ‡è®°');
                    // åˆ·æ–°é¡¹ç›®åˆ—è¡¨ä»¥æ›´æ–°è¿›åº¦
                    refreshProjectList();
                } else {
                    showToast('æ“ä½œå¤±è´¥: ' + data.error, true);
                }
            } catch (e) {
                showToast('æ“ä½œå¤±è´¥', true);
            }
        }
        
        // æ¸…é™¤æ£€æŸ¥çŠ¶æ€ï¼ˆä¿®æ”¹æ“ä½œæ—¶è°ƒç”¨ï¼‰
        async function clearCheckStatus() {
            if (!currentProject || !isChecked) return;
            
            try {
                await fetch(`/api/check-status/${currentProject}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checked: false })
                });
                
                isChecked = false;
                checkedAt = null;
                updateCheckStatusUI();
            } catch (e) {
                // å¿½ç•¥é”™è¯¯
            }
        }
        
        // ==================== å•†åŸå¯¹æ¯”åŠŸèƒ½ ====================
        
        let storeData = null;  // ç¼“å­˜å•†åŸæ•°æ®
        
        // æ˜¾ç¤ºå•†åŸå¯¹æ¯”å¼¹çª—
        async function showStoreComparison() {
            const modal = document.getElementById('storeModal');
            modal.classList.add('active');
            
            // åŠ è½½æ•°æ®
            if (!storeData) {
                await loadStoreData();
            }
            
            renderStoreTable();
        }
        
        // å…³é—­å•†åŸå¯¹æ¯”å¼¹çª—
        function closeStoreModal() {
            document.getElementById('storeModal').classList.remove('active');
            closeStoreScreenshots();
        }
        
        // åŠ è½½å•†åŸæ•°æ®
        async function loadStoreData() {
            try {
                const res = await fetch('/api/store-comparison');
                if (!res.ok) {
                    throw new Error('æ•°æ®åŠ è½½å¤±è´¥');
                }
                storeData = await res.json();
            } catch (e) {
                console.error('åŠ è½½å•†åŸæ•°æ®å¤±è´¥:', e);
                document.getElementById('storeTableBody').innerHTML = 
                    '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #ef4444;">åŠ è½½å¤±è´¥ï¼Œè¯·å…ˆè¿è¡Œ fetch_store_data.py è„šæœ¬</td></tr>';
            }
        }
        
        // æ¸²æŸ“å•†åŸè¡¨æ ¼
        function renderStoreTable() {
            if (!storeData || !storeData.apps) return;
            
            const tbody = document.getElementById('storeTableBody');
            let html = '';
            
            for (const app of storeData.apps) {
                const rating = app.rating ? app.rating.toFixed(1) : 'N/A';
                const ratingCount = app.rating_count ? app.rating_count.toLocaleString() : 'N/A';
                const screenshotCount = app.screenshot_count || 0;
                const lastUpdate = app.last_update || 'N/A';
                
                html += `
                    <tr data-app="${app.name}">
                        <td>
                            <img class="app-icon" src="/api/store-screenshot/${app.name}/icon.png" 
                                 onerror="this.style.display='none'" alt="">
                            <div style="display: inline-block; vertical-align: middle;">
                                <div class="app-name">${app.track_name || app.name}</div>
                                <div class="app-subtitle">${app.subtitle || ''}</div>
                            </div>
                        </td>
                        <td>
                            <span class="rating">â­ ${rating}</span>
                        </td>
                        <td>
                            <span class="rating-count">${ratingCount}</span>
                        </td>
                        <td>${app.price || 'Free'}</td>
                        <td>${app.size || 'N/A'}</td>
                        <td>${screenshotCount} å¼ </td>
                        <td>${lastUpdate}</td>
                        <td>
                            ${screenshotCount > 0 ? 
                                `<button class="screenshots-btn" onclick="showStoreScreenshots('${app.name}')">æŸ¥çœ‹æˆªå›¾</button>` : 
                                '-'}
                            <button class="screenshots-btn" onclick="goToProject('downloads_2024/${app.name}')" style="background: #fff; color: #000; margin-left: 4px;">æŸ¥çœ‹åº”ç”¨</button>
                        </td>
                    </tr>
                `;
            }
            
            tbody.innerHTML = html;
        }
        
        // æ˜¾ç¤ºå•†åŸæˆªå›¾
        async function showStoreScreenshots(appName) {
            const panel = document.getElementById('storeScreenshotsPanel');
            const title = document.getElementById('storeScreenshotsTitle');
            const grid = document.getElementById('storeScreenshotsGrid');
            
            title.textContent = `ğŸ“¸ ${appName} å•†åŸæˆªå›¾`;
            grid.innerHTML = '<div style="color: #9ca3af;">åŠ è½½ä¸­...</div>';
            panel.classList.add('active');
            
            try {
                const res = await fetch(`/api/store-info/${appName}`);
                const data = await res.json();
                
                if (data.local_screenshots && data.local_screenshots.length > 0) {
                    let html = '';
                    for (const filename of data.local_screenshots) {
                        html += `
                            <div class="store-screenshot-item" onclick="openStoreScreenshot('${appName}', '${filename}')">
                                <img src="/api/store-screenshot/${appName}/${filename}" alt="${filename}">
                            </div>
                        `;
                    }
                    grid.innerHTML = html;
                } else {
                    grid.innerHTML = '<div style="color: #9ca3af;">æš‚æ— å•†åŸæˆªå›¾</div>';
                }
            } catch (e) {
                grid.innerHTML = '<div style="color: #ef4444;">åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // å…³é—­å•†åŸæˆªå›¾é¢æ¿
        function closeStoreScreenshots() {
            document.getElementById('storeScreenshotsPanel').classList.remove('active');
        }
        
        // æ‰“å¼€å•†åŸæˆªå›¾å¤§å›¾
        function openStoreScreenshot(appName, filename) {
            window.open(`/api/store-screenshot/${appName}/${filename}`, '_blank');
        }
        
        // è·³è½¬åˆ°é¡¹ç›®
        function goToProject(projectName) {
            closeStoreModal();
            const select = document.getElementById('projectSelect');
            
            // æŸ¥æ‰¾å¹¶é€‰æ‹©é¡¹ç›®
            for (const opt of select.options) {
                if (opt.value === projectName) {
                    select.value = projectName;
                    loadProject();
                    return;
                }
            }
            
            showToast('é¡¹ç›®ä¸å­˜åœ¨', true);
        }
        
        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.getElementById('storeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeStoreModal();
            }
        });
        
        // ESC å…³é—­å¼¹çª—
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('storeModal');
                if (modal.classList.contains('active')) {
                    closeStoreModal();
                }
            }
        });
        
        // åˆå§‹åŒ–
        loadProjects();
    </script>
    
    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
    <input type="file" id="insertFileInput" accept="image/png,image/jpeg" style="display:none" multiple>
    
    <script>
        // ==================== æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ ====================
        
        let dragInsertPosition = -1;  // æ‹–æ‹½æ—¶çš„æ’å…¥ä½ç½®
        
        function initDragUpload() {
            const gridContainer = document.querySelector('.grid-container');
            if (!gridContainer) return;
            
            // é˜»æ­¢é»˜è®¤æ‹–æ‹½è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                gridContainer.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // æ‹–æ‹½è¿›å…¥
            gridContainer.addEventListener('dragenter', (e) => {
                if (!currentProject) return;
                if (!e.dataTransfer.types.includes('Files')) return;
                gridContainer.classList.add('drag-over');
            });
            
            // æ‹–æ‹½ç¦»å¼€
            gridContainer.addEventListener('dragleave', (e) => {
                // ç¡®ä¿æ˜¯ç¦»å¼€äº†å®¹å™¨è€Œä¸æ˜¯è¿›å…¥å­å…ƒç´ 
                if (e.relatedTarget && gridContainer.contains(e.relatedTarget)) return;
                gridContainer.classList.remove('drag-over');
                hideDragIndicator();
            });
            
            // æ‹–æ‹½æ‚¬åœ - æ˜¾ç¤ºæ’å…¥ä½ç½®æŒ‡ç¤ºå™¨
            gridContainer.addEventListener('dragover', (e) => {
                if (!currentProject) return;
                if (!e.dataTransfer.types.includes('Files')) return;
                
                gridContainer.classList.add('drag-over');
                
                // è®¡ç®—æœ€è¿‘çš„æ’å…¥ä½ç½®
                const position = calculateInsertPosition(e.clientX, e.clientY);
                if (position !== dragInsertPosition) {
                    dragInsertPosition = position;
                    showDragIndicator(position);
                }
            });
            
            // æ”¾ä¸‹æ–‡ä»¶
            gridContainer.addEventListener('drop', async (e) => {
                gridContainer.classList.remove('drag-over');
                hideDragIndicator();
                
                if (!currentProject) {
                    showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®', true);
                    return;
                }
                
                const files = Array.from(e.dataTransfer.files).filter(f => 
                    f.type.match(/image\/(png|jpeg|jpg)/)
                );
                
                if (files.length === 0) {
                    showToast('è¯·ä¸Šä¼  PNG æˆ– JPG æ ¼å¼çš„å›¾ç‰‡', true);
                    return;
                }
                
                // å¤šæ–‡ä»¶ä¸Šä¼ ï¼ˆå¢é‡æ›´æ–°ï¼‰
                await uploadFilesIncrementally(files, dragInsertPosition);
                dragInsertPosition = -1;
            });
        }
        
        // è®¡ç®—æ‹–æ‹½æ—¶çš„æ’å…¥ä½ç½®
        function calculateInsertPosition(clientX, clientY) {
            const grid = document.getElementById('grid');
            const cards = grid.querySelectorAll('.card');
            
            if (cards.length === 0) return 0;
            
            for (let i = 0; i < cards.length; i++) {
                const rect = cards[i].getBoundingClientRect();
                const midX = rect.left + rect.width / 2;
                
                // å¦‚æœé¼ æ ‡åœ¨å¡ç‰‡å·¦åŠè¾¹ï¼Œæ’å…¥åˆ°è¯¥ä½ç½®
                if (clientX < midX) {
                    return i;
                }
            }
            
            // é¼ æ ‡åœ¨æœ€åä¸€ä¸ªå¡ç‰‡å³è¾¹ï¼Œæ’å…¥åˆ°æœ«å°¾
            return cards.length;
        }
        
        // æ˜¾ç¤ºæ‹–æ‹½æ’å…¥æŒ‡ç¤ºå™¨
        function showDragIndicator(position) {
            hideDragIndicator();
            
            const grid = document.getElementById('grid');
            const cards = grid.querySelectorAll('.card');
            
            const indicator = document.createElement('div');
            indicator.className = 'drag-indicator';
            indicator.innerHTML = '<div class="drag-indicator-line"></div>';
            
            if (position >= cards.length) {
                grid.appendChild(indicator);
            } else {
                grid.insertBefore(indicator, cards[position]);
            }
        }
        
        // éšè—æ‹–æ‹½æŒ‡ç¤ºå™¨
        function hideDragIndicator() {
            const existing = document.querySelector('.drag-indicator');
            if (existing) existing.remove();
        }
        
        // ==================== æ“ä½œå†å²ï¼ˆç”¨äºæ’¤é”€ï¼‰ ====================
        const undoHistory = [];
        const MAX_UNDO_HISTORY = 20;
        
        function pushToHistory(action) {
            undoHistory.push(action);
            if (undoHistory.length > MAX_UNDO_HISTORY) {
                undoHistory.shift();
            }
        }
        
        // Ctrl+Z æ’¤é”€
        document.addEventListener('keydown', async (e) => {
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                await undoLastAction();
            }
        });
        
        async function undoLastAction() {
            if (undoHistory.length === 0) {
                showToast('æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ');
                return;
            }
            
            const action = undoHistory.pop();
            showToast(`æ­£åœ¨æ’¤é”€: ${action.type}...`);
            
            try {
                if (action.type === 'insert') {
                    // æ’¤é”€æ’å…¥ = åˆ é™¤æ–‡ä»¶
                    const res = await fetch('/api/delete-screens', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            project: currentProject, 
                            files: action.files 
                        })
                    });
                    const result = await res.json();
                    if (result.success) {
                        // å¢é‡ç§»é™¤å¡ç‰‡
                        action.files.forEach(file => {
                            const card = document.querySelector(`.card[data-file="${file}"]`);
                            if (card) card.remove();
                        });
                        screens = screens.filter(s => !action.files.includes(s.file));
                        updateCardIndexes();
                        updateInfo();
                        showToast('å·²æ’¤é”€æ’å…¥');
                    }
                } else if (action.type === 'delete') {
                    // æ’¤é”€åˆ é™¤ = æ¢å¤æ–‡ä»¶
                    const res = await fetch('/api/restore-screens', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            project: currentProject, 
                            files: action.files 
                        })
                    });
                    const result = await res.json();
                    if (result.success) {
                        showToast('å·²æ¢å¤åˆ é™¤çš„æˆªå›¾');
                        loadProject(); // éœ€è¦é‡æ–°åŠ è½½ä»¥è·å–æ­£ç¡®é¡ºåº
                    }
                } else if (action.type === 'reorder') {
                    // æ’¤é”€æ’åº = æ¢å¤åŸé¡ºåº
                    const res = await fetch('/api/reorder-screens', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            project: currentProject, 
                            new_order: action.originalOrder 
                        })
                    });
                    const result = await res.json();
                    if (result.success) {
                        screens = action.originalOrder.map((file, idx) => ({
                            file: file,
                            originalIndex: idx
                        }));
                        renderGrid();
                        initSortable();
                        showToast('å·²æ’¤é”€æ’åº');
                    }
                }
            } catch (err) {
                showToast('æ’¤é”€å¤±è´¥: ' + err.message, true);
                undoHistory.push(action); // æ¢å¤åˆ°å†å²
            }
        }
        
        // å¢é‡ä¸Šä¼ æ–‡ä»¶ï¼ˆä¸é‡æ–°åŠ è½½é¡µé¢ï¼‰
        async function uploadFilesIncrementally(files, startPosition) {
            showToast(`æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶...`);
            
            let successCount = 0;
            let currentPos = startPosition;
            const insertedFiles = [];
            
            for (const file of files) {
                const result = await uploadSingleFile(file, currentPos);
                if (result.success) {
                    successCount++;
                    insertedFiles.push(result.filename);
                    
                    // å¢é‡æ·»åŠ å¡ç‰‡åˆ° DOM
                    insertCardAt(result.filename, currentPos);
                    
                    currentPos++;
                    insertedCount++;
                }
            }
            
            if (successCount > 0) {
                // è®°å½•æ“ä½œç”¨äºæ’¤é”€
                pushToHistory({
                    type: 'insert',
                    files: insertedFiles,
                    position: startPosition
                });
                
                showToast(`æˆåŠŸæ’å…¥ ${successCount} å¼ æˆªå›¾`);
                updateCardIndexes();
                updateInfo();
            } else {
                showToast('ä¸Šä¼ å¤±è´¥', true);
            }
        }
        
        // å¢é‡æ·»åŠ å¡ç‰‡åˆ°æŒ‡å®šä½ç½®
        function insertCardAt(filename, position) {
            const grid = document.getElementById('grid');
            const cards = grid.querySelectorAll('.card');
            const cacheBuster = `&_t=${Date.now()}`;
            
            // åˆ›å»ºæ–°å¡ç‰‡
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.file = filename;
            // æ³¨æ„ï¼šindex ä¼šåœ¨ updateCardIndexes ä¸­ç»Ÿä¸€æ›´æ–°
            
            card.innerHTML = `
                <span class="card-checkbox">âœ“</span>
                <span class="card-index"></span>
                <img src="/api/thumb/${currentProject}/screens/${filename}?size=small${cacheBuster}" alt="${filename}" loading="lazy">
                <div class="card-footer">${filename.replace('Screen_', '').replace('.png', '')}</div>
            `;
            
            // ä½¿ç”¨é—­åŒ…ç»‘å®šæ–‡ä»¶åï¼Œåºå·ä» data-index åŠ¨æ€è·å–
            card.addEventListener('click', (e) => {
                const idx = parseInt(card.dataset.index) || 0;
                handleCardClick(e, filename, idx);
            });
            card.addEventListener('dblclick', (e) => {
                e.preventDefault();
                const idx = parseInt(card.dataset.index) || 0;
                showPreview(filename, idx);
            });
            
            // æ’å…¥åˆ°æ­£ç¡®ä½ç½®
            if (position >= cards.length) {
                grid.appendChild(card);
            } else {
                grid.insertBefore(card, cards[position]);
            }
            
            // æ›´æ–° screens æ•°ç»„
            screens.splice(position, 0, { file: filename, originalIndex: position });
        }
        
        // ä¿ç•™æ—§çš„ä¸Šä¼ å‡½æ•°ä½œä¸ºå…¼å®¹
        async function uploadFilesSequentially(files, startPosition) {
            return uploadFilesIncrementally(files, startPosition);
        }
        
        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        async function uploadSingleFile(file, position) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('project', currentProject);
            formData.append('insert_after', position);
            
            try {
                const res = await fetch('/api/insert-screenshot', {
                    method: 'POST',
                    body: formData
                });
                return await res.json();
            } catch (err) {
                return { success: false, error: err.message };
            }
        }
        
        // ==================== æ’å…¥æˆªå›¾åŠŸèƒ½ï¼ˆä¿ç•™å…¼å®¹ï¼‰ ====================
        
        let insertMode = false;
        let insertPosition = 0;
        let insertedCount = 0;
        
        function toggleInsertMode() {
            // ä¿ç•™æ—§çš„æ’å…¥æ¨¡å¼ä½œä¸ºå¤‡é€‰
            if (!currentProject) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®', true);
                return;
            }
            
            insertMode = !insertMode;
            const btn = document.getElementById('insertModeBtn');
            
            if (insertMode) {
                btn.classList.add('active');
                btn.textContent = 'âœ“ æ’å…¥æ¨¡å¼';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ğŸ“¤ æ’å…¥';
            }
            
            renderGrid();
        }
        
        function triggerInsertUpload(position) {
            insertPosition = position;
            document.getElementById('insertFileInput').click();
        }
        
        // æ–‡ä»¶é€‰æ‹©åä¸Šä¼ ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ï¼‰
        document.getElementById('insertFileInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files).filter(f => 
                f.type.match(/image\/(png|jpeg|jpg)/)
            );
            
            if (files.length === 0 || !currentProject) {
                showToast('è¯·ä¸Šä¼  PNG æˆ– JPG æ ¼å¼çš„å›¾ç‰‡', true);
                return;
            }
            
            // ä½¿ç”¨é€šç”¨çš„å¤šæ–‡ä»¶ä¸Šä¼ å‡½æ•°
            await uploadFilesSequentially(files, insertPosition);
            
            // é€€å‡ºæ’å…¥æ¨¡å¼
            insertMode = false;
            const btn = document.getElementById('insertModeBtn');
            if (btn) {
                btn.classList.remove('active');
                btn.textContent = 'ğŸ“¤ æ’å…¥';
            }
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            e.target.value = '';
        });
        
        // ESC é€€å‡ºæ’å…¥æ¨¡å¼
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && insertMode) {
                toggleInsertMode();
            }
        });
        
        // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ 
        initDragUpload();
    </script>
</body>
</html>
