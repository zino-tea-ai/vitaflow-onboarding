# NogicOS 产品规范

> 本文档定义 NogicOS 的产品定位、架构规范、能力标准。
> 所有开发工作必须符合本规范，不做特供版。

---

## 一、产品定义

### 1.1 一句话

**NogicOS 是一个本地 AI 工作伙伴，让 AI 能看到你的工作环境，帮你完成任务。**

### 1.2 核心价值

| 维度 | 定义 |
|------|------|
| **对标** | Cursor（程序员）→ NogicOS（所有知识工作者）|
| **核心价值** | 减少用户给 AI 建立上下文的成本 |
| **差异化** | 打通浏览器 + 本地文件系统 + 多种文件格式 |

### 1.3 目标用户

- 产品经理、设计师、分析师、研究员
- 不一定懂技术
- 希望 AI 自己理解工作上下文
- 处理文档、网页、数据、设计文件

### 1.4 不是什么

- ❌ 不是 ChatGPT 的替代品（我们专注于任务执行，不是闲聊）
- ❌ 不是 Cursor 的复制品（我们面向所有人，不只是程序员）
- ❌ 不是浏览器自动化工具（浏览器只是能力之一）

---

## 二、架构规范

### 2.1 系统架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户                                         │
└─────────────────────────────┬───────────────────────────────────────┘
                              │ 自然语言任务
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Electron Client (前端)                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
│  │    Chat UI      │  │   Status Bar    │  │  Result Panel   │      │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘      │
│           └────────────────────┼────────────────────┘                │
│                    ┌───────────▼───────────┐                         │
│                    │   WebSocket Client    │                         │
│                    └───────────┬───────────┘                         │
└────────────────────────────────┼────────────────────────────────────┘
                                 │ WS: 8765 / HTTP: 8080
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Python Backend (后端)                           │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                        HiveServer                              │  │
│  │  HTTP API (FastAPI) + WebSocket (broadcast) + Health Monitor  │  │
│  └──────────────────────────────┬────────────────────────────────┘  │
│                                 │                                    │
│  ┌──────────────────────────────▼───────────────────────────────┐  │
│  │                      ReAct Agent                              │  │
│  │            Think → Act → Observe → (repeat)                   │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │  │
│  │  │ Classifier  │  │  Planner    │  │Error Handler│           │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘           │  │
│  └──────────────────────────────┬────────────────────────────────┘  │
│                                 │                                    │
│  ┌──────────────────────────────▼───────────────────────────────┐  │
│  │                      Tool Registry                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │  │
│  │  │ Browser     │  │ Local       │  │ Desktop     │           │  │
│  │  │ Tools       │  │ Tools       │  │ Tools       │           │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘           │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        系统资源层                                    │
│  Playwright (Browser) │ pathlib (Files) │ subprocess (Shell)        │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块职责

| 模块 | 文件 | 职责 | 可修改范围 |
|------|------|------|-----------|
| Electron Shell | `client/main.js` | 窗口管理 | UI 配置 |
| React UI | `nogicos-ui/src/` | 用户界面 | 自由修改 |
| HiveServer | `hive_server.py` | 入口路由 | 谨慎修改 |
| ReAct Agent | `engine/agent/react_agent.py` | 核心循环 | 谨慎修改 |
| Tool Registry | `engine/tools/base.py` | 工具管理 | 只增不删 |
| Browser Tools | `engine/tools/browser.py` | 浏览器操作 | 可扩展 |
| Local Tools | `engine/tools/local.py` | 文件操作 | 可扩展 |

### 2.3 依赖关系（修改前必读）

```
修改影响范围:
browser/session.py  →  Browser Tools  →  Agent  →  所有任务执行 (高风险)
tools/browser.py    →  Agent 浏览器能力 (中风险)
tools/local.py      →  Agent 文件能力 (中风险)
agent/react_agent.py →  所有任务执行 (高风险)
nogicos-ui/         →  用户界面 (低风险)
```

---

## 三、能力标准

### 3.1 必须具备（Cursor 对齐）

| 能力 | 实现方式 | 验收标准 |
|------|----------|----------|
| **文件读取** | `pathlib.read_text()` | 能读取任意文本文件 |
| **文件写入** | `pathlib.write_text()` | 能创建/覆盖文件 |
| **Shell 执行** | `asyncio.subprocess` | 能执行系统命令 |
| **文件搜索** | `glob` + `grep` | 能按模式/内容搜索 |
| **浏览器导航** | `playwright.goto()` | 能打开任意 URL |
| **浏览器提取** | `playwright.content()` | 能提取页面内容 |
| **浏览器交互** | `playwright.click/type` | 能点击/输入 |
| **任务分类** | Classifier | 能判断 browser/local/mixed |
| **流式输出** | WebSocket | 能实时显示思考过程 |

### 3.2 应该具备（优于 Cursor）

| 能力 | 实现方式 | 优先级 |
|------|----------|--------|
| **PDF 读写** | openskills/pdf | P1 |
| **Word 读写** | openskills/docx | P1 |
| **Excel 读写** | openskills/xlsx | P1 |
| **项目索引** | 自定义实现 | P2 |
| **长期记忆** | Knowledge Store | P2 |
| **视频理解** | FFmpeg + Vision | P3 |

### 3.3 工具实现原则

```python
# ✅ 正确：直接调用系统 API
async def read_file(path: str) -> str:
    return Path(path).read_text()

# ❌ 错误：模拟 GUI 操作
async def read_file(path: str) -> str:
    screenshot = take_screenshot()
    return ocr(screenshot)
```

**原则：能用 API 就不用 GUI，能直接调用就不要模拟人类操作。**

---

## 四、质量标准

### 4.1 代码质量

| 指标 | 标准 |
|------|------|
| 单文件行数 | < 500 行（超过需拆分）|
| 函数行数 | < 50 行 |
| 类型注解 | 所有公开函数必须有 |
| 文档字符串 | 所有公开函数必须有 |
| 测试覆盖 | 核心模块 > 80% |

### 4.2 运行时质量

| 指标 | 标准 |
|------|------|
| 首次响应 (TTFT) | < 2s |
| 简单任务完成 | < 30s |
| 复杂任务完成 | < 2min |
| 错误率 | < 10% |
| 内存泄漏 | 无 |

### 4.3 用户体验

| 指标 | 标准 |
|------|------|
| 任务描述 | 用户不需要技术知识 |
| 错误提示 | 人话，不是技术错误 |
| 进度反馈 | 每步都有可见反馈 |
| 可中断 | 用户可随时取消任务 |

---

## 五、开发流程

### 5.1 Checkpoint 机制（必须遵守）

**每一步修改都必须执行以下 checkpoint：**

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Checkpoint 流程                                  │
│                                                                      │
│  [修改前]                                                            │
│  □ 1. 回到 PRODUCT_SPEC.md，确认修改符合规范                         │
│  □ 2. 理解模块依赖关系，评估影响范围                                  │
│  □ 3. 写出预期结果（修改完成后应该是什么样子）                        │
│                                                                      │
│  [修改中]                                                            │
│  □ 4. 小步修改，不要大改                                             │
│  □ 5. 遇到问题停下来思考，不要草率跳过                                │
│                                                                      │
│  [修改后]                                                            │
│  □ 6. 回到 PRODUCT_SPEC.md，检查是否符合规范                         │
│  □ 7. 运行测试验证                                                   │
│  □ 8. 手动测试核心场景                                               │
│  □ 9. 如果不符合规范，立即修正                                        │
│                                                                      │
│  [记录]                                                              │
│  □ 10. 更新 CHANGELOG.md                                            │
│  □ 11. 提交 Git（commit message 说明做了什么）                       │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 修改前检查

1. 阅读本规范的相关章节
2. 理解模块依赖关系（第二章 2.3 节）
3. 评估影响范围
4. 写出预期结果
5. 如果是核心模块，先写测试用例

### 5.3 修改后验证

1. 回到本规范检查是否符合
2. 运行单元测试：`pytest tests/test_agent_core.py`
3. 运行集成测试：`pytest tests/test_backend.py`
4. 手动验证核心场景（第 5.4 节）
5. 如果不符合规范，立即修正，不要留到后面

### 5.3 核心场景测试清单

| 场景 | 涉及能力 | 验收标准 |
|------|----------|----------|
| "列出桌面文件" | Local Tools | 返回文件列表 |
| "读取 README.md" | Local Tools | 返回文件内容 |
| "创建 test.txt 写入 hello" | Local Tools | 文件被创建 |
| "打开 google.com" | Browser Tools | 页面被打开 |
| "搜索 YC 公司列表" | Browser + Extract | 返回公司数据 |
| "整理桌面文件" | Local + 分类逻辑 | 文件被移动到分类文件夹 |

---

## 六、版本演进

### 6.1 成熟度模型

| 级别 | 名称 | 标准 |
|------|------|------|
| L1 | Prototype | 核心功能可演示 |
| L2 | Alpha | 端到端流程完整 |
| L3 | Beta | 稳定可日常使用 |
| L4 | Launch | 可交付给用户 |
| L5 | Growth | 用户喜欢并分享 |

### 6.2 当前状态

**L2.5 Alpha+**

- ✅ 架构完成
- ✅ Local Tools 工作
- ❌ Browser Tools 有问题（Session）
- ⚠️ 稳定性待验证

### 6.3 达到 L3 需要

1. [ ] Browser Session 正常初始化
2. [ ] Browser Tools 全部工作
3. [ ] 核心场景 100% 通过
4. [ ] 无内存泄漏
5. [ ] 错误有友好提示

### 6.4 达到 L4 需要

1. [ ] 所有 L3 要求
2. [ ] 用户可零配置安装
3. [ ] 有新手引导
4. [ ] 支持 PDF/Word/Excel
5. [ ] 有项目索引功能

---

## 七、禁止事项

### 7.1 架构禁止

- ❌ 不要把浏览器嵌入 Electron（用 headless Playwright）
- ❌ 不要用 GUI 模拟代替 API 调用
- ❌ 不要在前端做业务逻辑（前端只负责展示）
- ❌ 不要硬编码配置（用配置文件）

### 7.2 代码禁止

- ❌ 不要单文件超过 500 行
- ❌ 不要无类型注解的公开函数
- ❌ 不要无测试的核心模块
- ❌ 不要 catch Exception 不处理

### 7.3 产品禁止

- ❌ 不要为特定场景做特供版
- ❌ 不要技术性错误提示
- ❌ 不要无反馈的长等待
- ❌ 不要假设用户懂技术

---

## 八、附录

### 8.1 文件结构

```
nogicos/
├── client/                 # Electron 客户端
│   ├── main.js            # 主进程
│   └── preload.js         # 预加载脚本
├── nogicos-ui/            # React 前端
│   └── src/
│       ├── components/    # UI 组件
│       └── hooks/         # 自定义 Hooks
├── engine/                # Python 后端核心
│   ├── agent/             # AI Agent
│   │   ├── react_agent.py # ReAct 循环
│   │   ├── classifier.py  # 任务分类
│   │   └── planner.py     # 任务分解
│   ├── tools/             # 工具集
│   │   ├── base.py        # 工具注册
│   │   ├── browser.py     # 浏览器工具
│   │   └── local.py       # 本地工具
│   ├── browser/           # 浏览器管理
│   │   └── session.py     # Session 生命周期
│   └── server/            # 服务器
│       └── websocket.py   # WebSocket
├── tests/                 # 测试
├── hive_server.py         # 入口
└── PRODUCT_SPEC.md        # 本文档
```

### 8.2 快速命令

```bash
# 启动后端
python hive_server.py

# 启动前端（开发）
cd nogicos-ui && npm run dev

# 启动 Electron
cd client && npm start

# 运行测试
pytest tests/test_agent_core.py -v
```

### 8.3 相关文档

- `README.md` - 项目介绍
- `ARCHITECTURE.md` - 架构详解
- `CHANGELOG.md` - 更新日志
- `docs/VISION_2.0.md` - 产品愿景

---

*文档版本: 1.0*
*最后更新: 2024-12-30*
*维护者: Zino + AI*

